<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Regenerate QR Hash - DTC: Magic Chain System</title>
    <!-- [style เหมือนเดิม 100% ตัดทอนในที่นี้เพื่อความกระชับ] -->
    <style>
      /* ... (เหมือนไฟล์ที่คุณแนบมา) ... */
    </style>
</head>
<body>
<h1>DTC: Magic Chain System <br><small>Decentralized Trust Community</small></h1>

<!-- [intro, section-block เหมือนเดิมทั้งหมด] -->

<!-- ...[ตัดทอน HTML input/output section เหมือนเดิม 100%]... -->

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM refs
    const qrTicketContentInput = document.getElementById('qrTicketContent');
    const uploadTicketBtn = document.getElementById('uploadTicket');
    const scanQrTicketBtn = document.getElementById('scanQrTicketBtn');
    const prevHashDisplay = document.getElementById('prevHash');
    const currentSlotIdDisplay = document.getElementById('currentSlotId');
    const originalTimestampDisplay = document.getElementById('originalTimestamp');
    const newSecretDataInput = document.getElementById('newSecretData');
    const issuerPublicKeyInput = document.getElementById('issuerPublicKey');
    const passwordInput = document.getElementById('password');
    const pinInput = document.getElementById('pin');
    const regenerateQrBtn = document.getElementById('regenerateQrBtn');
    const regenOutputSection = document.getElementById('regenOutputSection');
    const regeneratedQrCodeImage = document.getElementById('regeneratedQrCodeImage');
    const regeneratedQrContentDisplay = document.getElementById('regeneratedQrContentDisplay');
    const newHash1Display = document.getElementById('newHash1');
    const newHash2Display = document.getElementById('newHash2');
    const regeneratedTimestampDisplay = document.getElementById('regeneratedTimestamp');

    // Toggle password
    document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const targetId = toggle.dataset.target;
            const targetInput = document.getElementById(targetId);
            if (targetInput.type === 'password') {
                targetInput.type = 'text'; toggle.textContent = 'Hide';
            } else {
                targetInput.type = 'password'; toggle.textContent = 'Show';
            }
        });
    });

    // Parse Ticket JSON to fill prevHash, slotId, timestamp
    qrTicketContentInput.addEventListener('input', () => {
        try {
            const ticketJson = JSON.parse(qrTicketContentInput.value);
            prevHashDisplay.value = ticketJson.hash2 || 'N/A';
            currentSlotIdDisplay.value = ticketJson.meta?.slotId || 'N/A';
            originalTimestampDisplay.value = ticketJson.meta?.timestamp ? new Date(ticketJson.meta.timestamp).toLocaleString() : 'N/A';
            if (!newSecretDataInput.value.trim() && ticketJson.data) {
                newSecretDataInput.value = ticketJson.data;
            }
        } catch (e) {
            prevHashDisplay.value = '';
            currentSlotIdDisplay.value = '';
            originalTimestampDisplay.value = '';
        }
    });

    // Upload Ticket (File)
    uploadTicketBtn.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                qrTicketContentInput.value = e.target.result;
                qrTicketContentInput.dispatchEvent(new Event('input'));
            };
            reader.readAsText(file);
        }
    });

    // Scan QR Ticket (mock)
    scanQrTicketBtn.addEventListener('click', () => {
        alert('Webcam QR scan functionality is not implemented in this mockup. Please paste QR Ticket JSON content manually.');
    });

    // SHA256 Helper (hex)
    async function sha256Hex(str) {
        const buf = new TextEncoder().encode(str);
        const hashBuf = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Regenerate QR Button (DTC Logic)
    regenerateQrBtn.addEventListener('click', async () => {
        const qrTicketContent = qrTicketContentInput.value.trim();
        const newSecretData = newSecretDataInput.value.trim();
        const issuerPublicKey = issuerPublicKeyInput.value.trim();
        const password = passwordInput.value.trim();
        const pin = pinInput.value.trim();

        // Validation
        if (!qrTicketContent) {
            alert('Please paste the original QR Ticket Content.'); return;
        }
        let originalTicketJson;
        try {
            originalTicketJson = JSON.parse(qrTicketContent);
            if (!originalTicketJson.hash2 || !originalTicketJson.issuerPublicKey || !originalTicketJson.data) {
                alert('Invalid QR Ticket Content: Missing required fields (hash2, issuerPublicKey, data).');
                return;
            }
        } catch (e) {
            alert('Invalid QR Ticket Content: Please provide valid JSON.'); return;
        }
        if (!issuerPublicKey || !password || !pin) {
            alert('Please fill in your Public Key, Password, and PIN for signing.'); return;
        }
        if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
            alert('PIN must be 4 digits.'); return;
        }

        // DTC chain meta for regen
        const now = new Date();
        const timestamp = now.toISOString();
        const newNonce = Math.random().toString(36).substring(2, 10);

        // prevHash2 = hash2 of previous (QR chain linkage)
        const prevHash2 = originalTicketJson.hash2;
        const originalBatchName = originalTicketJson.meta?.batchName || 'N/A';
        const originalQuantity = originalTicketJson.meta?.quantity || 1;
        const originalSlotId = originalTicketJson.meta?.slotId || 'N/A';
        const finalData = newSecretData.trim() === '' ? originalTicketJson.data : newSecretData;

        // 1. New Hash1: SHA256(issuerPublicKey|finalData|batchName|quantity|timestamp|slotId|nonce|prevHash2)
        const hash1_input = issuerPublicKey + '|' + finalData + '|' + originalBatchName + '|' + originalQuantity + '|' + timestamp + '|' + originalSlotId + '|' + newNonce + '|' + prevHash2;
        const newHash1 = await sha256Hex(hash1_input);

        // 2. New Hash2: SHA256(newHash1|timestamp|nonce|prevHash2)
        const newHash2 = await sha256Hex(newHash1 + '|' + timestamp + '|' + newNonce + '|' + prevHash2);

        // 3. Regen QR Content
        const regeneratedQrContentJson = {
            version: "DTC_0.7.6.1",
            type: "QR_Regenerate",
            issuerPublicKey: issuerPublicKey,
            data: finalData,
            meta: {
                batchName: originalBatchName,
                quantity: originalQuantity,
                timestamp: timestamp,
                slotId: originalSlotId,
                nonce: newNonce,
                prev_hash: prevHash2
            },
            hash1: newHash1,
            hash2: newHash2,
            originalIssuerPublicKey: originalTicketJson.issuerPublicKey,
            signature: "0xMOCK_REGEN_SIGNATURE"
        };

        regenOutputSection.style.display = 'flex';
        regeneratedQrCodeImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(JSON.stringify(regeneratedQrContentJson))}`;
        regeneratedQrContentDisplay.textContent = JSON.stringify(regeneratedQrContentJson, null, 2);
        newHash1Display.textContent = newHash1;
        newHash2Display.textContent = newHash2;
        regeneratedTimestampDisplay.textContent = new Date(timestamp).toLocaleString();
    });

    // Export Buttons (เหมือนเดิม)
    document.getElementById('exportNewTicketBtn').addEventListener('click', () => {
        const qrContent = regeneratedQrContentDisplay.textContent;
        if (!qrContent) return;
        const filename = `DTC_RegenTicket_${new Date().getTime()}.json`;
        const blob = new Blob([qrContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
    document.getElementById('exportNewQrBtn').addEventListener('click', () => {
        const qrContent = regeneratedQrCodeImage.src;
        if (!qrContent || qrContent.includes('data:image/gif')) return;
        const filename = `DTC_RegenQR_${new Date().getTime()}.png`;
        const a = document.createElement('a'); a.href = qrContent; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
    document.getElementById('exportRegenLogBtn').addEventListener('click', () => {
        const logData = {
            originalTicketContent: qrTicketContentInput.value,
            newSecretData: newSecretDataInput.value,
            issuerPublicKey: issuerPublicKeyInput.value,
            newHash1: newHash1Display.textContent,
            newHash2: newHash2Display.textContent,
            regeneratedAt: regeneratedTimestampDisplay.textContent
        };
        if (!logData.newHash2) return;
        const filename = `DTC_RegenLog_${new Date().getTime()}.json`;
        const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
});
</script>
</body>
</html>
