<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Register QR</title>
</head>
<body>
  <h2>3. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô QR</h2>
  <label>
    Public Key:<br/>
    <textarea id="pub-key-input" rows="2" cols="70" placeholder="Public Key ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"></textarea>
  </label>
  <br/><br/>
  <label>
    QR Hash:<br/>
    <textarea id="qr-hash-input" rows="2" cols="70" placeholder="QR Hash ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"></textarea>
  </label>
  <br/><br/>
  <label>
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ (optional):<br/>
    <input id="owner-name" type="text" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" />
  </label>
  <br/><br/>
  <button id="reg-btn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  <p id="status-msg"></p>

  <script>
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Public Key + QR Hash ‡∏à‡∏≤‡∏Å localStorage ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°
    window.addEventListener('DOMContentLoaded', () => {
      const savedPub = localStorage.getItem('dtc_publicKey');
      const savedQr  = localStorage.getItem('dtc_qrHash');
      if (savedPub) {
        document.getElementById('pub-key-input').value = savedPub;
      }
      if (savedQr) {
        document.getElementById('qr-hash-input').value = savedQr;
      }
    });

    document.getElementById('reg-btn').addEventListener('click', async () => {
      const pub       = document.getElementById('pub-key-input').value.trim();
      const qr        = document.getElementById('qr-hash-input').value.trim();
      const ownerName = document.getElementById('owner-name').value.trim();

      if (!pub || !qr) {
        document.getElementById('status-msg').textContent = 'üìõ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Public Key ‡πÅ‡∏•‡∏∞ QR Hash ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';
        return;
      }

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
      const payload = { publicKey: pub, qrHash: qr };
      if (ownerName) payload.ownerName = ownerName;

      try {
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ API endpoint ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ /api/register
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (response.ok) {
          document.getElementById('status-msg').textContent = '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!';
          // ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏•‡∏ö qrHash ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
          // localStorage.removeItem('dtc_qrHash');
        } else {
          document.getElementById('status-msg').textContent =
            `‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error || response.statusText}`;
        }
      } catch (err) {
        document.getElementById('status-msg').textContent =
          `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`;
      }
    });
  </script>
</body>
</html>
