<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transfer QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f6fafb;
      color: #232a3e;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 410px;
      margin: 2em auto 0 auto;
      padding: 2em 1em 1.4em 1em;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px #22c55e25;
      position: relative;
    }
    .back-btn {
      position: absolute;
      top: 18px; left: 12px;
      background: #e0e7ef; color: #363f5c;
      border: 1px solid #cdd2df; border-radius: 7px;
      font-size: 1em; padding: 0.34em 1.1em; cursor: pointer;
      z-index: 1000; box-shadow: 0 2px 8px #22c55e13;
      font-weight: 500; transition: background 0.2s;
    }
    .back-btn:hover { background: #c7f7fa; color: #232a3e;}
    h2 {
      text-align: center; color: #22c55e; font-size: 1.23em;
      margin-bottom: 1.6em; letter-spacing: 0.01em; margin-top: 0.5em;
    }
    .row {
      display: flex; align-items: center;
      background: #e7fbe8; border-radius: 8px;
      border: 1.4px solid #22c55e;
      margin-bottom: 1em; padding: 0.38em 0.58em 0.38em 0.7em;
      gap: 0.22em;
    }
    .row input[type="text"] {
      flex: 1 1 0;
      font-size: 1em; padding: 0.56em 0.6em;
      border: none; background: transparent;
      color: #166534; font-weight: 500;
      outline: none;
    }
    .row input[type="text"]:focus { background: #d1fadf;}
    .icon-btn {
      background: none; border: none; margin: 0 0 0 0.1em; padding: 0;
      cursor: pointer; display: flex; align-items: center;
    }
    .icon-btn img { width: 26px; height: 26px; }
    .receiver-group {
      margin-bottom: 1.3em;
    }
    .receiver-group label {
      font-size: 0.98em; color: #15803d; font-weight: bold; display: block;
      margin-bottom: 0.18em; margin-left: 0.04em;
    }
    .input-green {
      width: 100%; font-size: 1em; padding: 0.6em 0.6em;
      border-radius: 8px; border: 1.3px solid #22c55e;
      background: #e7fbe8; color: #166534; margin-bottom: 1em;
      font-weight: 500; transition: border-color 0.13s;
    }
    .input-green:focus { border-color: #16a34a;}
    .auth-section {
      background: #e0f2fe;
      border-radius: 10px;
      border: 1.2px solid #38bdf8;
      padding: 1.1em 0.95em 0.5em 0.95em;
      margin-top: 1.15em;
      margin-bottom: 0.6em;
    }
    .auth-section label {
      font-size: 0.96em; color: #2563eb; font-weight: 500; margin-bottom: 0.22em; display: block;
    }
    .input-blue {
      width: 100%; font-size: 1em; padding: 0.54em 0.62em;
      border-radius: 8px; border: 1.1px solid #38bdf8;
      background: #e0f2fe; color: #1e293b; margin-bottom: 0.72em;
      font-weight: 500; transition: border-color 0.13s;
    }
    .input-blue:focus { border-color: #2563eb;}
    .btn-main {
      width: 100%; background: linear-gradient(90deg, #22c55e 60%, #16a34a 100%);
      color: #fff; border: none; border-radius: 9px;
      font-weight: bold; font-size: 1.11em; padding: 0.72em 0;
      margin-top: 1.3em; margin-bottom: 0.6em; cursor: pointer;
      box-shadow: 0 1.5px 8px #22c55e13; transition: background 0.16s;
    }
    .btn-main:active { background: linear-gradient(90deg, #16a34a 60%, #22c55e 100%);}
    #qr-reader { display:none; width:250px; margin: 1em auto; }
    .input-err { color: #b91c1c; font-size: 0.97em; margin-bottom: 0.5em;}
    pre { text-align:left; background:#f3f6fa; padding:0.7em 1.2em; border-radius:8px; color:#166534;}
    @media (max-width: 520px) {
      .container { padding: 1em 0.18em 1em 0.18em; }
      .back-btn { left: 4px; top: 4px; font-size: 0.95em; padding: 0.2em 0.82em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="history.back()">← Back</button>
    <h2>Transfer QR</h2>

    <div class="row">
      <input type="text" id="qrhash" maxlength="64" autocomplete="off" placeholder="Enter QR Hash" />
      <button class="icon-btn" title="Scan QR" onclick="openQRScanner()">
        <img src="/mnt/data/file-L18xSxFu29P7XrcKg9bNSw" alt="Scan QR"/>
      </button>
      <input type="file" accept="image/*" style="display:none;" id="imgQRInput" onchange="scanImageQR(this)">
      <button class="icon-btn" title="Import QR Image" onclick="document.getElementById('imgQRInput').click()">
        <img src="/mnt/data/file-A7cyCpJAxSc3ji46qY5mrW" alt="Gallery"/>
      </button>
    </div>

    <div class="receiver-group">
      <label for="recipientpk">Receiver Public Key (42 chars, 0x...):</label>
      <input class="input-green" type="text" id="recipientpk" maxlength="42" autocomplete="off" placeholder="Enter recipient's public key" />
      <div class="input-err" id="pubkeyErr"></div>
    </div>

    <div class="auth-section">
      <label for="passphrase">Your Passphrase (6-12 letters & numbers):</label>
      <input class="input-blue" type="password" id="passphrase" maxlength="12" minlength="6" autocomplete="off" placeholder="Enter your passphrase" />

      <label for="signcode">4-digit Sign Code:</label>
      <input class="input-blue" type="password" id="signcode" maxlength="4" minlength="4" autocomplete="off" pattern="\d{4}" placeholder="Enter sign code (numbers only)" />
    </div>

    <button class="btn-main" onclick="preview()" type="button">Preview</button>
    <div id="previewBox" style="margin-top:0.3em;text-align:center;color:#15803d;"></div>
    <button class="btn-main" onclick="confirmTransfer()" type="button" style="display:none;" id="confirmBtn">Confirm Transfer</button>

    <div id="qr-reader"></div>
  </div>
  <script>
    let qrReader = null;
    function openQRScanner() {
      const qrDiv = document.getElementById('qr-reader');
      qrDiv.style.display = 'block';
      if (!qrReader) qrReader = new Html5Qrcode("qr-reader");
      qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 180 },
        qrCodeMessage => {
          document.getElementById('qrhash').value = qrCodeMessage;
          qrReader.stop();
          qrDiv.style.display = 'none';
        }
      ).catch(err => {
        alert("Cannot open camera: " + err);
        qrDiv.style.display = 'none';
      });
    }
    function scanImageQR(input) {
      if (input.files && input.files.length > 0) {
        const file = input.files[0];
        const qrDiv = document.getElementById('qr-reader');
        qrDiv.style.display = 'block';
        if (!qrReader) qrReader = new Html5Qrcode("qr-reader");
        qrReader.scanFile(file, true)
          .then(qrCodeMessage => {
            document.getElementById('qrhash').value = qrCodeMessage;
            qrReader.clear();
            qrDiv.style.display = 'none';
          })
          .catch(() => {
            alert("ไม่พบ QR ในภาพนี้");
            qrDiv.style.display = 'none';
          });
      }
    }
    function validatePubkey(pk) {
      // 42 chars, start with 0x, 40 hex chars after
      return /^0x[a-fA-F0-9]{40}$/.test(pk);
    }
    function validateInputs() {
      const hash = document.getElementById('qrhash').value.trim();
      const pub = document.getElementById('recipientpk').value.trim();
      const pass = document.getElementById('passphrase').value.trim();
      const sign = document.getElementById('signcode').value.trim();
      let valid = true;
      document.getElementById('pubkeyErr').textContent = "";
      if (hash.length !== 64) valid = false;
      if (!validatePubkey(pub)) {
        valid = false;
        if (pub) document.getElementById('pubkeyErr').textContent = "Public Key ต้องขึ้นต้น 0x และยาว 42 ตัวอักษร";
      }
      if (pass.length < 6 || pass.length > 12 || !/[A-Za-z]/.test(pass) || !/\d/.test(pass)) valid = false;
      if (!/^\d{4}$/.test(sign)) valid = false;
      return valid;
    }
    function preview() {
      const isValid = validateInputs();
      const previewBox = document.getElementById('previewBox');
      const confirmBtn = document.getElementById('confirmBtn');
      if (!isValid) {
        previewBox.textContent = "⚠️ Please complete all fields correctly.";
        confirmBtn.style.display = "none";
        return;
      }
      const hash = document.getElementById('qrhash').value.trim();
      const pub = document.getElementById('recipientpk').value.trim();
      const pass = document.getElementById('passphrase').value.trim();
      const sign = document.getElementById('signcode').value.trim();

      // สร้าง signature mock (ใช้ sha256 แทน, สำหรับ demo/PoC)
      function sha256(str) {
        // สำหรับ PoC เท่านั้น
        return Array.from(new Uint8Array(
          window.crypto.subtle.digestSync ?
            window.crypto.subtle.digestSync("SHA-256", new TextEncoder().encode(str)) :
            [] // digestSync ใช้ได้บน Chrome บางเวอร์ชัน
        )).map(b => b.toString(16).padStart(2, '0')).join('');
      }
      // fallback async
      function sha256Async(str) {
        return window.crypto.subtle.digest("SHA-256", new TextEncoder().encode(str))
          .then(buf => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''));
      }
      // สำหรับความปลอดภัยจริง ต้องใช้ signature ด้วย private key (ed25519/ECDSA)

      // แสดง preview payload
      previewBox.innerHTML =
        `<b>Preview Transfer</b><br>
        <b>QR Hash:</b> <code>${hash}</code><br>
        <b>Receiver Public Key:</b> <code>${pub}</code><br>
        <b>Sign Message:</b><br>
        <pre>{
  "qr_hash": "${hash}",
  "to_pubkey": "${pub}",
  "signed_by": "(this_user_pubkey)",
  "sig": "(private_sign)",
  "timestamp": "${new Date().toISOString()}"
}</pre>
        <small style="color:#666;">(กรณี production ต้อง sign จริงด้วย private key แล้ว verify ย้อนกลับได้)</small>`;
      confirmBtn.style.display = "block";
    }
    function confirmTransfer() {
      alert('✅ Transfer submitted! (เพิ่ม backend logic ได้ที่นี่)');
      document.getElementById('previewBox').textContent = "";
      document.getElementById('confirmBtn').style.display = "none";
    }
  </script>
</body>
</html>
