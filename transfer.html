<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transfer QR (with Passphrase & Sign Code)</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 2em auto; }
    h2 { margin-top: 1em; text-align: center; }
    label { margin: 1em 0 0.5em; display: block; }
    input, button { width: 100%; padding: 0.7em; margin-bottom: 0.7em; border-radius: 5px; border: 1px solid #ccc; font-size: 1em;}
    .input-status { font-size: 0.95em; margin-bottom: 0.6em;}
    .valid { color: green; }
    .invalid { color: red; }
    #successMsg {
      background: #e8f5e9; color: #2e7d32; border-left: 5px solid #66bb6a; border-radius: 5px;
      margin-top: 1em; padding: 1em;
    }
    #previewBox { background: #f8f8f8; border-radius: 5px; margin-top: 1em; padding: 1em; }
    button { background: #2563eb; color: #fff; font-weight: bold; border: none; cursor: pointer; margin-top: 0.2em;}
    button:disabled { background: #ccc; color: #999; cursor: not-allowed;}
    .back-btn { position: fixed; top: 16px; left: 16px; width: auto; background: #eee; color: #222; border: 1px solid #aaa; z-index: 100;}
    .back-btn:hover { background: #ffd; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">‚Üê Back</button>
  <h2>Transfer QR</h2>
  <form id="transferForm" autocomplete="off">
    <label>QR Hash (64 chars):</label>
    <input type="text" id="qrHash" maxlength="64" placeholder="Enter QR Hash" />
    <span id="qrStatus" class="input-status"></span>
    
    <label>Recipient Public Key (40 chars):</label>
    <input type="text" id="recipientKey" maxlength="40" placeholder="Enter recipient's public key" />
    <span id="recipientStatus" class="input-status"></span>
    
    <label>Your Passphrase (6-12 letters & numbers):</label>
    <input type="password" id="passphrase" minlength="6" maxlength="12" placeholder="Enter your passphrase" autocomplete="off" />
    <span id="passStatus" class="input-status"></span>

    <label>4-digit Sign Code:</label>
    <input type="password" id="signCode" maxlength="4" pattern="\d{4}" placeholder="Enter sign code (numbers only)" autocomplete="off" />
    <span id="signStatus" class="input-status"></span>
    
    <button type="button" id="previewBtn" onclick="preview()" disabled>Preview</button>
    <div id="previewBox"></div>

    <button type="submit" id="confirmBtn" disabled>Confirm Transfer</button>
    <div id="successMsg" style="display:none;"></div>
  </form>

  <script>
    const qrHash = document.getElementById('qrHash');
    const recipientKey = document.getElementById('recipientKey');
    const passphrase = document.getElementById('passphrase');
    const signCode = document.getElementById('signCode');
    const qrStatus = document.getElementById('qrStatus');
    const recipientStatus = document.getElementById('recipientStatus');
    const passStatus = document.getElementById('passStatus');
    const signStatus = document.getElementById('signStatus');
    const previewBtn = document.getElementById('previewBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const previewBox = document.getElementById('previewBox');
    const successMsg = document.getElementById('successMsg');

    function validateInputs() {
      let valid = true;
      // QR Hash
      if (qrHash.value.trim().length === 64) {
        qrStatus.textContent = "‚úì Length OK";
        qrStatus.className = "input-status valid";
      } else {
        qrStatus.textContent = "‚ö† Must be 64 characters";
        qrStatus.className = "input-status invalid";
        valid = false;
      }
      // Recipient
      if (recipientKey.value.trim().length === 40) {
        recipientStatus.textContent = "‚úì Length OK";
        recipientStatus.className = "input-status valid";
      } else {
        recipientStatus.textContent = "‚ö† Must be 40 characters";
        recipientStatus.className = "input-status invalid";
        valid = false;
      }
      // Passphrase
      const pw = passphrase.value;
      const rePW = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,12}$/;
      if (rePW.test(pw)) {
        passStatus.textContent = "‚úì Valid";
        passStatus.className = "input-status valid";
      } else {
        passStatus.textContent = "‚ö† 6-12 characters, must include both letters and numbers";
        passStatus.className = "input-status invalid";
        valid = false;
      }
      // Sign Code
      if (/^\d{4}$/.test(signCode.value)) {
        signStatus.textContent = "‚úì Valid";
        signStatus.className = "input-status valid";
      } else {
        signStatus.textContent = "‚ö† Must be 4 digits (numbers only)";
        signStatus.className = "input-status invalid";
        valid = false;
      }
      previewBtn.disabled = !valid;
      return valid;
    }

    qrHash.oninput = recipientKey.oninput = passphrase.oninput = signCode.oninput = validateInputs;

    function sha256Hex(str) {
      // Simple JS SHA256 (browser, only for demo)
      return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str)).then(b =>
        [...new Uint8Array(b)].map(x => x.toString(16).padStart(2, '0')).join('')
      );
    }

    async function preview() {
      if (!validateInputs()) return;
      const senderHash = await sha256Hex(passphrase.value);
      const senderAddress = '0x' + senderHash.slice(-40);
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á signature ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ passphrase + signcode + qrhash + recipient
      const txRaw = passphrase.value + signCode.value + qrHash.value.trim() + recipientKey.value.trim();
      const signature = await sha256Hex(txRaw);
      previewBox.innerHTML =
        `<b>Please confirm your transaction:</b><br><br>` +
        `QR Hash: <code>${qrHash.value.trim()}</code><br>` +
        `Recipient Key: <code>${recipientKey.value.trim()}</code><br>` +
        `Your Address: <code>${senderAddress}</code><br>` +
        `Sign Code: <code>${signCode.value}</code><br>` +
        `Signature: <code>${signature}</code><br>`;
      confirmBtn.disabled = false;
      successMsg.style.display = "none";
    }

    document.getElementById('transferForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!validateInputs()) return;
      // popup confirm
      if (!window.confirm("Are you sure you want to confirm this QR transfer?")) return;
      const senderHash = await sha256Hex(passphrase.value);
      const senderAddress = '0x' + senderHash.slice(-40);
      const signature = await sha256Hex(passphrase.value + signCode.value + qrHash.value.trim() + recipientKey.value.trim());
      successMsg.innerHTML = `
        üéâ <b>Transfer successful!</b><br>
        Your transaction has been recorded.<br><br>
        üõ°Ô∏è QR Hash: <code>${qrHash.value.trim()}</code><br>
        üë§ Your Address: <code>${senderAddress}</code><br>
        üë• Recipient Key: <code>${recipientKey.value.trim()}</code><br>
        üîê Signature: <code>${signature}</code>
      `;
      successMsg.style.display = "block";
      previewBox.innerHTML = "";
      confirmBtn.disabled = true;
      // (TODO: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ backend ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö log)
    };
  </script>
</body>
</html>
