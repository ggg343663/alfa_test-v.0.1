<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Request Master (DTC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <style>
    /* ... ‡πÉ‡∏ä‡πâ style ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì ... */
    .copy-success {
      display: inline-block;
      color: #1aa34a;
      font-weight: bold;
      margin-left: 0.45em;
      opacity: 0;
      transition: opacity 0.5s;
      font-size: 0.98em;
    }
    .copy-success.show { opacity: 1; }
    .paste-btn {
      background: #f3f5fd;
      border: 1px solid #c5d4ef;
      color: #296fc6;
      padding: 0.16em 0.66em;
      border-radius: 6px;
      font-size: 0.93em;
      margin-left: 0.2em;
      cursor:pointer;
      transition: background 0.13s;
    }
    .paste-btn:hover { background: #ffe066; color: #5c4700;}
    .pubkey-count { font-size: 0.92em; color: #c77700; margin-left: 0.7em;}
    .badword-err-disabled { opacity: 0.9; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="history.back()">‚Üê Back</button>
    <h2>Request Master</h2>

    <div id="badwordWarn" class="form-warn" style="display:none;"></div>

    <form id="requestMasterForm" autocomplete="off">
      <label>Master Name (A-Z only): 
        <input type="text" id="masterName" maxlength="8" pattern="[A-Z]+" required autocomplete="off">
      </label>
      <label>Confirm Master Name: 
        <input type="text" id="confirmName" maxlength="8" pattern="[A-Z]+" required autocomplete="off">
      </label>
      <div id="nameMatchWarn" class="msg-warn" style="display:none;"></div>
      <label>
        Public Key (42 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£): 
        <input type="text" id="pubkey" pattern="^0x[a-fA-F0-9]{40}$" maxlength="42" required autocomplete="off" />
        <button type="button" class="paste-btn" onclick="pastePubkey('pubkey')">Paste</button>
        <button type="button" class="copy-btn" onclick="copyField('pubkey')" title="Copy"><svg width="17" height="17" viewBox="0 0 24 24"><path fill="#888" d="M19,21H8A2,2 0 0,1 6,19V7H8V19H19"/><path fill="#888" d="M16,1H4A2,2 0 0,0 2,3V17A2,2 0 0,0 4,19H16A2,2 0 0,0 18,17V3A2,2 0 0,0 16,1Z"/></svg></button>
        <span class="pubkey-count" id="pubkeyCount">0/42</span>
        <span class="copy-success" id="copySuccess"></span>
      </label>
      <label>
        Confirm Public Key:
        <input type="text" id="confirmPubkey" pattern="^0x[a-fA-F0-9]{40}$" maxlength="42" required autocomplete="off" />
        <button type="button" class="paste-btn" onclick="pastePubkey('confirmPubkey')">Paste</button>
        <button type="button" class="copy-btn" onclick="copyField('confirmPubkey')" title="Copy"><svg width="17" height="17" viewBox="0 0 24 24"><path fill="#888" d="M19,21H8A2,2 0 0,1 6,19V7H8V19H19"/><path fill="#888" d="M16,1H4A2,2 0 0,0 2,3V17A2,2 0 0,0 4,19H16A2,2 0 0,0 18,17V3A2,2 0 0,0 16,1Z"/></svg></button>
        <span class="pubkey-count" id="confirmPubkeyCount">0/42</span>
      </label>
      <small>üìå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á Public Key ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</small>
      <button type="submit">Request Master</button>
    </form>

    <!-- Hash + Copy UI -->
    <div id="hashBox" style="display:none;">
      <div class="hash-row">
        <input type="text" id="qrHashInput" value="" readonly style="width:72%;">
        <span class="hash-status ready">QR hash ready</span>
        <button class="copy-btn" onclick="copyHash()" title="Copy to clipboard">
          <svg width="22" height="22" viewBox="0 0 24 24">
            <path fill="#24c48b" d="M19,21H8A2,2 0 0,1 6,19V7H8V19H19" />
            <path fill="#24c48b" d="M16,1H4A2,2 0 0,0 2,3V17A2,2 0 0,0 4,19H16A2,2 0 0,0 18,17V3A2,2 0 0,0 16,1Z" />
          </svg>
        </button>
        <span class="copy-success" id="copyHashSuccess"></span>
      </div>
      <pre id="hashResult"></pre>
    </div>
  </div>

  <!-- Popup warn -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup-content">
      <button class="close-popup" onclick="hidePopup()">‚úñ</button>
      <div id="popupMsg"></div>
    </div>
  </div>

<script>
  // ========== Badword Loader & Check ==========
  let badwordList = {};
  let hasBadword = false;
  let badwordLoaded = false;
  let badwordError = false;
  fetch('badwords.json')
    .then(res => res.json())
    .then(data => {badwordList = data; badwordLoaded = true;})
    .catch(() => {
      badwordError = true;
      showBadwordWarn('<span class="badword-err-disabled">‚ö† ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î badword list ‡πÑ‡∏î‡πâ<br>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</span>');
    });

  function showBadwordWarn(msg) {
    const warn = document.getElementById('badwordWarn');
    warn.style.display = 'block';
    warn.innerHTML = msg;
  }
  function hideBadwordWarn() {
    document.getElementById('badwordWarn').style.display = 'none';
  }
  // ‡∏ï‡∏£‡∏ß‡∏à badword ‡πÅ‡∏ö‡∏ö "‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥" (exact word) ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ä‡πà‡∏ô class ‡∏´‡∏£‡∏∑‡∏≠ pass
  function checkBadwords(inputValue) {
    const input = inputValue.toLowerCase();
    let found = [];
    for (const group of Object.values(badwordList)) {
      group.forEach(word => {
        const re = new RegExp("\\b"+word+"\\b", "i"); // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥
        if (re.test(input)) found.push(word);
      });
    }
    if (found.length > 0) {
      showBadwordWarn(`‚ö† <span style="color:red; font-weight:bold;">Badword:</span> ${found.join(', ')}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á`);
      hasBadword = true;
    } else {
      hideBadwordWarn();
      hasBadword = false;
    }
  }

  // ========== Name, Pubkey Logic ==========
  function toUpperNoOther(str) { return str.toUpperCase().replace(/[^A-Z]/g, ''); }
  document.getElementById('masterName').addEventListener('input', function () {
    this.value = toUpperNoOther(this.value);
    if(badwordLoaded) checkBadwords(this.value);
    checkNameMatch();
  });
  document.getElementById('confirmName').addEventListener('input', function () {
    this.value = toUpperNoOther(this.value);
    checkNameMatch();
  });

  function checkNameMatch() {
    const name = document.getElementById('masterName').value.trim();
    const confirm = document.getElementById('confirmName').value.trim();
    const warn = document.getElementById('nameMatchWarn');
    if (name && confirm && name !== confirm) {
      warn.innerText = '‚ö† Master Name ‡πÅ‡∏•‡∏∞ Confirm Master Name ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô!';
      warn.style.display = 'block';
      document.getElementById('confirmName').classList.add('input-error');
    } else {
      warn.innerText = '';
      warn.style.display = 'none';
      document.getElementById('confirmName').classList.remove('input-error');
    }
  }

  // Auto focus, Enter = Next, count pubkey
  window.onload = function(){
    document.getElementById('masterName').focus();
  };
  document.getElementById('pubkey').addEventListener('input', function () {
    document.getElementById('pubkeyCount').innerText = this.value.length + "/42";
  });
  document.getElementById('confirmPubkey').addEventListener('input', function () {
    document.getElementById('confirmPubkeyCount').innerText = this.value.length + "/42";
  });
  // Enter ‡∏Å‡∏î‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á
  const jump = (id, nextId) => document.getElementById(id).addEventListener('keydown', function(e){
    if(e.key==='Enter') {
      e.preventDefault();
      document.getElementById(nextId).focus();
    }
  });
  jump('masterName','confirmName');
  jump('confirmName','pubkey');
  jump('pubkey','confirmPubkey');
  jump('confirmPubkey','requestMasterForm'); // Enter ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ = submit

  // Copy/Paste fields
  function copyField(id) {
    const el = document.getElementById(id);
    el.select(); el.setSelectionRange(0, 9999);
    navigator.clipboard.writeText(el.value);
    showCopySuccess();
  }
  function showCopySuccess() {
    const el = document.getElementById('copySuccess');
    el.innerText = "Copied!";
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),1100);
  }
  async function pastePubkey(id) {
    try {
      const text = await navigator.clipboard.readText();
      if (/^0x[a-fA-F0-9]{0,40}$/.test(text)) {
        document.getElementById(id).value = text.substring(0,42);
        document.getElementById(id+'Count').innerText = document.getElementById(id).value.length + "/42";
      }
    } catch {}
  }

  // ========== Form Submit ==========
  document.getElementById('requestMasterForm').onsubmit = function (e) {
    e.preventDefault();
    const name = document.getElementById('masterName').value.trim();
    const confirm = document.getElementById('confirmName').value.trim();
    const pubkey = document.getElementById('pubkey').value.trim();
    const confirmPubkey = document.getElementById('confirmPubkey').value.trim();
    if (name !== confirm) {
      showPopup('‚ö† Master Name ‡πÅ‡∏•‡∏∞ Confirm Master Name ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
      document.getElementById('confirmName').focus();
      return;
    }
    if (pubkey !== confirmPubkey) {
      showPopup('‚ö† Public Key ‡πÅ‡∏•‡∏∞ Confirm Public Key ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
      document.getElementById('confirmPubkey').focus();
      return;
    }
    if (hasBadword) {
      if (!confirm('‚ö† ‡∏ä‡∏∑‡πà‡∏≠ Master ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        document.getElementById('masterName').focus();
        return;
      }
    }
    if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n\n(Confirm to proceed: All information will be public.)")) {
      return;
    }
    const timestamp = new Date().toISOString();
    const nonce = Array.from(crypto.getRandomValues(new Uint8Array(8))).map(b => b.toString(16).padStart(2, "0")).join('');
    const s = name + pubkey + timestamp + nonce;
    const hash = sha256(s);

    // Show QR hash ready + copy button + full log
    document.getElementById('hashBox').style.display = "block";
    document.getElementById('qrHashInput').value = hash;
    document.getElementById('hashResult').innerText = `
üìå Copy & send to Genesis/Admin or keep for your log

Request Hash: ${hash}
Master Name : ${name}
Public Key  : ${pubkey}
Timestamp   : ${timestamp}
Nonce       : ${nonce}
    `.trim();
    setTimeout(()=>{document.getElementById('hashBox').scrollIntoView({behavior:'smooth'});},120);
  };

  function copyHash() {
    const input = document.getElementById('qrHashInput');
    input.select();
    input.setSelectionRange(0, 99999); // mobile
    navigator.clipboard.writeText(input.value);
    showCopyHashSuccess();
  }
  function showCopyHashSuccess() {
    const el = document.getElementById('copyHashSuccess');
    el.innerText = "Copied!";
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),1200);
  }

  // ===== Popup (use as is) =====
  function showPopup(msg) {
    document.getElementById('popupMsg').innerHTML = msg;
    document.getElementById('popupOverlay').style.display = 'flex';
    setTimeout(()=>document.getElementById('popupOverlay').scrollIntoView({behavior:'smooth'}),160);
  }
  function hidePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
  }
</script>
</body>
</html>
