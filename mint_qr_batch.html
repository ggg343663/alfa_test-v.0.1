<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mint QR Batch – DTC v.0.7.5.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background: #f5f7fa; }
    .container { max-width: 470px; margin: 2em auto; background: #fff; border-radius: 15px; box-shadow: 0 2px 16px #90caf933; padding: 2.1em 1.1em 2em 1.1em;}
    h2 { color: #219150; text-align: center; margin-bottom: 1.3em;}
    .input-label { color: #26733e; font-weight: bold; margin-bottom: 0.19em;}
    .input-hint { color: #90a4ae; font-size: 0.95em; margin: 0.07em 0 0.14em 0;}
    input { width: 100%; min-height: 38px; max-height: 44px; font-size: 1.07em; border-radius: 8px; border: 1.3px solid #cfd8dc; padding: 0.7em 1em; background: #fafdff; margin-bottom: 0.57em; box-sizing: border-box;}
    input:focus { border-color: #2196f3; background: #fff;}
    .row-flex { display: flex; gap: 0.5em;}
    .row-flex .col { flex: 1;}
    .btn-main, .btn-export, .btn-action, .btn-nav { font-size: 1.09em; border-radius: 8px; border: none; font-weight: bold; min-height: 44px; margin-top: 0.62em; padding: 0.77em 0; cursor: pointer; transition: background .15s, color .15s;}
    .btn-main { background: #2196f3; color: #fff;}
    .btn-main:active { background: #176d38;}
    .btn-export { background: #ffd600; color: #222;}
    .btn-export:active { background: #ffb300;}
    .btn-action { background: #b8cafe; color: #173472;}
    .btn-action:active { background: #97b6ed;}
    .qr-preview-section { display: flex; gap: 1em; margin: 1.2em 0 1.1em 0;}
    .qr-box { background: #eaf2fa; border-radius: 13px; padding: 0.7em 1em; border-left: 5px solid #219150; min-width: 110px; text-align: center;}
    .qr-box canvas { margin-bottom: .5em; }
    .info-box { background: #f7f7fb; border-radius: 11px; padding: 1em 1.1em; border-left: 5px solid #246bfd; font-size: 1.01em; color: #234; min-width: 120px;}
    .scroll-box { max-height: 110px; overflow: auto; font-size: 0.98em; background: #fafdff; border-radius: 8px; padding: 0.7em;}
    .export-btns { display: flex; gap: 0.7em; margin-top: 1.1em;}
    .nav-btns { display: flex; gap: 0.7em; margin-top: 2.1em;}
    .btn-nav { flex: 1; background: #ede7f6; color: #512da8;}
    .btn-nav:active { background: #b39ddb;}
    .captcha-row { display: flex; align-items: center; gap: 0.5em;}
    .captcha-label { color: #246bfd; font-weight: bold; }
    .captcha-refresh { background: #b8cafe; color: #173472; border-radius: 6px; border:none; font-size: 1.09em; padding: 0.15em 0.75em; margin-left: 0.3em; cursor: pointer;}
    .captcha-refresh:active { background: #97b6ed;}
    .captcha-error { color: #e74c3c; font-size: 0.98em; margin-left: 0.7em;}
    @media (max-width: 600px) {
      .container { padding: 1em 0.12em 1.2em 0.12em; }
      .qr-preview-section { flex-direction: column; gap: .9em;}
      .info-box, .qr-box { min-width: 0; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Mint QR Batch (Double Hash UI)</h2>
  <!-- Mint QR Form -->
  <form id="mintForm" autocomplete="off">
    <div class="input-label">Password</div>
    <input id="password" type="password" maxlength="16" required>
    <div class="input-hint">6-16 characters, for regen &amp; commit</div>
    <div class="input-label">PIN</div>
    <input id="pin" type="password" maxlength="8" required>
    <div class="input-hint">4-8 digits</div>
    <div class="input-label">Secret</div>
    <input id="secret" type="text" maxlength="64" required>
    <div class="input-hint">For secure minting (don't lose!)</div>
    <div class="input-label">Confirm Secret</div>
    <input id="confirmSecret" type="text" maxlength="64" required>
    <div class="input-hint">Type your secret again</div>
    <div class="input-label">Batch Name (optional)</div>
    <input id="batchName" type="text" maxlength="32">
    <div class="row-flex" style="align-items:center;">
      <div class="col">
        <div class="input-label" style="margin-bottom:0;">Number of QR</div>
        <input id="qrAmount" type="number" value="10" min="1" max="200" style="width:110px;">
      </div>
      <button type="button" class="btn-action" id="plusBtn" style="margin-top:0;">+</button>
      <button type="button" class="btn-action" id="minusBtn" style="margin-top:0;">–</button>
    </div>
    <!-- Captcha Section -->
    <div class="input-label" style="margin-top:0.8em;">Captcha</div>
    <div class="captcha-row">
      <span id="captchaQ" class="captcha-label"></span>
      <input id="captcha" type="text" maxlength="6" autocomplete="off" style="width:120px;">
      <button type="button" class="captcha-refresh" id="refreshCaptcha" title="Refresh captcha">↻</button>
      <span id="captchaError" class="captcha-error"></span>
    </div>
    <button class="btn-main" id="generateBtn" type="submit">Mint QR (hash1)</button>
  </form>
  <!-- Preview hash1 before commit -->
  <div id="previewSection" style="display:none;">
    <div class="input-hint" style="text-align:center;"><b>Preview:</b> ตรวจสอบ QR (hash1) ก่อน commit</div>
    <div class="scroll-box" id="hash1List"></div>
    <div class="row-flex">
      <button class="btn-main" id="commitBtn">Commit (hash2)</button>
      <button class="btn-action" id="exitBtn">Exit</button>
    </div>
  </div>
  <div id="resultSection" style="display:none;">
    <div class="qr-preview-section">
      <div class="qr-box">
        <canvas id="qrCanvas"></canvas>
        <div class="input-hint" style="font-size:0.93em;">QR of Commitment</div>
      </div>
      <div class="info-box">
        <div><strong>Commitment Hash</strong></div>
        <div id="commitmentHash" class="mb-2 text-break"></div>
        <div><strong>Timestamp</strong></div>
        <div id="timestamp" class="mb-2"></div>
        <div><strong>Total</strong></div>
        <div id="nonceSummary" class="mb-2"></div>
      </div>
    </div>
    <div>
      <div class="input-label">Nonce List</div>
      <pre id="nonceList" class="scroll-box"></pre>
    </div>
    <div class="export-btns">
      <button id="exportTicket" class="btn-export">Export Ticket</button>
      <button id="exportQR" class="btn-action">Export QR</button>
      <button id="exportLog" class="btn-action">Export Commitment Log</button>
      <button id="screenCapBtn" class="btn-action">Screen Capture</button>
    </div>
    <div class="nav-btns">
      <button class="btn-nav" onclick="history.back()">Back</button>
      <button class="btn-nav" onclick="window.location.href='index.html'">Home</button>
      <button class="btn-main" id="nextBtn">Next &rarr;</button>
    </div>
  </div>
</div>
<script>
  // --- Captcha Logic ---
  let currentCaptcha = "";
  function randomCaptcha() {
    const a = Math.floor(Math.random() * 9) + 1, b = Math.floor(Math.random() * 9) + 1;
    currentCaptcha = (a + b).toString();
    document.getElementById('captchaQ').textContent = `${a} + ${b} = ?`;
    document.getElementById('captcha').value = "";
    document.getElementById('captchaError').textContent = "";
  }
  randomCaptcha();
  document.getElementById("refreshCaptcha").onclick = randomCaptcha;

  // --- Mint QR ---
  const form = document.getElementById("mintForm");
  const previewSection = document.getElementById("previewSection");
  const hash1ListDiv = document.getElementById("hash1List");
  const commitBtn = document.getElementById("commitBtn");
  const exitBtn = document.getElementById("exitBtn");
  const resultSection = document.getElementById("resultSection");
  const commitmentHashDiv = document.getElementById("commitmentHash");
  const timestampDiv = document.getElementById("timestamp");
  const nonceListPre = document.getElementById("nonceList");
  const nonceSummary = document.getElementById("nonceSummary");
  const qrCanvas = document.getElementById("qrCanvas");
  const plusBtn = document.getElementById("plusBtn");
  const minusBtn = document.getElementById("minusBtn");
  let mintData = null, batchData = null;

  plusBtn.onclick = () => {
    let v = parseInt(document.getElementById("qrAmount").value) || 1;
    if (v < 200) document.getElementById("qrAmount").value = v + 1;
  };
  minusBtn.onclick = () => {
    let v = parseInt(document.getElementById("qrAmount").value) || 1;
    if (v > 1) document.getElementById("qrAmount").value = v - 1;
  };

  form.onsubmit = async e => {
    e.preventDefault();
    const password = document.getElementById("password").value.trim();
    const pin = document.getElementById("pin").value.trim();
    const secret = document.getElementById("secret").value.trim();
    const confirmSecret = document.getElementById("confirmSecret").value.trim();
    const batchName = document.getElementById("batchName").value.trim() || "Unnamed";
    const qrAmount = parseInt(document.getElementById("qrAmount").value);
    const captchaInput = document.getElementById("captcha").value.trim();

    if (!password || !pin || !secret || !confirmSecret || isNaN(qrAmount) || qrAmount < 1 || qrAmount > 200) {
      alert("Please fill all required fields correctly."); return;
    }
    if (secret !== confirmSecret) {
      alert("Secret and Confirm Secret do not match."); return;
    }
    if (captchaInput !== currentCaptcha) {
      document.getElementById('captchaError').textContent = "Incorrect!";
      randomCaptcha();
      return;
    }
    document.getElementById('captchaError').textContent = "";

    const qrList = [];
    for (let i = 0; i < qrAmount; i++) {
      const slot_id = i + 1;
      const nonce = crypto.randomUUID();
      const qrhash = await sha256(secret + "|" + slot_id + "|" + nonce);
      qrList.push({ qrhash, slot_id, nonce });
    }
    hash1ListDiv.innerHTML = qrList.map(q => `<div style="color:#246bfd;font-size:0.98em;">#${q.slot_id}: <code>${q.qrhash.slice(0,16)}...${q.qrhash.slice(-8)}</code></div>`).join("");
    previewSection.style.display = '';
    form.style.display = 'none';
    mintData = { password, pin, secret, batchName, qrAmount, qrList };
  };

  commitBtn.onclick = async () => {
    if (!mintData) return;
    const combinedHashes = mintData.qrList.map(q => q.qrhash).join('|');
    const commitmentHash = await sha256(combinedHashes + "|" + mintData.batchName);
    const timestamp = new Date().toISOString();

      commitmentHashDiv.textContent = commitmentHash;
    timestampDiv.textContent = timestamp;
    nonceListPre.textContent = mintData.qrList.map(q => `#${q.slot_id}: ${q.nonce}`).join('\n');
    nonceSummary.textContent = `${mintData.qrAmount} items`;

    QRCode.toCanvas(qrCanvas, commitmentHash);

    resultSection.style.display = '';
    previewSection.style.display = 'none';

    batchData = {
      batchName: mintData.batchName, password: mintData.password, pin: mintData.pin, secret: mintData.secret,
      commitmentHash, timestamp, qrList: mintData.qrList
    };
  };

  exitBtn.onclick = () => {
    form.style.display = '';
    previewSection.style.display = 'none';
    hash1ListDiv.innerHTML = "";
    mintData = null;
    randomCaptcha();
  };

  document.getElementById("exportTicket").onclick = () => {
    if (!batchData) return;
    const ticket = [
      `Batch: ${batchData.batchName}`,
      `Password: ${batchData.password}`,
      `PIN: ${batchData.pin}`,
      `Secret: ${batchData.secret}`,
      `Commitment: ${batchData.commitmentHash}`,
      `Timestamp: ${batchData.timestamp}`,
      `Nonces:`,
      ...batchData.qrList.map(q => `#${q.slot_id}: ${q.nonce}`)
    ].join('\n');
    downloadText(ticket, `qr_ticket_${Date.now()}.txt`);
  };
  document.getElementById("exportQR").onclick = () => {
    if (!batchData) return;
    const qrHashes = batchData.qrList.map(q => q.qrhash).join('\n');
    downloadText(qrHashes, `qr_hashes_${Date.now()}.txt`);
  };
  document.getElementById("exportLog").onclick = () => {
    if (!batchData) return;
    const log = {
      batchName: batchData.batchName,
      timestamp: batchData.timestamp,
      commitmentHash: batchData.commitmentHash,
      qrHashes: batchData.qrList.map(q => q.qrhash)
    };
    const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `commitment_log_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  document.getElementById("screenCapBtn").onclick = () => {
    html2canvas(document.querySelector('.container')).then(canvas => {
      const link = document.createElement('a');
      link.download = `mint_qr_ticket_${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
  };
  document.getElementById("nextBtn").onclick = () => {
    alert("You can connect to the next step (e.g., QR registration) here.");
    // window.location.href = "register.html";
  };
  function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  async function sha256(str) {
    const enc = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }
</script>
</body>
</html>
