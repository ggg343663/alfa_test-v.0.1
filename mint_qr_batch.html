<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mint QR Batch (Double Hash UI) - DTC System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { background: #f5f7fa; }
    .container {
      max-width: 520px;
      margin: 2.5em auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 30px #21915015, 0 1px 6px #2563eb13;
      padding: 2em 1.2em 2.5em 1.2em;
    }
    .input-label { color: #90a4ae; font-weight: 500; font-size: 0.97em; margin-bottom: 0.25em;}
    .form-control { height: 44px; font-size: 1.07em; }
    .qr-preview-section { display: flex; gap: 1em; margin: 1.5em 0 1.2em 0; }
    .qr-box {
      background: #eaf2fa; border-radius: 13px; padding: 0.7em 1em;
      border-left: 5px solid #219150; min-width: 120px; text-align: center;
    }
    .qr-box canvas { margin-bottom: .5em; }
    .info-box {
      background: #f7f7fb; border-radius: 11px; padding: 1em 1.1em 1em 1.1em;
      border-left: 5px solid #246bfd; font-size: 1.02em;
      min-width: 160px; max-width: 320px;
      color: #234;
    }
    .export-btns .btn { min-width: 110px; }
    .nav-btns .btn { min-width: 90px; }
    .label-hint { font-size: 0.91em; color: #b0b0b0; margin-top: 0.1em; margin-bottom: 0.25em;}
    .scroll-box { max-height: 110px; overflow: auto; font-size: 0.98em; }
    .section-divider { border-top: 1px solid #eee; margin: 1.4em 0 1.4em 0; }
    .form-section { margin-bottom: 1.4em; }
    @media (max-width: 600px) {
      .container { padding: 1em 0.1em 1.2em 0.1em; }
      .qr-preview-section { flex-direction: column; gap: .9em;}
      .info-box, .qr-box { min-width: 0; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="text-center text-success mb-4">Mint QR Batch (Double Hash UI)</h2>
  <!-- Step 1: Mint QR (hash1) -->
  <form id="mintForm" autocomplete="off" class="form-section">
    <div class="row g-3">
      <div class="col-12">
        <label class="input-label">Password</label>
        <input id="password" type="password" class="form-control" required maxlength="16">
        <div class="label-hint">6-16 characters, for regen &amp; commit</div>
      </div>
      <div class="col-12">
        <label class="input-label">PIN</label>
        <input id="pin" type="password" class="form-control" required maxlength="8">
        <div class="label-hint">4-8 digits</div>
      </div>
      <div class="col-12">
        <label class="input-label">Secret</label>
        <input id="secret" type="text" class="form-control" required maxlength="64">
        <div class="label-hint">For secure minting (don't lose!)</div>
      </div>
      <div class="col-12">
        <label class="input-label">Confirm Secret</label>
        <input id="confirmSecret" type="text" class="form-control" required maxlength="64">
        <div class="label-hint">Type your secret again</div>
      </div>
      <div class="col-12">
        <label class="input-label">Batch Name (optional)</label>
        <input id="batchName" type="text" class="form-control" maxlength="32">
      </div>
      <div class="col-12 d-flex align-items-center">
        <label class="input-label me-2 mb-0">Number of QR</label>
        <input id="qrAmount" type="number" class="form-control" value="10" min="1" max="200" style="width:110px;">
        <button type="button" class="btn btn-outline-secondary ms-2 py-1" id="plusBtn">+</button>
        <button type="button" class="btn btn-outline-secondary ms-1 py-1" id="minusBtn">–</button>
      </div>
    </div>
    <button class="btn btn-primary w-100 my-3" id="generateBtn" type="submit">Mint QR (hash1)</button>
  </form>
  
  <!-- Preview Section: hash1 only, commit or exit -->
  <div id="previewSection" class="d-none">
    <div class="text-center text-secondary mb-2" style="font-size:0.97em;">
      <b>Preview:</b> ตรวจสอบ QR (hash1) ทั้งหมด ก่อนยืนยัน<br>สามารถเลื่อนดู hash1 ทั้งหมดก่อน commit
    </div>
    <div class="scroll-box mb-3 border rounded bg-light p-2" id="hash1List"></div>
    <div class="d-flex gap-2">
      <button class="btn btn-success flex-fill" id="commitBtn">Commit (hash2)</button>
      <button class="btn btn-outline-danger flex-fill" id="exitBtn">Exit (ไม่บันทึก)</button>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Step 2: Commit (hash2) -->
  <div id="resultSection" class="d-none">
    <div class="qr-preview-section">
      <div class="qr-box">
        <canvas id="qrCanvas"></canvas>
        <div class="text-secondary mt-2" style="font-size:0.93em;">QR of Commitment</div>
      </div>
      <div class="info-box">
        <div><strong>Commitment Hash</strong></div>
        <div id="commitmentHash" class="mb-2 text-break"></div>
        <div><strong>Timestamp</strong></div>
        <div id="timestamp" class="mb-2"></div>
        <div><strong>Total</strong></div>
        <div id="nonceSummary" class="mb-2"></div>
      </div>
    </div>
    <div>
      <h6 class="mb-1 mt-2">Nonce List</h6>
      <pre id="nonceList" class="bg-light p-3 rounded" style="font-size:0.96em; max-height:140px; overflow:auto"></pre>
    </div>
    <!-- Export Section -->
    <div class="export-btns d-flex gap-2 mt-3 mb-3">
      <button id="exportTicket" class="btn btn-warning">Export Ticket</button>
      <button id="exportQR" class="btn btn-primary">Export QR</button>
      <button id="exportLog" class="btn btn-info text-white">Export Commitment Log</button>
      <button id="screenCapBtn" class="btn btn-outline-secondary">Screen Capture</button>
    </div>
    <!-- Navigation -->
    <div class="nav-btns d-flex gap-2 mt-4 justify-content-between">
      <button class="btn btn-outline-secondary" onclick="history.back()">Back</button>
      <button class="btn btn-outline-dark" onclick="window.location.href='index.html'">Home</button>
      <button class="btn btn-success" id="nextBtn">Next &rarr;</button>
    </div>
  </div>
</div>
<!-- html2canvas สำหรับ screen capture -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  // --- Element refs
  const form = document.getElementById("mintForm");
  const previewSection = document.getElementById("previewSection");
  const hash1ListDiv = document.getElementById("hash1List");
  const commitBtn = document.getElementById("commitBtn");
  const exitBtn = document.getElementById("exitBtn");
  const resultSection = document.getElementById("resultSection");
  const commitmentHashDiv = document.getElementById("commitmentHash");
  const timestampDiv = document.getElementById("timestamp");
  const nonceListPre = document.getElementById("nonceList");
  const nonceSummary = document.getElementById("nonceSummary");
  const qrCanvas = document.getElementById("qrCanvas");
  const plusBtn = document.getElementById("plusBtn");
  const minusBtn = document.getElementById("minusBtn");

  let mintData = null, batchData = null;

  // --- Number +/-
  plusBtn.onclick = () => {
    let v = parseInt(document.getElementById("qrAmount").value) || 1;
    if (v < 200) document.getElementById("qrAmount").value = v + 1;
  };
  minusBtn.onclick = () => {
    let v = parseInt(document.getElementById("qrAmount").value) || 1;
    if (v > 1) document.getElementById("qrAmount").value = v - 1;
  };

  // --- Mint QR (Step 1)
  form.onsubmit = async e => {
    e.preventDefault();

    const password = document.getElementById("password").value.trim();
    const pin = document.getElementById("pin").value.trim();
    const secret = document.getElementById("secret").value.trim();
    const confirmSecret = document.getElementById("confirmSecret").value.trim();
    const batchName = document.getElementById("batchName").value.trim() || "Unnamed";
    const qrAmount = parseInt(document.getElementById("qrAmount").value);

    if (!password || !pin || !secret || !confirmSecret || isNaN(qrAmount) || qrAmount < 1 || qrAmount > 200) {
      alert("Please fill all required fields correctly.");
      return;
    }
    if (secret !== confirmSecret) {
      alert("Secret and Confirm Secret do not match.");
      return;
    }

    // DTC Double hash step 1: hash1
    const qrList = [];
    for (let i = 0; i < qrAmount; i++) {
      const slot_id = i + 1;
      const nonce = crypto.randomUUID();
      const qrhash = await sha256(secret + "|" + slot_id + "|" + nonce);
      qrList.push({ qrhash, slot_id, nonce });
    }

    // Show preview hash1 for user confirm
    hash1ListDiv.innerHTML = qrList.map(q => `<div style="font-size:0.98em; color:#2563eb;">#${q.slot_id}: <code>${q.qrhash.slice(0,16)}...${q.qrhash.slice(-8)}</code></div>`).join("");
    previewSection.classList.remove("d-none");
    form.classList.add("d-none");
    mintData = { password, pin, secret, batchName, qrAmount, qrList };
  };

  // --- Commit (Step 2: hash2)
  commitBtn.onclick = async () => {
    if (!mintData) return;
    // hash2 (commitment)
    const combinedHashes = mintData.qrList.map(q => q.qrhash).join('|');
    const commitmentHash = await sha256(combinedHashes + "|" + mintData.batchName);
    const timestamp = new Date().toISOString();

    // Update preview
    commitmentHashDiv.textContent = commitmentHash;
    timestampDiv.textContent = timestamp;
    nonceListPre.textContent = mintData.qrList.map(q => `#${q.slot_id}: ${q.nonce}`).join('\n');
    nonceSummary.textContent = `${mintData.qrAmount} items`;

    QRCode.toCanvas(qrCanvas, commitmentHash);

    resultSection.classList.remove("d-none");
    previewSection.classList.add("d-none");

    batchData = {
      batchName: mintData.batchName, password: mintData.password, pin: mintData.pin, secret: mintData.secret,
      commitmentHash, timestamp, qrList: mintData.qrList
    };
  };

  // --- Exit (cancel, go back to mint)
  exitBtn.onclick = () => {
    form.classList.remove("d-none");
    previewSection.classList.add("d-none");
    hash1ListDiv.innerHTML = "";
    mintData = null;
  };

  // --- Export Ticket (backup)
  document.getElementById("exportTicket").onclick = () => {
    if (!batchData) return;
    const ticket = [
      `Batch: ${batchData.batchName}`,
      `Password: ${batchData.password}`,
      `PIN: ${batchData.pin}`,
      `Secret: ${batchData.secret}`,
      `Commitment: ${batchData.commitmentHash}`,
      `Timestamp: ${batchData.timestamp}`,
      `Nonces:`,
      ...batchData.qrList.map(q => `#${q.slot_id}: ${q.nonce}`)
    ].join('\n');
    downloadText(ticket, `qr_ticket_${Date.now()}.txt`);
  };
  // --- Export QR only (hash1)
  document.getElementById("exportQR").onclick = () => {
    if (!batchData) return;
    const qrHashes = batchData.qrList.map(q => q.qrhash).join('\n');
    downloadText(qrHashes, `qr_hashes_${Date.now()}.txt`);
  };
  // --- Export Commitment Log (public)
  document.getElementById("exportLog").onclick = () => {
    if (!batchData) return;
    const log = {
      batchName: batchData.batchName,
      timestamp: batchData.timestamp,
      commitmentHash: batchData.commitmentHash,
      qrHashes: batchData.qrList.map(q => q.qrhash)
    };
    const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `commitment_log_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  // --- Screen Capture
  document.getElementById("screenCapBtn").onclick = () => {
    html2canvas(document.querySelector('.container')).then(canvas => {
      const link = document.createElement('a');
      link.download = `mint_qr_ticket_${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
  };
  // --- Next
  document.getElementById("nextBtn").onclick = () => {
    alert("You can connect to the next step (e.g., QR registration) here.");
    // window.location.href = "register.html";
  };
  // --- Utils
  function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  async function sha256(str) {
    const enc = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }
</script>
</body>
</html>
