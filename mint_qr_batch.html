<!DOCTYPE html>
<html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <title>Mint QR Batch (Double Hash UI) - DTC System</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">  
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>  
</head>  
<body>  
  <div class="container my-5 p-4 bg-white rounded shadow">  
    <h2 class="text-center text-success mb-4">Mint QR Batch (Double Hash UI)</h2>
    <form id="mintForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Password</label>
          <input id="password" type="password" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">PIN</label>
          <input id="pin" type="password" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Secret</label>
          <input id="secret" type="text" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Batch Name (optional)</label>
          <input id="batchName" type="text" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Number of QR</label>
          <input id="qrAmount" type="number" class="form-control" value="10" min="1" max="200">
        </div>
      </div>
      <button class="btn btn-success w-100 my-3" type="submit">Generate QR Batch</button>
    </form>

    <div id="result" class="mt-4 d-none">
      <h5 class="text-primary">Commitment Hash:</h5>
      <div id="commitmentHash" class="mb-2 text-break"></div>

      <h5 class="text-primary">Timestamp:</h5>
      <div id="timestamp" class="mb-2"></div>

      <h5 class="text-primary">Nonce List:</h5>
      <pre id="nonceList" class="bg-light p-3 rounded"></pre>

      <canvas id="qrCanvas" class="my-3"></canvas>

      <button id="copyTicket" class="btn btn-primary">Copy Ticket</button>
      <button id="exportLog" class="btn btn-warning">Export JSON Log</button>
    </div>
  </div>  

  <script>
    const form = document.getElementById("mintForm");
    const commitmentHashDiv = document.getElementById("commitmentHash");
    const timestampDiv = document.getElementById("timestamp");
    const nonceListPre = document.getElementById("nonceList");
    const resultSection = document.getElementById("result");

    form.onsubmit = async e => {
      e.preventDefault();

      const password = document.getElementById("password").value;
      const pin = document.getElementById("pin").value;
      const secret = document.getElementById("secret").value;
      const batchName = document.getElementById("batchName").value || "Unnamed";
      const qrAmount = parseInt(document.getElementById("qrAmount").value);

      const qrList = [];
      for (let i = 0; i < qrAmount; i++) {
        const nonce = crypto.randomUUID();
        const qrhash = await sha256(secret + nonce);
        qrList.push({ qrhash, nonce });
      }

      const combinedHashes = qrList.map(q => q.qrhash).join('|');
      const commitmentHash = await sha256(combinedHashes);
      const timestamp = new Date().toISOString();

      commitmentHashDiv.textContent = commitmentHash;
      timestampDiv.textContent = timestamp;
      nonceListPre.textContent = qrList.map(q => q.nonce).join('\n');

      QRCode.toCanvas(document.getElementById('qrCanvas'), commitmentHash);

      resultSection.classList.remove("d-none");

      window.batchData = { batchName, password, pin, secret, commitmentHash, timestamp, qrList };
    };

    document.getElementById("copyTicket").onclick = () => {
      const { batchName, password, pin, secret, commitmentHash, timestamp, qrList } = window.batchData;
      const ticket = `Batch: ${batchName}\nPassword: ${password}\nPIN: ${pin}\nSecret: ${secret}\nCommitment: ${commitmentHash}\nTimestamp: ${timestamp}\nNonces:\n${qrList.map(q => q.nonce).join('\n')}`;
      navigator.clipboard.writeText(ticket).then(() => alert("Ticket copied!"));
    };

    document.getElementById("exportLog").onclick = () => {
      const blob = new Blob([JSON.stringify(window.batchData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `qr_batch_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    async function sha256(str) {
      const enc = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>  
</html>
