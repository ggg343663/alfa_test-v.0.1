<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register Master | DTC Magic Chain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafc; color: #222; }
    .main { max-width: 410px; margin: 2em auto; background: #fff; border-radius: 17px; box-shadow: 0 8px 40px #246bfd13; padding: 2em 1.4em 1.3em 1.4em; }
    .nav-row { display: flex; justify-content: space-between; margin-bottom: 1.5em; }
    .nav-btn {
      background: #ede7f6; color: #246bfd; border: none; border-radius: 8px; padding: 0.53em 1.4em;
      font-size: 1.03em; font-weight: 500; cursor: pointer; transition: background 0.18s;
    }
    .nav-btn:hover { background: #d1c4e9; }
    h2 { text-align: center; color: #26733e; margin-bottom: 1.2em; }
    .input-row { margin-bottom: 1.13em; }
    label { font-weight: bold; color: #26733e; display: block; margin-bottom: 0.21em; }
    input[type="text"] {
      width: 100%; padding: 0.7em; border-radius: 8px; border: 1.5px solid #dde6ee; font-size: 1.08em;
      margin-bottom: 0.19em; background: #f7fbff;
    }
    .counter { font-size: 0.93em; color: #90a4ae; float: right; }
    .btn {
      display: block; width: 100%; padding: 0.9em 0; border-radius: 10px; border: none;
      background: linear-gradient(90deg,#26733e 70%,#2196f3 100%);
      color: #fff; font-size: 1.11em; font-weight: 600;
      margin: 1.2em 0 0.7em 0; cursor: pointer; box-shadow: 0 2px 8px #246bfd1b; transition: background 0.18s;
    }
    .btn:active { background: #176d38; }
    .btn[disabled] { opacity: 0.54; cursor: not-allowed; }
    .msg { text-align: center; margin: 1.1em 0 0.6em 0; font-size: 1.02em; }
    .msg-error { color: #c41e1e; background: #fff2f2; border-left: 5px solid #c41e1e; border-radius: 7px; padding: 0.5em; }
    .msg-success { color: #16774a; background: #eafff1; border-left: 5px solid #31e57a; border-radius: 7px; padding: 0.5em; }
    .copy-btn { padding: 0.2em 1em; margin-left: 0.5em; border: none; border-radius: 5px; background: #2196f3; color: #fff; cursor: pointer; font-size: 0.97em; }
    .copy-btn:active { background: #176d38; }
    .warn { color:#b91c1c; background:#fbe7e7; padding:0.5em 0.8em; border-radius:7px; margin:0.36em 0 0.8em 0; font-size:0.96em;}
    .note { font-size: 0.96em; color: #90a4ae; text-align: center; margin-top: 1.15em;}
    .preview-box {
      background: #f6fafd; border: 1.5px solid #dde6ee;
      border-radius: 10px; padding: 1em 0.8em 0.8em 0.8em;
      margin: 1em 0 0.4em 0;
      font-size: 0.97em; color: #246bfd;
      word-break: break-all; max-height: 160px; overflow-x: auto;
      display: none;
    }
    .preview-title { color: #26733e; font-size: 1.04em; margin-bottom:0.2em;}
    @media (max-width: 480px) { .main {padding:1em 0.2em 0.7em 0.2em;} }
  </style>
</head>
<body>
  <div class="main">
    <div class="nav-row">
      <button class="nav-btn" onclick="window.location.href='index.html'">Back</button>
      <button class="nav-btn" onclick="window.location.href='index.html'">Home</button>
    </div>
    <h2>Register Master</h2>
    <form id="masterForm" autocomplete="off">
      <div class="input-row">
        <label>Master Name <span class="counter" id="nameCounter">0/12</span></label>
        <input type="text" id="masterName" maxlength="12" pattern="[A-Z]+" placeholder="A-Z only (4-12 chars)" required autocomplete="off" />
        <div id="badwordWarn" class="warn" style="display:none;"></div>
      </div>
      <div class="input-row">
        <label>Public Key <span class="counter" id="pubkeyCounter">0/64</span></label>
        <input type="text" id="pubkey" maxlength="64" pattern="^[a-fA-F0-9]{64}$" placeholder="Paste your public key here" required autocomplete="off" />
        <button class="copy-btn" type="button" onclick="copyField('pubkey')">Copy</button>
      </div>
      <button class="btn" type="submit" id="reqBtn" disabled>Register Master</button>
      <div id="msgBox" class="msg"></div>
    </form>
    <div id="previewBox" class="preview-box">
      <div class="preview-title">Preview Master Node (Audit Structure):</div>
      <pre id="previewJson" style="background:none;padding:0 0 0 0;font-size:0.96em;color:#246bfd;"></pre>
      <button class="copy-btn" style="margin-top:0.2em;" onclick="copyPreviewJson()">Copy JSON</button>
    </div>
    <div class="note">
      *Master name = 4-12 chars, A-Z only.<br>
      *Public key = 64 HEX chars (from previous step).
    </div>
  </div>
  <script>
    const GENESIS_HASH = "c8a1e35a25dcb2742e17b26f012f13a742b639d94a1a5e6c18e7a12dbcc9bfc7";
    let badwords = {};
    let flatBadwords = [];
    let badwordsReady = false;
    let badwordsError = false;

    // Autofill public key
    window.addEventListener('DOMContentLoaded', function() {
      const localPub = localStorage.getItem('dtc_publicKey');
      if (localPub && localPub.length === 64 && /^[a-fA-F0-9]+$/.test(localPub)) {
        document.getElementById('pubkey').value = localPub;
        document.getElementById('pubkeyCounter').textContent = localPub.length + "/64";
      }
      updateBtnState();
    });

    // Load badwords
    fetch('badwords.json')
      .then(r=>r.json())
      .then(list=>{
        badwords=list;
        flatBadwords = Object.values(list).flat().map(x=>x.toLowerCase());
        badwordsReady = true;
      }).catch(()=>{
        badwordsReady = false;
        badwordsError = true;
        document.getElementById('badwordWarn').style.display = "";
        document.getElementById('badwordWarn').textContent = "Could not load badwords list. Please check badwords.json or contact admin.";
      });

    function findBadwords(str) {
      if (!badwordsReady || !str) return [];
      const s = str.toLowerCase();
      return flatBadwords.filter(w => w && s.includes(w));
    }

    document.getElementById('masterName').addEventListener('input', function(){
      const warn = document.getElementById('badwordWarn');
      const v = this.value.trim().toLowerCase();
      const found = findBadwords(v);
      if (badwordsError) {
        warn.style.display = "";
        warn.textContent = "Could not load badwords list. Please check badwords.json or contact admin.";
      } else if (found.length) {
        warn.style.display = "";
        warn.textContent = "Warning: Contains inappropriate words (" + found.slice(0,3).join(', ') + (found.length>3?',...':'') + "). Please reconsider.";
      } else {
        warn.style.display = "none";
      }
      updateBtnState();
      livePreview();
    });

    document.getElementById('masterName').addEventListener('input', function() {
      this.value = this.value.replace(/[^A-Z]/g,'').toUpperCase();
      document.getElementById('nameCounter').textContent = this.value.length + "/12";
      updateBtnState();
      livePreview();
    });
    document.getElementById('pubkey').addEventListener('input', function() {
      this.value = this.value.replace(/[^a-fA-F0-9]/g,'');
      document.getElementById('pubkeyCounter').textContent = this.value.length + "/64";
      updateBtnState();
      livePreview();
    });

    function updateBtnState() {
      const name = document.getElementById('masterName').value.trim();
      const pk = document.getElementById('pubkey').value.trim();
      const btn = document.getElementById('reqBtn');
      btn.disabled = (
        !name || name.length<4 || name.length>12 ||
        !pk || pk.length!==64 ||
        badwordsError
      );
    }

    function copyField(id) {
      const el = document.getElementById(id);
      el.select();
      navigator.clipboard.writeText(el.value);
      showMsg("Copied!", "success");
    }

    function showMsg(msg, type) {
      const box = document.getElementById('msgBox');
      box.innerHTML = msg;
      box.className = "msg" + (type === "error" ? " msg-error" : " msg-success");
      setTimeout(() => { box.innerHTML = ""; box.className = "msg"; }, 3000);
    }

    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function genNonce() {
      let arr = new Uint8Array(8);
      window.crypto.getRandomValues(arr);
      return Array.from(arr).map(x=>x.toString(16).padStart(2,'0')).join('');
    }

    async function buildMasterNode() {
      const masterName = document.getElementById('masterName').value.trim().toUpperCase();
      const publicKey = document.getElementById('pubkey').value.trim();
      if(masterName.length<4 || masterName.length>12 || publicKey.length!==64) return null;
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const nonce = genNonce();
      const hashInput = GENESIS_HASH + masterName + timestamp + nonce;
      const hash = await sha256Hex(hashInput);
      return {
        master_id: masterName,
        public_key: publicKey,
        timestamp: timestamp,
        nonce: nonce,
        prev_hash: GENESIS_HASH,
        hash: hash
      };
    }

    async function livePreview() {
      const masterName = document.getElementById('masterName').value.trim().toUpperCase();
      const publicKey = document.getElementById('pubkey').value.trim();
      if(masterName.length<4 || masterName.length>12 || publicKey.length!==64) {
        document.getElementById('previewBox').style.display = "none";
        return;
      }
      const node = await buildMasterNode();
      if(!node) return;
      document.getElementById('previewJson').textContent = JSON.stringify(node, null, 2);
      document.getElementById('previewBox').style.display = "";
    }

    function copyPreviewJson() {
      const txt = document.getElementById('previewJson').textContent;
      navigator.clipboard.writeText(txt);
      showMsg("Copied JSON!", "success");
    }

    document.getElementById('masterForm').onsubmit = async function(e){
      e.preventDefault();
      const name = document.getElementById('masterName').value.trim().toUpperCase();
      const pk = document.getElementById('pubkey').value.trim();
      if (badwordsReady && findBadwords(name).length) {
        if (!confirm("Warning: The master name contains inappropriate words. Are you sure you want to continue?")) {
          return false;
        }
      }
      if (badwordsError) {
        alert("Cannot verify inappropriate words. Please check badwords.json or contact admin.");
        return false;
      }

      if(name.length < 4 || name.length > 12) return showMsg("Master name must be 4-12 uppercase letters.", "error");
      if(name === "GENESIS") return showMsg("Cannot use reserved name GENESIS for Master.", "error");
      if(pk.length !== 64 || !/^[a-fA-F0-9]{64}$/.test(pk)) return showMsg("Public key must be exactly 64 HEX chars.", "error");

      const node = await buildMasterNode();
      let masters = [];
      try { masters = JSON.parse(localStorage.getItem('dtc_masters') || "[]"); } catch(e) {}
      masters.push(node);
      localStorage.setItem('dtc_masters', JSON.stringify(masters));

      showMsg("Registration successful!", "success");
      document.getElementById('previewJson').textContent = JSON.stringify(node, null, 2);
      document.getElementById('previewBox').style.display = "";
      document.getElementById('masterForm').reset();
      document.getElementById('nameCounter').textContent = "0/12";
      document.getElementById('pubkeyCounter').textContent = "0/64";
      updateBtnState();
    };
  </script>
</body>
</html>
