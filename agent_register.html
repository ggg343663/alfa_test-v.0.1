<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register Agent (DTC, 2-step sign)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial,sans-serif; background: #f4f8fb; margin:0; padding:0;}
    .container {
      max-width: 460px; margin:2em auto; background:#fff;
      padding:2.2em 1.1em 2.1em 1.1em; border-radius:15px;
      box-shadow:0 2px 16px #22c55e22;
    }
    h2 { color:#22c55e; text-align:center; margin-bottom:1.4em;}
    label { font-weight:600; margin-top:1em; display:block;}
    input[type=text], textarea, input[type=password] {
      width:100%; padding:0.62em 0.7em; font-size:1.05em;
      border-radius:8px; border:1.3px solid #22c55e;
      background:#e7fbe8; color:#166534; margin-bottom:0.42em;
      margin-top:0.15em;
      transition: border 0.15s;
    }
    textarea { min-height:3.3em; resize:vertical;}
    .btn-main {
      width:100%; padding:0.75em 0; background:#22c55e;
      color:#fff; border:none; border-radius:9px; font-weight:700;
      font-size:1.08em; margin-top:1.3em; cursor:pointer;
      letter-spacing:0.01em; transition:background 0.17s;
    }
    .btn-main:disabled { background:#94e7ba; color:#fff;}
    .btn-main:hover:enabled { background:#16a34a;}
    .hash-row {
      margin-top:1.2em; word-break:break-all; font-family:monospace;
      font-size:1.04em; color:#26733e; background:#e7fbe8;
      border-radius:8px; padding:0.7em 1em;
      position: relative;
    }
    .step-label { margin:1em 0 0.4em 0; font-weight:bold; color:#26733e;}
    .copy-btn { background:none; border:none; color:#22c55e; cursor:pointer;}
    .copy-success { color:#16a34a; font-size:0.95em; margin-left:0.33em;}
  </style>
</head>
<body>
<div class="container">
  <h2>Register Agent (2-step sign)</h2>
  <div class="step-label">Step 1: Master creates Agent slot</div>
  <form id="masterForm" autocomplete="off">
    <label>Agent Name (a-z,0-9, ≤16):</label>
    <input type="text" id="agentName" maxlength="16" required autocomplete="off" />

    <label>Agent Public Key:</label>
    <input type="text" id="agentPubKey" maxlength="64" required autocomplete="off" />

    <label>Nonce (random string):</label>
    <input type="text" id="nonce" maxlength="20" required autocomplete="off" />
    <button type="button" onclick="randomNonce()" class="copy-btn" style="margin-bottom:0.6em;">Random Nonce</button>
    <button class="btn-main" type="submit">Create Agent Slot</button>
  </form>
  <div id="step2Section" style="display:none;">
    <div class="step-label">Step 2: Agent confirms and signs</div>
    <div style="font-size:0.97em; margin-bottom:0.2em;">
      Copy this payload and let the agent sign with their password+pin:
    </div>
    <textarea id="agentPayload" readonly></textarea>
    <button class="copy-btn" type="button" onclick="copyAgentPayload()">Copy Payload</button>
    <span id="copyAgentPayloadSuccess" class="copy-success"></span>
    <div style="margin-top:1.2em;">
      <label>Agent Password:</label>
      <input type="password" id="agentPw" maxlength="12" />
      <label>Agent PIN:</label>
      <input type="password" id="agentPin" maxlength="6" />
      <button class="btn-main" type="button" onclick="signAgent()" style="margin-top:0.8em;">Agent Sign</button>
    </div>
    <div id="sigResult" class="hash-row" style="display:none;"></div>
  </div>
</div>
<script>
  // Util
  function randomNonce() {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let s = "";
    for (let i=0;i<16;i++) s += chars[Math.floor(Math.random()*chars.length)];
    document.getElementById('nonce').value = s;
  }
  randomNonce();

  // Step 1: Master Create
  document.getElementById('masterForm').onsubmit = function(e){
    e.preventDefault();
    const name = document.getElementById('agentName').value.trim();
    const pubkey = document.getElementById('agentPubKey').value.trim();
    const nonce = document.getElementById('nonce').value.trim();
    if (!name || !/^[a-z0-9]{1,16}$/.test(name)) { alert("Invalid agent name"); return; }
    if (!pubkey || pubkey.length<30) { alert("Invalid agent public key"); return; }
    if (!nonce) { alert("Enter nonce"); return; }
    const timestamp = new Date().toISOString();
    const master_hash = "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"; // demo
    const agent_hash_str = `${master_hash}:${pubkey}:${name}:${nonce}:${timestamp}`;
    window.agent_hash_data = { master_hash, agent_pubkey:pubkey, agent_name:name, nonce, timestamp };
    window.agent_hash_to_sign = agent_hash_str;
    document.getElementById('step2Section').style.display = "block";
    document.getElementById('agentPayload').value = agent_hash_str;
    window.agent_hash = ""; // clear old
    document.getElementById('sigResult').style.display = "none";
  };

  // PBKDF2 derive (browser)
  async function pbkdf2_sha256(password, pin) {
    const enc = new TextEncoder();
    const key = await window.crypto.subtle.importKey("raw", enc.encode(password+"|"+pin), "PBKDF2", false, ["deriveBits"]);
    const bits = await window.crypto.subtle.deriveBits(
      {name:"PBKDF2",salt:enc.encode("DTC-KEY-SALT"),iterations:100000,hash:"SHA-256"}, key, 256);
    return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2,"0")).join("");
  }
  async function hmac_sha256(keyHex, msg) {
    const enc = new TextEncoder();
    const key = await window.crypto.subtle.importKey("raw", hex2buf(keyHex), {name:"HMAC",hash:"SHA-256"}, false, ["sign"]);
    const sig = await window.crypto.subtle.sign("HMAC", key, enc.encode(msg));
    return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function hex2buf(hex){return new Uint8Array(hex.match(/../g).map(x=>parseInt(x,16)));}

  // Step 2: Agent Sign
  async function signAgent() {
    const pw = document.getElementById('agentPw').value.trim();
    const pin = document.getElementById('agentPin').value.trim();
    if (!pw || !pin) { alert("Please enter agent password & pin"); return; }
    const priv = await pbkdf2_sha256(pw, pin);
    const sig = await hmac_sha256(priv, window.agent_hash_to_sign);
    window.agent_hash = sig;
    // Show log (demo, ใน production ต้องรวม sig_master ด้วย)
    const res = {
      ...window.agent_hash_data,
      sig_agent: sig
    };
    const div = document.getElementById('sigResult');
    div.style.display = "block";
    div.innerHTML = "<b>Agent Registration Complete</b><br><pre>"+JSON.stringify(res,null,2)+"</pre>";
  }

  // Copy util
  function copyAgentPayload() {
    const el = document.getElementById('agentPayload');
    el.select(); el.setSelectionRange(0, 9999);
    navigator.clipboard.writeText(el.value);
    document.getElementById('copyAgentPayloadSuccess').textContent = "Copied!";
    setTimeout(()=>{document.getElementById('copyAgentPayloadSuccess').textContent="";},1200);
  }
</script>
</body>
</html>
