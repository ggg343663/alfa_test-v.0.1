<script>
/* ตัวอย่าง logs array (ปกติ fetch logs.json แล้วแปลงเป็น logs) */
const logs = [
  {
    "slot": 1,
    "hash": "...",
    "prev_hash": "...",
    "qr_hash": "A9F1...1CDE",
    "timestamp": "2024-06-02T12:00:00Z",
    "pubkey": "0x0fA...123",
    "status": "registered",
    "action": "register",
    "meta": {}
  },
  {
    "slot": 2,
    "hash": "...",
    "prev_hash": "...",
    "qr_hash": "B8A2...3BAF",
    "timestamp": "2024-06-02T12:01:00Z",
    "pubkey": "",
    "status": "available",
    "action": "mint",
    "meta": {}
  }
  // ... เพิ่มตามจริง
];

// ตัวอย่าง batchConfig (ปรับให้ตรงกับระบบ)
const batchConfig = [
  {batch:1, label:"Batch 1 (Limited)", size:100, unlockPercent:0.5, nextBatch:2, nextAmount:2000},
  {batch:2, label:"Batch 2", size:2000, unlockPercent:0.5, nextBatch:3, nextAmount:2000},
  {batch:3, label:"Batch 3", size:2000, unlockPercent:0.5, nextBatch:null, nextAmount:null},
];

// --- แปลง logs เป็น qrList ที่ใช้ในตาราง ---
function buildQRList(logs) {
  // ควรสร้าง mapping ที่อัปเดต status/owner ล่าสุด
  const qrMap = {};
  logs.forEach(entry => {
    const hash = entry.qr_hash;
    if (!qrMap[hash]) {
      qrMap[hash] = {
        hash: hash,
        batch: findBatch(hash),
        status: entry.status || "available",
        owner: entry.pubkey || "",
        index: entry.slot
      };
    } else {
      // update status/owner ถ้า action มีการเปลี่ยนแปลง (register/transfer)
      if (entry.status) qrMap[hash].status = entry.status;
      if (entry.pubkey) qrMap[hash].owner = entry.pubkey;
    }
  });
  // รีเทิร์น array สำหรับ render
  return Object.values(qrMap);
}

// ตัวอย่างวิธีระบุ batch จาก hash (ถ้ามีเลข index หรือลำดับ)
// ถ้า hash มี batch ฝัง ให้ map hash → batch เลย
function findBatch(hash) {
  // demo: กำหนด batch จาก prefix (เช่น A = 1, B = 2, ...)
  if (hash.startsWith("A")) return 1;
  if (hash.startsWith("B")) return 2;
  if (hash.startsWith("C")) return 3;
  return 1;
}

let qrList = buildQRList(logs);

// === (โค้ดที่เหลือ render batch, table, export etc. เหมือนเดิม) ===

// ... คัดลอกฟังก์ชัน renderBatchProgress(), renderSummaryBar(), renderTable(), exportQR() ตามโครงเดิม
// ... เปลี่ยน qrList เป็น global (อัปเดตได้ถ้าข้อมูล logs เปลี่ยน)

function renderBatchProgress() {
  const section = document.getElementById('batchProgress');
  let html = "";
  batchConfig.forEach(cfg => {
    const batchQrs = qrList.filter(q=>q.batch===cfg.batch);
    const reg = batchQrs.filter(q=>q.status==="registered").length;
    const avail = batchQrs.filter(q=>q.status==="available").length;
    const trans = batchQrs.filter(q=>q.status==="transferred").length;
    const percent = ((reg/cfg.size)*100).toFixed(1);
    html += `<div class="progress-block">
      <span class="progress-title">${cfg.label}:</span>
      <div class="batch-status-bar">
        <div>Registered: <b>${reg.toLocaleString()}</b></div>
        <div>Available: <b>${avail.toLocaleString()}</b></div>
        <div>Transferred: <b>${trans.toLocaleString()}</b></div>
        <div>Total: <b>${cfg.size.toLocaleString()}</b></div>
      </div>
      <div class="progress-stats"><b>${percent}%</b> Registered</div>
      ${
        cfg.nextBatch && reg<Math.ceil(cfg.size*cfg.unlockPercent)
          ? `<div class="progress-next">Next unlock: <b>${cfg.nextAmount.toLocaleString()} QR</b> when registered ≥ <b>${Math.ceil(cfg.size*cfg.unlockPercent).toLocaleString()}</b> (${(cfg.unlockPercent*100).toFixed(0)}%)</div>`
          : (cfg.nextBatch?`<div class="progress-next" style="color:#16a34a">Unlocked. Next: Batch ${cfg.nextBatch} (${cfg.nextAmount.toLocaleString()} QR)</div>`:"")
      }
    </div>`;
  });
  section.innerHTML = html;
}

function renderSummaryBar(filteredList) {
  let total = filteredList.length;
  let reg = filteredList.filter(q=>q.status==="registered").length;
  let avail = filteredList.filter(q=>q.status==="available").length;
  let trans = filteredList.filter(q=>q.status==="transferred").length;
  document.getElementById('summaryBar').innerHTML = `
    <div>Total<br><span>${total.toLocaleString()}</span></div>
    <div>Registered<br><span>${reg.toLocaleString()}</span></div>
    <div>Available<br><span>${avail.toLocaleString()}</span></div>
    <div>Transferred<br><span>${trans.toLocaleString()}</span></div>
  `;
}

function renderTable() {
  const qrTable = document.getElementById('qrTable');
  const search = (document.getElementById('searchBox')?.value || "").toLowerCase();
  let filtered = qrList.filter(q =>
      q.hash.toLowerCase().includes(search) ||
      (q.owner && q.owner.toLowerCase().includes(search)) ||
      q.status.toLowerCase().includes(search)
    );
  renderSummaryBar(filtered);
  let html = filtered.map(q => {
    return `<tr>
      <td>${q.index}</td>
      <td>${q.batch}</td>
      <td>
        <code>${q.hash}</code>
        <button class="copy-btn" title="Copy QR Hash" onclick="copyToClipboard(this,'${q.hash}')">Copy</button>
      </td>
      <td class="status-${q.status}">${q.status.charAt(0).toUpperCase()+q.status.slice(1)}</td>
      <td>
        ${q.owner ? `<code>${q.owner}</code> <button class="copy-btn" title="Copy Owner" onclick="copyToClipboard(this,'${q.owner}')">Copy</button>` : '-'}
      </td>
    </tr>`;
  }).join('');
  qrTable.innerHTML = html || `<tr><td colspan="5" style="text-align:center;color:#888;">No data found.</td></tr>`;
}

function copyToClipboard(btn, text) {
  navigator.clipboard.writeText(text).then(()=>{
    btn.classList.add('copied');
    setTimeout(()=>btn.classList.remove('copied'), 1200);
  });
}

function exportQR(type="csv") {
  let csv = "No.,Batch,QR Hash,Status,Owner\n";
  qrList.forEach(q=>{
    csv += `${q.index},${q.batch},"${q.hash}",${q.status},${q.owner||""}\n`;
  });
  if(type==="csv") {
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `dtc_qr_export_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
  } else {
    const blob = new Blob([JSON.stringify(qrList, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `dtc_qr_export_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
  }
}

function renderTimestamp() {
  document.getElementById('nowTimestamp').textContent = `UTC: ${new Date().toISOString()}`;
  setTimeout(renderTimestamp, 1000);
}

function loadData() {
  renderBatchProgress();
  renderTable();
  renderTimestamp();
}
loadData();
</script>
