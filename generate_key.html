<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate Public Key - DTC System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f7fa;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #233;
      min-height: 100vh;
    }
    .container {
      max-width: 480px;
      margin: 2.5em auto 2em auto;
      background: #fff;
      padding: 2em 1.3em 2.2em 1.3em;
      border-radius: 18px;
      box-shadow: 0 6px 32px #1771b415, 0 1.5px 5px #7ed9a340;
    }
    h2 {
      text-align: center;
      color: #2563eb;
      font-size: 1.45em;
      margin-bottom: 1.4em;
      letter-spacing: 0.01em;
      font-weight: 700;
    }
    label {
      color: #607d8b;
      font-weight: 600;
      margin-bottom: 0.22em;
      font-size: 1em;
    }
    .form-control {
      font-size: 1.07em;
      padding: 0.66em 1em;
      height: 40px;
      border-radius: 8px;
    }
    .output-box {
      background: #eafaf0;
      border-left: 5px solid #219150;
      border-radius: 8px;
      padding: 1em 0.8em;
      margin: 1em 0 0.6em 0;
      font-size: 1.02em;
      word-break: break-all;
    }
    .action-btns {
      display: flex;
      gap: 0.6em;
      margin-top: 1.1em;
      margin-bottom: 1.6em;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn-main {
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      font-size: 1.08em;
      padding: 0.65em 1.3em;
      border-radius: 9px;
      border: none;
      margin-top: 1.15em;
      width: 100%;
      transition: background 0.14s;
    }
    .btn-main:active { background: #1747a1; }
    .btn-next, .btn-home {
      min-width: 100px;
      border-radius: 8px;
      font-size: 1.07em;
    }
    .btn-next { background: #219150; color: #fff; }
    .btn-next:active { background: #176d38; }
    .btn-home { background: #f7f7fb; color: #2563eb; }
    .btn-home:active { background: #e4edff; }
    .note {
      font-size: 0.99em;
      color: #8da5b8;
      margin-top: 1em;
      text-align: center;
      margin-bottom: 0.2em;
    }
    .error-msg { color: #e74c3c; margin: 0.7em 0 0.2em 0; font-size: 0.97em;}
    @media (max-width: 600px) {
      .container { padding: 1.1em 0.15em 1.4em 0.15em; border-radius: 0; }
      h2 { font-size: 1.11em; }
      .btn-main { font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>1. Generate Public Key (DTC)</h2>
    <form id="keyForm" autocomplete="off">
      <div class="mb-3">
        <label>Password</label>
        <input type="password" id="password" class="form-control" placeholder="6-12 chars, a-z 0-9" required>
      </div>
      <div class="mb-3">
        <label>PIN</label>
        <input type="password" id="pin" class="form-control" placeholder="4-6 digits" maxlength="6" required>
      </div>
      <div id="error-msg" class="error-msg" style="display:none;"></div>
      <button type="submit" class="btn btn-main">Generate Public Key</button>
    </form>

    <div id="output" class="output-box" style="display:none;">
      <b>Public Key:</b>
      <div id="pubkey" style="word-break:break-all;font-size:1.02em; margin:0.3em 0;"></div>
      <small id="timestamp" style="color:#219150;"></small>
    </div>

    <div class="action-btns">
      <button id="copyBtn" class="btn btn-success" style="display:none;">Copy</button>
      <button id="nextBtn" class="btn btn-next" style="display:none;">Next: Register QR</button>
      <button id="homeBtn" class="btn btn-home" onclick="window.location.href='index.html'">Home</button>
    </div>
    <div class="note">
      Your public key is generated from password + PIN. <br>
      <b>To mint QR batch, return to Home.</b>
    </div>
  </div>
  <script>
    // Simple SHA-256
    async function sha256(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    // Elements
    const form = document.getElementById('keyForm');
    const outputBox = document.getElementById('output');
    const pubkeyBox = document.getElementById('pubkey');
    const timestampBox = document.getElementById('timestamp');
    const errorMsg = document.getElementById('error-msg');
    const copyBtn = document.getElementById('copyBtn');
    const nextBtn = document.getElementById('nextBtn');
    const passwordInput = document.getElementById('password');
    const pinInput = document.getElementById('pin');

    form.onsubmit = async e => {
      e.preventDefault();
      errorMsg.style.display = 'none';
      let password = passwordInput.value.trim();
      let pin = pinInput.value.trim();
      // Basic validate
      if(password.length<6 || password.length>12 || !/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = "Password: 6-12 chars, include a-z and 0-9.";
        return;
      }
      if(!/^\d{4,6}$/.test(pin)) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = "PIN: 4-6 digits.";
        return;
      }
      // Gen key logic (double hash)
      const privKey = await sha256(password + "|" + pin + "|DTC-KEY");
      const pubKey = await sha256(privKey);
      pubkeyBox.textContent = pubKey;
      const ts = new Date().toISOString();
      timestampBox.textContent = "Generated: " + ts;
      outputBox.style.display = 'block';
      copyBtn.style.display = 'inline-block';
      nextBtn.style.display = 'inline-block';
      // Save to localStorage for next step
      localStorage.setItem('dtc_publicKey', pubKey);
      localStorage.setItem('dtc_publicKey_ts', ts);
    };
    copyBtn.onclick = ()=>{
      navigator.clipboard.writeText(pubkeyBox.textContent);
      copyBtn.textContent = "Copied!";
      setTimeout(()=>{ copyBtn.textContent = "Copy"; }, 1300);
    };
    nextBtn.onclick = ()=>{
      // ไปหน้า register พร้อมนำ publicKey ไปเก็บ localStorage (อ่านต่อได้)
      window.location.href = "register.html";
    };
  </script>
</body>
</html>
