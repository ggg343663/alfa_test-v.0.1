<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generate Public Key</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f6f7fa; margin: 0; }
    .container { max-width: 450px; background: #fff; margin: 32px auto; border-radius: 15px; box-shadow: 0 2px 16px #90caf933; padding: 2.2em 1.1em 2em 1.1em;}
    h2 { text-align: center; color: #246bfd; margin-bottom: 1.3em; font-size: 1.18em; font-weight: bold;}
    .input-label { font-weight: bold; color: #2d3846; margin-bottom: 0.18em;}
    .input-row { margin-bottom: 1em; }
    .input-wrap { position: relative; }
    input[type="password"], input[type="text"] {
      width: 100%; font-size: 1.09em; border-radius: 8px; border: 1.5px solid #cfd8dc;
      padding: 0.73em 2.6em 0.73em 1em; background: #fffde7; transition: border .2s;
      margin-bottom: 0.07em; box-sizing: border-box;
    }
    input:focus { border-color: #246bfd; background: #ffffff;}
    .eye-btn {
      position: absolute; top: 0.31em; right: 0.72em; background: none; border: none;
      cursor: pointer; padding: 0; display: flex; align-items: center;
    }
    .eye-btn svg { width: 24px; height: 24px; stroke: #646a72; }
    .hint, .error, .strength-bar, .strength-text { font-size: 0.95em; }
    .hint { color: #90a4ae; margin-bottom: 0.15em; }
    .error { color: #e74c3c; margin-bottom: 0.3em; }
    .strength-bar { height: 5px; border-radius: 4px; background: #eee; margin: 2px 0 2px 0;}
    .strength-bar-inner { height: 100%; border-radius: 4px; transition: width .2s, background .2s;}
    .strength-text { margin-bottom: 0.3em; }
    .btn-main { width: 100%; font-size: 1.1em; border-radius: 8px; border: none; font-weight: bold; min-height: 42px;
      margin: 8px 0 0 0; padding: 0.75em 0; background: #2196f3; color: #fff; cursor: pointer;
      transition: background .19s; }
    .btn-main:active { background: #1769aa; }
    .btn-next {
      width: 100%; margin: 1.1em 0 0 0; color: #fff; background: #90a4ae; font-weight: bold; font-size: 1em; border: none; border-radius: 8px; padding: 0.75em 0;
      text-decoration: none; cursor: pointer;
      transition: background .19s;
      display: block;
    }
    .btn-next:disabled {
      background: #ececec;
      color: #b0bec5;
      cursor: not-allowed;
    }
    .btn-next:hover:enabled { background: #b0bec5; }
    #resultBox {
      margin-top:1.8em; border-radius:12px; background:#eafaf2; border:1.5px solid #b0dab6; padding:1.1em;
    }
    #publicKeyOut {
      width:100%; font-size:1em; background:#f5fff8; border:1.2px solid #b0dab6; border-radius:8px; padding:0.6em; margin-bottom:0.7em;
    }
    #createdAt { font-size:0.95em; color:#607d8b; margin-top:0.7em; text-align:right;}
    @media (max-width: 500px) { .container{padding:1.2em 0.2em 1.4em 0.2em;} }
  </style>
</head>
<body>
  <div class="container">
    <h2>1. Generate Public Key from Password + PIN</h2>
    <div class="input-row">
      <div class="input-label">Password:</div>
      <div class="input-wrap">
        <input id="pw" type="password" placeholder="Password (6-12 chars)" autocomplete="new-password" maxlength="12">
        <button type="button" class="eye-btn" onclick="toggleEye(this, 'pw')">
          <svg id="eye-open-pw" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
          <svg id="eye-closed-pw" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="hint">Password must be 6-12 chars, include number and letter or special character.</div>
      <div class="strength-bar"><div class="strength-bar-inner" id="pwStrengthBar"></div></div>
      <div class="strength-text" id="pwStrengthText"></div>
    </div>
    <div class="input-row">
      <div class="input-label">Confirm Password:</div>
      <div class="input-wrap">
        <input id="pw2" type="password" placeholder="Confirm Password" maxlength="12">
        <button type="button" class="eye-btn" onclick="toggleEye(this, 'pw2')">
          <svg id="eye-open-pw2" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
          <svg id="eye-closed-pw2" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="input-row">
      <div class="input-label">PIN (4 digits):</div>
      <div class="input-wrap">
        <input id="pin" type="password" maxlength="4" placeholder="PIN (4 digits)">
        <button type="button" class="eye-btn" onclick="toggleEye(this, 'pin')">
          <svg id="eye-open-pin" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
          <svg id="eye-closed-pin" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="hint">PIN should be exactly 4 digits.</div>
    </div>
    <div class="input-row">
      <div class="input-label">Confirm PIN:</div>
      <div class="input-wrap">
        <input id="pin2" type="password" maxlength="4" placeholder="Confirm PIN">
        <button type="button" class="eye-btn" onclick="toggleEye(this, 'pin2')">
          <svg id="eye-open-pin2" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
          <svg id="eye-closed-pin2" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="error" id="error" style="display:none;"></div>
    <button class="btn-main" onclick="validateAndGenerate()">Generate Key</button>
    <div id="resultBox">
      <div style="font-weight:bold; color:#166534; margin-bottom:0.3em;">Public Key:</div>
      <textarea id="publicKeyOut" readonly rows="2" placeholder="Public Key will appear here"></textarea>
      <button id="copyBtn" onclick="copyKey()" style="margin:0.8em 0.5em 0 0; background:#2196f3; color:#fff; font-weight:bold; border:none; border-radius:8px; padding:0.55em 1.5em; font-size:1em;" disabled>Copy</button>
      <button class="btn-next" id="mintBtn" onclick="gotoMintQR()" disabled>Next: Mint QR Batch</button>
      <div id="createdAt"></div>
      <div style="font-size:0.97em;color:#1565c0;margin-top:1em;">
        <b>*Your Public Key is generated deterministically from your Password and PIN.</b>
        <br>Keep your password &amp; PIN safe!<br>
        We never store or show your private key.<br>
        You can always regenerate the same public key if you enter the same info.
      </div>
    </div>
  </div>
  <script>
    function toggleEye(btn, id) {
      const input = document.getElementById(id);
      const openEye = btn.querySelector('svg[id^="eye-open"]');
      const closedEye = btn.querySelector('svg[id^="eye-closed"]');
      if (input.type === "password") {
        input.type = "text";
        openEye.style.display = "none";
        closedEye.style.display = "";
      } else {
        input.type = "password";
        openEye.style.display = "";
        closedEye.style.display = "none";
      }
    }

    document.getElementById('pw').addEventListener('input', function() {
      const val = this.value;
      let strength = 0;
      if (val.length >= 6) strength++;
      if (/[A-Za-z]/.test(val) && /\d/.test(val)) strength++;
      if (/[^A-Za-z0-9]/.test(val)) strength++;
      let percent = [0, 40, 70, 100][strength];
      let bar = document.getElementById('pwStrengthBar');
      let text = document.getElementById('pwStrengthText');
      bar.style.width = percent + "%";
      if (strength === 1) { bar.style.background="#facc15"; text.textContent="Weak"; text.style.color="#d97706";}
      else if (strength === 2) { bar.style.background="#fcd34d"; text.textContent="Medium"; text.style.color="#eab308";}
      else if (strength === 3) { bar.style.background="#4ade80"; text.textContent="Strong"; text.style.color="#16a34a";}
      else { bar.style.background="#eee"; text.textContent=""; }
    });

    // โหลดค่า public key เดิม ถ้ามี
    window.onload = function() {
      let pk = localStorage.getItem('dtc_publicKey_result') || '';
      let time = localStorage.getItem('dtc_publicKey_time') || '';
      document.getElementById('publicKeyOut').value = pk;
      document.getElementById('createdAt').textContent = time ? 'Created at: ' + time : '';
      document.getElementById('copyBtn').disabled = !pk;
      document.getElementById('mintBtn').disabled = !pk;
    };

    function validateAndGenerate() {
      const pw = document.getElementById('pw').value.trim();
      const pw2 = document.getElementById('pw2').value.trim();
      const pin = document.getElementById('pin').value.trim();
      const pin2 = document.getElementById('pin2').value.trim();
      const errorEl = document.getElementById('error');
      if (!pw || pw.length < 6 || pw.length > 12) return showErr("Password must be 6-12 chars.");
      if (!(/[A-Za-z]/.test(pw) && (/\d/.test(pw) || /[^A-Za-z0-9]/.test(pw)))) return showErr("Password must include letter + number or special char.");
      if (pw !== pw2) return showErr("Password and Confirm Password do not match.");
      if (!/^\d{4}$/.test(pin)) return showErr("PIN must be exactly 4 digits.");
      if (pin !== pin2) return showErr("PIN and Confirm PIN do not match.");
      errorEl.style.display = "none";
      // Generate deterministic Public Key (mockup)
      const publicKey = generatePublicKey(pw, pin);
      document.getElementById('publicKeyOut').value = publicKey;
      const now = new Date().toISOString();
      document.getElementById('createdAt').textContent = 'Created at: ' + now;
      // เปิดปุ่ม copy, mint
      document.getElementById('copyBtn').disabled = false;
      document.getElementById('mintBtn').disabled = false;
      // Save for next step if needed
      localStorage.setItem('dtc_publicKey_pw', pw);
      localStorage.setItem('dtc_publicKey_pin', pin);
      localStorage.setItem('dtc_publicKey_result', publicKey);
      localStorage.setItem('dtc_publicKey_time', now);
    }
    function showErr(msg) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = msg;
      errorEl.style.display = '';
      return false;
    }
    function copyKey() {
      const pk = document.getElementById('publicKeyOut').value;
      if (pk) {
        navigator.clipboard.writeText(pk);
        alert('Copied!');
      }
    }
    function gotoMintQR() {
      window.location.href = "mint_qr_batch.html";
    }
    function generatePublicKey(password, pin) {
      // *** Example only! Use real crypto for production ***
      let str = password + "|" + pin + "|dtc";
      let hash = 5381;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
        hash = hash & 0xFFFFFFFF;
      }
      // คืนค่าเป็น hex string 64 หลัก (mockup)
      return (
        Math.abs(hash).toString(16).padStart(16, "0") +
        "d4c6e7a29f" + pin +
        "b13e8"
      ).padEnd(64, "1");
    }
  </script>
</body>
</html>
