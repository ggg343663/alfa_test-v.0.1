<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Generate My Public Key - DTC: Magic Chain System</title> <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: Arial, sans-serif; background: #f6f7fa; margin: 0; }
        .container { max-width: 450px; background: #fff; margin: 32px auto; border-radius: 15px; box-shadow: 0 2px 16px rgba(144, 202, 249, 0.2); padding: 2.2em 1.1em 2em 1.1em;} /* Changed shadow color to a generic light blue */
        h2 { text-align: center; color: #219150; margin-bottom: 1.3em; font-size: 1.18em; font-weight: bold;} /* Changed heading color to green */
        .input-label { font-weight: bold; color: #2d3846; margin-bottom: 0.18em;}
        .input-row { margin-bottom: 1em; }
        .input-wrap { position: relative; }
        input[type="password"], input[type="text"] {
            width: 100%; font-size: 1.09em; border-radius: 8px; border: 1.5px solid #cfd8dc;
            padding: 0.73em 2.6em 0.73em 1em; background: #fffde7; /* Yellowish background for inputs */
            transition: border .2s;
            margin-bottom: 0.07em; box-sizing: border-box;
        }
        input:focus { border-color: #2196f3; background: #ffffff;} /* Focus border is blue */
        .eye-btn {
            position: absolute; top: 0.31em; right: 0.72em; background: none; border: none;
            cursor: pointer; padding: 0; display: flex; align-items: center;
        }
        .eye-btn svg { width: 24px; height: 24px; stroke: #646a72; }
        .hint, .error, .strength-bar, .strength-text { font-size: 0.95em; }
        .hint { color: #90a4ae; margin-bottom: 0.15em; } /* Grayish hint color */
        .error { color: #e74c3c; margin-bottom: 0.3em; }
        .strength-bar { height: 5px; border-radius: 4px; background: #eee; margin: 2px 0 2px 0;}
        .strength-bar-inner { height: 100%; border-radius: 4px; transition: width .2s, background .2s;}
        .btn-main { width: 100%; font-size: 1.1em; border-radius: 8px; border: none; font-weight: bold; min-height: 42px;
            margin: 8px 0 0 0; padding: 0.75em 0; background: #2196f3; color: #fff; cursor: pointer; /* Blue button */
            transition: background .19s; }
        .btn-main:active { background: #1769aa; }
        
        /* Public Key Result Box */
        #resultBox {
            margin-top:1.8em; border-radius:12px; background:#eafaf2; border:1.5px solid #b0dab6; padding:1.1em; /* Light green background and border */
        }
        #publicKeyOut {
            width:100%; font-size:1em; background:#f5fff8; border:1.2px solid #b0dab6; border-radius:8px; padding:0.6em; margin-bottom:0.7em; /* Lighter green for textarea background */
            box-sizing: border-box; /* Ensures padding doesn't push it out of bounds */
        }
        #publicKeyLabel { /* New style for Public Key label */
            font-weight:bold; color:#166534; margin-bottom:0.3em;
        }

        /* Timestamp styling */
        #createdAt { font-size:0.95em; color:#607d8b; margin-top:0.7em; text-align:right;}
        
        /* PIN Dots for visual feedback */
        .pin-dots {
            display: flex;
            justify-content: flex-start; /* Align dots to the left */
            margin-top: 0.5em;
            margin-bottom: 0.5em; /* Space below dots */
        }
        .pin-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #cfd8dc; /* Default gray */
            margin-right: 8px; /* Spacing between dots */
            transition: background-color 0.2s;
        }
        .pin-dot.filled {
            background-color: #2196f3; /* Blue when filled */
        }

        @media (max-width: 500px) { .container{padding:1.2em 0.2em 1.4em 0.2em;} }
    </style>
</head>
<body>
    <div class="container">
        <h2>1. Generate Public Key from Password + PIN</h2>
        
        <div class="input-row">
            <div class="input-label">Password:</div>
            <div class="input-wrap">
                <input id="pw" type="password" placeholder="Password (6-12 chars)" autocomplete="new-password" maxlength="12">
                <button type="button" class="eye-btn" onclick="toggleEye(this, 'pw')">
                    <svg id="eye-open-pw" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                    <svg id="eye-closed-pw" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                </button>
            </div>
            <div class="hint">Password must be 6-12 chars, include number and letter or special character.</div>
            <div class="strength-bar"><div class="strength-bar-inner" id="pwStrengthBar"></div></div>
            <div class="strength-text" id="pwStrengthText"></div>
        </div>
        
        <div class="input-row">
            <div class="input-label">Confirm Password:</div>
            <div class="input-wrap">
                <input id="pw2" type="password" placeholder="Confirm Password" maxlength="12">
                <button type="button" class="eye-btn" onclick="toggleEye(this, 'pw2')">
                    <svg id="eye-open-pw2" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                    <svg id="eye-closed-pw2" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-label">PIN (4 digits):</div>
            <div class="input-wrap">
                <input id="pin" type="password" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="PIN (4 digits)"> <button type="button" class="eye-btn" onclick="toggleEye(this, 'pin')">
                    <svg id="eye-open-pin" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                    <svg id="eye-closed-pin" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                </button>
            </div>
            <div class="pin-dots" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="hint">PIN should be exactly 4 digits.</div>
        </div>
        
        <div class="input-row">
            <div class="input-label">Confirm PIN:</div>
            <div class="input-wrap">
                <input id="pin2" type="password" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="Confirm PIN">
                <button type="button" class="eye-btn" onclick="toggleEye(this, 'pin2')">
                    <svg id="eye-open-pin2" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                    <svg id="eye-closed-pin2" style="display:none;" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M17.94 17.94A10.96 10.96 0 0 1 12 19c-7 0-10.5-7-10.5-7a21.8 21.8 0 0 1 5.05-6.44m4.64-2.17c7 0 10.5 7 10.5 7a21.74 21.74 0 0 1-3.14 4.1M2 2l20 20" stroke="currentColor"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="error" id="error" style="display:none;"></div>
        <button class="btn-main" onclick="validateAndGenerate()">Generate Key</button>
        
        <div id="resultBox">
            <div id="publicKeyLabel">Public Key:</div> <textarea id="publicKeyOut" readonly rows="2" placeholder="Public Key will appear here"></textarea>
            <button id="copyBtn" onclick="copyKey()" style="margin:0.8em 0.5em 0 0; background:#2196f3; color:#fff; font-weight:bold; border:none; border-radius:8px; padding:0.55em 1.5em; font-size:1em;" disabled>Copy</button>
            <div class="hint" style="margin:0.5em 0 0 0; color:#90a4ae;">
                Copy your public key and use it in any DTC screen (Generate QR, Register, Audit, etc.)
            </div>
            <div id="createdAt"></div>
            <div style="font-size:0.97em;color:#1565c0;margin-top:1em;">
                <b>*Your Public Key is generated deterministically from your Password and PIN.</b>
                <br>Keep your password &amp; PIN safe!<br>
                We never store or show your private key.<br>
                You can always regenerate the same public key if you enter the same info.
            </div>
        </div>
    </div>
    
    <script>
        // Toggle password visibility
        function toggleEye(btn, id) {
            const input = document.getElementById(id);
            const openEye = btn.querySelector('svg[id^="eye-open"]');
            const closedEye = btn.querySelector('svg[id^="eye-closed"]');
            if (input.type === "password") {
                input.type = "text";
                openEye.style.display = "none";
                closedEye.style.display = "";
            } else {
                input.type = "password";
                openEye.style.display = "";
                closedEye.style.display = "none";
            }
        }

        // Password strength checker
        document.getElementById('pw').addEventListener('input', function() {
            const val = this.value;
            let strength = 0;
            // Criteria: length (6-12), letters + numbers/special chars
            if (val.length >= 6) strength++;
            if (/[A-Za-z]/.test(val) && (/\d/.test(val) || /[^A-Za-z0-9]/.test(val))) strength++; // Letter + (Number OR Special Char)
            if (val.length >= 10 && (/[A-Z]/.test(val) && /[a-z]/.test(val) && /\d/.test(val) && /[^A-Za-z0-9]/.test(val))) strength++; // Stronger criteria for strength 3

            let percent = [0, 40, 70, 100][strength];
            let bar = document.getElementById('pwStrengthBar');
            let text = document.getElementById('pwStrengthText');
            bar.style.width = percent + "%";
            if (strength === 1) { bar.style.background="#facc15"; text.textContent="Weak"; text.style.color="#d97706";}
            else if (strength === 2) { bar.style.background="#fcd34d"; text.textContent="Medium"; text.style.color="#eab308";}
            else if (strength === 3) { bar.style.background="#4ade80"; text.textContent="Strong"; text.style.color="#16a34a";}
            else { bar.style.background="#eee"; text.textContent=""; }
        });

        // PIN visual feedback
        document.getElementById('pin').addEventListener('input', function() {
            const pinValue = this.value;
            const pinDots = document.querySelectorAll('#pinDots .pin-dot');
            pinDots.forEach((dot, index) => {
                if (index < pinValue.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            });
            // Ensure only digits are entered for PIN
            this.value = pinValue.replace(/\D/g, '');
        });

        // Update real-time timestamp display
        function updateRealtimeTimestamp() {
            const createdAtEl = document.getElementById('createdAt');
            // Only update if public key is not generated yet, otherwise show fixed generated time
            if (!localStorage.getItem('dtc_publicKey_result')) {
                 createdAtEl.textContent = 'Current Time: ' + new Date().toISOString().slice(0, 19).replace('T', ' '); // YYYY-MM-DD HH:MM:SS
            }
        }

        // Load existing public key on page load and start real-time clock
        window.onload = function() {
            let pk = localStorage.getItem('dtc_publicKey_result') || '';
            let time = localStorage.getItem('dtc_publicKey_time') || '';
            document.getElementById('publicKeyOut').value = pk;
            document.getElementById('copyBtn').disabled = !pk;
            
            const createdAtEl = document.getElementById('createdAt');
            if (pk) {
                createdAtEl.textContent = 'Generated at: ' + time;
            } else {
                createdAtEl.textContent = 'Current Time: –'; // Initial state for current time
            }
            // Start updating current time every second if no key is generated yet
            setInterval(updateRealtimeTimestamp, 1000);
            updateRealtimeTimestamp(); // Call once immediately to show current time
        };

        function validateAndGenerate() {
            const pw = document.getElementById('pw').value.trim();
            const pw2 = document.getElementById('pw2').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const pin2 = document.getElementById('pin2').value.trim();
            const errorEl = document.getElementById('error');

            // Password Validation
            if (!pw || pw.length < 6 || pw.length > 12) return showErr("Password must be 6-12 characters.");
            if (!(/[A-Za-z]/.test(pw) && (/\d/.test(pw) || /[^A-Za-z0-9]/.test(pw)))) return showErr("Password must include letter + number or special character.");
            if (pw !== pw2) return showErr("Password and Confirm Password do not match.");

            // PIN Validation
            if (!/^\d{4}$/.test(pin)) return showErr("PIN must be exactly 4 digits.");
            if (pin !== pin2) return showErr("PIN and Confirm PIN do not match.");
            
            errorEl.style.display = "none";
            
            // Generate deterministic Public Key (mockup)
            const publicKey = generatePublicKey(pw, pin);
            document.getElementById('publicKeyOut').value = publicKey;
            
            const now = new Date().toISOString().slice(0, 19).replace('T', ' '); // YYYY-MM-DD HH:MM:SS
            document.getElementById('createdAt').textContent = 'Generated at: ' + now;
            document.getElementById('copyBtn').disabled = false;
            
            // Store results in localStorage
            localStorage.setItem('dtc_publicKey_pw', pw); // For demonstration, in real app, never store passwords
            localStorage.setItem('dtc_publicKey_pin', pin); // For demonstration, in real app, never store PINs
            localStorage.setItem('dtc_publicKey_result', publicKey);
            localStorage.setItem('dtc_publicKey_time', now);
        }

        function showErr(msg) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = msg;
            errorEl.style.display = '';
            return false;
        }

        function copyKey() {
            const pk = document.getElementById('publicKeyOut').value;
            if (pk) {
                navigator.clipboard.writeText(pk);
                alert('Copied Public Key!');
            }
        }

        // Mockup Public Key Generation (DO NOT USE IN PRODUCTION)
        // This is a simplified hash function for demonstration.
        // In a real application, you would use a robust cryptographic library
        // to derive keys, e.g., using Web Crypto API or a library like 'js-sha256'
        // combined with a Key Derivation Function (KDF) like PBKDF2 or scrypt
        // to make it computationally expensive to brute-force.
        function generatePublicKey(password, pin) {
            // Simplified hashing for demonstration purposes.
            // In a real system, you would use a secure cryptographic hash function
            // like SHA-256 and a Key Derivation Function (KDF) for password/PIN.
            // For example:
            // const combinedInput = password + pin;
            // const hashBytes = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(combinedInput));
            // return Array.from(new Uint8Array(hashBytes)).map(b => b.toString(16).padStart(2, '0')).join('');
            
            let str = password + pin + "dtc_salt_v1"; // Added a simple salt
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char; // Simple hash algorithm
                hash |= 0; // Convert to 32bit integer
            }
            // Return a fixed length hex string (mockup)
            // Simulates a 64-character (256-bit) public key representation
            return (Math.abs(hash).toString(16) + "publickeydtc" + Math.random().toString(36).substring(2, 10)).padEnd(64, '0').substring(0, 64);
        }
    </script>
</body>
</html>
