<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Master Unlock QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fafd; padding: 2em; }
    .container {
      background: #fff;
      padding: 2em 1.3em;
      max-width: 430px;
      margin: auto;
      border-radius: 15px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.08);
    }
    h2 { text-align: center; margin-bottom: 1.2em; color: #3734a9;}
    .batch-info {
      background: #f1f8ff;
      border-left: 6px solid #2d92fa;
      border-radius: 10px;
      padding: 1em 1.1em 1em 1.3em;
      margin-bottom: 1.6em;
      font-size: 1.08em;
      color: #264f73;
      line-height: 1.65;
    }
    .batch-next {
      background: #fff9e6;
      border-left: 6px solid #eab308;
      border-radius: 8px;
      padding: 0.8em 1em;
      margin-bottom: 1.4em;
      font-size: 1em;
      color: #845600;
    }
    label { display: block; margin-top: 1em; font-weight: 600;}
    input { width: 100%; margin-top: 0.36em; padding: 0.52em 0.7em; font-size: 1em; border-radius: 7px; border: 1px solid #cfd9ec;}
    button {
      width: 100%; margin-top: 1.4em; padding: 0.7em 0; font-size: 1.06em;
      background: linear-gradient(90deg, #6366f1, #22d3ee);
      color: #fff; border: none; border-radius: 8px; font-weight: bold;
      letter-spacing: 0.01em; cursor: pointer; transition: background 0.18s;
    }
    button:hover { background: linear-gradient(90deg, #22d3ee, #6366f1);}
    .btn-back { background: #dbeafe; color: #324275; margin-top: 1.2em;}
    .btn-back:hover { background: #bae6fd;}
    #status { margin-top: 1.5em; font-size: 1em; text-align: center; white-space: pre-wrap;}
    .error { color: #d93025;}
    .success { color: #1a7300;}
    .divider { margin: 1.6em 0 1em; border-top: 1px solid #e3e3ef; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Master Unlock QR</h2>

    <!-- Batch/Unlock Status Section -->
    <div class="batch-info" id="batchInfo">
      <b>Current Batch:</b> <span id="batchName">alpha (Set 1)</span><br>
      <b>QR registered:</b> <span id="registeredCount">50</span> / <span id="totalCount">100</span> <br>
      <b>Unlocked:</b> <span id="unlockedCount">0</span> <br>
      <b>Unlock condition:</b> Register at least <b>50%</b> (50/100) before normal QR unlock is available.
    </div>
    <div class="batch-next" id="nextBatchInfo">
      Next batch unlock: <b>2,000 QR</b> when the current batch is <b>fully registered</b> or at least <b>50%</b> completed.
    </div>

    <form id="masterUnlockForm" autocomplete="off">
      <label for="amount">Number of QR to unlock:</label>
      <input type="number" id="amount" min="1" max="50" value="1" required />

      <label for="pw1">Password (6-12 letters & numbers):</label>
      <input type="password" id="pw1" maxlength="12" minlength="6" placeholder="Password" required autocomplete="off" />

      <label for="pw2">Confirm Password:</label>
      <input type="password" id="pw2" maxlength="12" minlength="6" placeholder="Confirm Password" required autocomplete="off" />

      <label for="sign1">4-digit Sign Code:</label>
      <input type="password" id="sign1" maxlength="4" minlength="4" pattern="\d{4}" placeholder="Sign Code" required autocomplete="off" />

      <label for="sign2">Confirm 4-digit Sign Code:</label>
      <input type="password" id="sign2" maxlength="4" minlength="4" pattern="\d{4}" placeholder="Confirm Sign Code" required autocomplete="off" />

      <button type="submit">Unlock QR</button>
    </form>
    <div id="status"></div>
    <button class="btn-back" onclick="window.history.back()">← Back</button>
  </div>

  <script>
    // MOCK DATA, replace with fetch('batch_status.json').then(...) if needed
    const batchStatus = {
      name: "alpha (Set 1)",
      total: 100,
      registered: 50,
      unlocked: 0,
      unlockable: 50 // 100*50% = 50
    };

    // Populate batch info
    document.getElementById('batchName').textContent = batchStatus.name;
    document.getElementById('registeredCount').textContent = batchStatus.registered;
    document.getElementById('totalCount').textContent = batchStatus.total;
    document.getElementById('unlockedCount').textContent = batchStatus.unlocked;
    // Limit unlock number to remaining (e.g., not more than unlockable)
    document.getElementById('amount').max = batchStatus.unlockable;

    function validatePassword(pw) {
      return (
        pw.length >= 6 &&
        pw.length <= 12 &&
        /[A-Za-z]/.test(pw) &&
        /\d/.test(pw)
      );
    }

    document.getElementById('masterUnlockForm').onsubmit = function(e) {
      e.preventDefault();
      const pw1 = this.pw1.value.trim();
      const pw2 = this.pw2.value.trim();
      const sign1 = this.sign1.value.trim();
      const sign2 = this.sign2.value.trim();
      const amount = parseInt(this.amount.value, 10);
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = "";
      statusDiv.className = "";

      if (!validatePassword(pw1)) {
        statusDiv.textContent = "Password must be 6-12 characters with both letters and numbers.";
        statusDiv.className = "error";
        return;
      }
      if (pw1 !== pw2) {
        statusDiv.textContent = "Passwords do not match.";
        statusDiv.className = "error";
        return;
      }
      if (!/^\d{4}$/.test(sign1)) {
        statusDiv.textContent = "Sign code must be 4 digits.";
        statusDiv.className = "error";
        return;
      }
      if (sign1 !== sign2) {
        statusDiv.textContent = "Sign codes do not match.";
        statusDiv.className = "error";
        return;
      }
      if (isNaN(amount) || amount < 1 || amount > batchStatus.unlockable) {
        statusDiv.textContent = `Number of QR must be a positive integer (max ${batchStatus.unlockable}).`;
        statusDiv.className = "error";
        return;
      }

      // Use: SHA256(password + sign + number_of_QR)
      const sig = sha256(pw1 + sign1 + amount);

      statusDiv.innerHTML =
        `<span class="success">✅ Unlocked ${amount} QR codes successfully!</span>\nSignature (SHA256): <code>${sig}</code>`;
      statusDiv.className = "success";
      // TODO: submit to backend or further process
    };
  </script>
</body>
</html>
