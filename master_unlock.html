<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Master Unlock QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fafd; padding: 2em; }
    .container {
      background: #fff;
      padding: 2em 1.3em;
      max-width: 430px;
      margin: auto;
      border-radius: 15px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.08);
    }
    h2 { text-align: center; margin-bottom: 1.1em; color: #3734a9;}
    label { display: block; margin-top: 1em; font-weight: 600;}
    input, select { width: 100%; margin-top: 0.36em; padding: 0.52em 0.7em; font-size: 1em; border-radius: 7px; border: 1px solid #cfd9ec;}
    button {
      width: 100%; margin-top: 1.3em; padding: 0.7em 0; font-size: 1.05em;
      background: linear-gradient(90deg, #6366f1, #22d3ee);
      color: #fff; border: none; border-radius: 8px; font-weight: bold;
      letter-spacing: 0.01em; cursor: pointer; transition: background 0.18s;
    }
    button:hover { background: linear-gradient(90deg, #22d3ee, #6366f1);}
    .btn-back { background: #dbeafe; color: #324275; margin-top: 1.2em;}
    .btn-back:hover { background: #bae6fd;}
    #status { margin-top: 1.5em; font-size: 1em; text-align: center; white-space: pre-wrap;}
    .error { color: #d93025;}
    .success { color: #1a7300;}
    /* Batch info & progress */
    .batch-info {
      background: #f1f8ff;
      border-left: 6px solid #2d92fa;
      border-radius: 10px;
      padding: 1em 1.1em 1em 1.3em;
      margin-bottom: 1.25em;
      font-size: 1.06em;
      color: #264f73;
      line-height: 1.65;
    }
    .batch-next {
      background: #fff9e6;
      border-left: 6px solid #eab308;
      border-radius: 8px;
      padding: 0.7em 1em;
      margin-bottom: 1.4em;
      font-size: 1em;
      color: #845600;
    }
    .progressbar {
      background:#e4eaf2;
      border-radius:7px;
      overflow:hidden;
      margin:0.45em 0 0.6em 0;
      height:11px;
    }
    .progressbar-inner {
      height:11px;
      background:#6366f1;
      transition:width 0.3s;
      border-radius:7px 0 0 7px;
    }
    @media(max-width:600px){
      .container{padding:1em 0.3em;}
      .btn-back { width: 100%; position: static; margin-bottom: 1em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Master Unlock QR</h2>

    <!-- Batch Selection -->
    <label for="batchSelect" style="margin-bottom:0.4em;">Select Batch:</label>
    <select id="batchSelect">
      <option value="alpha">alpha (Set 1)</option>
      <option value="beta">beta (Set 2)</option>
      <option value="gamma">gamma (Set 3)</option>
    </select>

    <!-- Batch/Unlock Status Section -->
    <div class="batch-info" id="batchInfo">
      <b>Current Batch:</b> <span id="batchName"></span><br>
      <b>QR registered:</b> <span id="registeredCount"></span> / <span id="totalCount"></span> <br>
      <b>Unlocked:</b> <span id="unlockedCount"></span> <br>
      <b>Unlock condition:</b>
      <span id="unlockCondition"></span>
      <div class="progressbar"><div id="regProgress" class="progressbar-inner" style="width:0%"></div></div>
    </div>
    <div class="batch-next" id="nextBatchInfo">
      Next batch unlock: <b>2,000 QR</b> when the current batch is <b>fully registered</b> or at least <b>50%</b> completed.
    </div>

    <form id="masterUnlockForm" autocomplete="off">
      <label for="amount">Number of QR to unlock:</label>
      <input type="number" id="amount" min="1" value="1" required />

      <label for="pw1">Password (6-12 letters & numbers):</label>
      <input type="password" id="pw1" maxlength="12" minlength="6" placeholder="Password" required autocomplete="off" />

      <label for="pw2">Confirm Password:</label>
      <input type="password" id="pw2" maxlength="12" minlength="6" placeholder="Confirm Password" required autocomplete="off" />

      <label for="sign1">4-digit Sign Code:</label>
      <input type="password" id="sign1" maxlength="4" minlength="4" pattern="\d{4}" placeholder="Sign Code" required autocomplete="off" />

      <label for="sign2">Confirm 4-digit Sign Code:</label>
      <input type="password" id="sign2" maxlength="4" minlength="4" pattern="\d{4}" placeholder="Confirm Sign Code" required autocomplete="off" />

      <button type="submit">Unlock QR</button>
    </form>
    <div id="status"></div>
    <button class="btn-back" onclick="window.history.back()">← Back</button>
  </div>

  <script>
    // All batch data (replace/mock with fetch as needed)
    const allBatches = {
      alpha: { name: "alpha (Set 1)", total: 100, registered: 50, unlocked: 0, unlockable: 50 },
      beta:  { name: "beta (Set 2)",  total: 2000, registered: 1111, unlocked: 0, unlockable: 889 },
      gamma: { name: "gamma (Set 3)", total: 2000, registered: 0, unlocked: 0, unlockable: 0 }
    };
    let batchStatus = allBatches.alpha;

    document.getElementById('batchSelect').onchange = function() {
      batchStatus = allBatches[this.value];
      updateBatchDisplay();
      document.getElementById('status').textContent = ""; // clear old status
    };

    function updateBatchDisplay() {
      document.getElementById('batchName').textContent = batchStatus.name;
      document.getElementById('registeredCount').textContent = batchStatus.registered;
      document.getElementById('totalCount').textContent = batchStatus.total;
      document.getElementById('unlockedCount').textContent = batchStatus.unlocked;

      // unlock condition display
      let unlockCond = "";
      if (batchStatus.total === 100) {
        unlockCond = `Register at least <b>50%</b> (${Math.floor(batchStatus.total/2)}/${batchStatus.total}) before normal QR unlock is available.`;
      } else {
        unlockCond = `Batch unlocks every <b>2,000 QR</b>, when at least <b>50%</b> registered.`;
      }
      document.getElementById('unlockCondition').innerHTML = unlockCond;

      document.getElementById('amount').max = batchStatus.unlockable;
      document.getElementById('regProgress').style.width = ((batchStatus.registered/batchStatus.total)*100) + "%";

      // next batch info
      if (batchStatus.total === 100) {
        document.getElementById('nextBatchInfo').innerHTML =
          `Next batch unlock: <b>2,000 QR</b> when the current batch is <b>fully registered</b> or at least <b>50%</b> completed.`;
      } else {
        document.getElementById('nextBatchInfo').innerHTML =
          `Next batch unlock: <b>2,000 QR</b> for each new batch after reaching registration threshold.`;
      }
    }
    window.onload = updateBatchDisplay;

    function validatePassword(pw) {
      return (
        pw.length >= 6 &&
        pw.length <= 12 &&
        /[A-Za-z]/.test(pw) &&
        /\d/.test(pw)
      );
    }

    document.getElementById('masterUnlockForm').onsubmit = function(e) {
      e.preventDefault();
      const pw1 = this.pw1.value.trim();
      const pw2 = this.pw2.value.trim();
      const sign1 = this.sign1.value.trim();
      const sign2 = this.sign2.value.trim();
      const amount = parseInt(this.amount.value, 10);
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = "";
      statusDiv.className = "";

      if (!validatePassword(pw1)) {
        statusDiv.textContent = "Password must be 6-12 characters with both letters and numbers.";
        statusDiv.className = "error";
        return;
      }
      if (pw1 !== pw2) {
        statusDiv.textContent = "Passwords do not match.";
        statusDiv.className = "error";
        return;
      }
      if (!/^\d{4}$/.test(sign1)) {
        statusDiv.textContent = "Sign code must be 4 digits.";
        statusDiv.className = "error";
        return;
      }
      if (sign1 !== sign2) {
        statusDiv.textContent = "Sign codes do not match.";
        statusDiv.className = "error";
        return;
      }
      if (isNaN(amount) || amount < 1 || amount > batchStatus.unlockable) {
        statusDiv.textContent = `Number of QR must be a positive integer (max ${batchStatus.unlockable}).`;
        statusDiv.className = "error";
        return;
      }

      // Use: SHA256(password + sign + number_of_QR)
      const sig = sha256(pw1 + sign1 + amount);

      // update mock data for demo
      batchStatus.unlocked += amount;
      batchStatus.unlockable -= amount;
      updateBatchDisplay();

      let notice = "";
      if (batchStatus.unlocked === batchStatus.total) {
        notice = "<br><b style='color:#b58900;'>This batch is now fully unlocked!</b>";
      }
      statusDiv.innerHTML =
        `<span class="success">✅ Unlocked ${amount} QR codes successfully!</span>
         <br>Signature (SHA256): <code>${sig}</code>${notice}`;
      statusDiv.className = "success";
    };
  </script>
</body>
</html>
