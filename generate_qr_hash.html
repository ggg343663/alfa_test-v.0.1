<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate QR Hash - DTC: Magic Chain System</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 2em auto; padding: 1em; background: #f5f7fa; color: #333; }
    h1 { text-align: center; color: #219150; }
    .section-block { margin: 1.1em 0; padding: 1em; border-radius: 12px; box-shadow: 0 2px 9px #edf1f6; background: #fff; }
    label { font-weight: bold; margin-top: 1em; display: block; }
    input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 0.7em; margin: 0.5em 0 1em 0; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
    .hint { font-size: 0.92em; color: #777; margin-bottom: 1em; }
    .info-bar { text-align: center; margin-bottom: 1.1em; font-size: 1em; color: #555; }
    .info-bar span { font-weight: bold; color: #219150; margin: 0 0.3em; }
    .quantity-options { display: flex; gap: 0.8em; justify-content: center; margin-bottom: 1em; }
    .quantity-options button { padding: 0.8em 1.2em; border: 1px solid #ccc; border-radius: 5px; background: #f0f0f0; cursor: pointer; font-size: 1em; transition: background 0.2s, border-color 0.2s; }
    .quantity-options button.selected { background: #2196f3; color: #fff; border-color: #2196f3; }
    .quantity-options button:disabled { opacity: 0.4; cursor: not-allowed; }
    .main-button { width: 100%; padding: 1em 0; margin: 1.4em 0 1em 0; color: #fff; font-weight: bold; border: none; border-radius: 8px; font-size: 1.15em; background: #2196f3; cursor: pointer; transition: background 0.13s; }
    .main-button:disabled { background: #b0d8f7; cursor: not-allowed; }
    .preview-section { background: #e7f4ea; border: 1px solid #b0d9ca; border-radius: 6px; padding: 1em; margin: 1.5em 0 1em 0; }
    .preview-title { font-weight: bold; color: #297f43; margin-bottom: 0.6em; }
    .preview-hash { font-size: 1.05em; word-break: break-all; margin: 0.25em 0 0.9em 0;}
    .audit-action-buttons { display: flex; gap: 1em; margin-top: 1em;}
    .audit-action-buttons button { flex: 1; padding: 0.8em 0.5em; border: none; border-radius: 8px; font-size: 1.09em; font-weight: bold; color: #fff; cursor: pointer; transition: background 0.13s;}
    .exit-btn { background: #dc3545; }
    .commit-btn { background: #28a745; }
    .copy-btn { padding: 0.5em 0.8em; margin-left: 1em; border-radius: 5px; border: none; background: #2196f3; color: #fff; font-weight: bold; cursor: pointer; }
    .copy-btn:hover { background: #1976d2; }
    @media (max-width: 600px) { body { margin: 0.5em; padding: 0.09em; } .section-block { padding: 0.7em 0.25em;} .main-button { font-size: 1.04em; } }
  </style>
</head>
<body>
  <h1>Generate QR Hash (Double Hash Function)</h1>
  <div class="info-bar">
    Role: <span id="role-display">Normal</span> |
    Quota: <span id="quota-display">1000</span> |
    Status: <span id="status-display">Available</span>
  </div>

  <div id="mint-section">
    <div class="section-block">
      <label for="publicKeyInput">Public Key</label>
      <input type="text" id="publicKeyInput" placeholder="Paste your public key">
      <div class="hint">Use the public key from the "Generate Key" page (64 hex).</div>
    </div>
    <div class="section-block">
      <label for="qrQuantityInput">Quantity (QTY)</label>
      <input type="number" id="qrQuantityInput" value="1" min="1" max="5000">
      <div class="quantity-options">
        <button onclick="selectQuantity(1)">1</button>
        <button onclick="selectQuantity(100)">100</button>
        <button onclick="selectQuantity(500)">500</button>
        <button onclick="selectQuantity(1000)">1000</button>
        <button onclick="selectQuantity(3000)">3000</button>
        <button onclick="selectQuantity(5000)">5000</button>
      </div>
      <div class="hint" id="quota-hint"></div>
    </div>
    <div class="section-block">
      <label for="secretInput">Secret (4 a-z, for minting only)</label>
      <input type="password" id="secretInput" placeholder="e.g. abcd" maxlength="4">
      <label for="confirmSecretInput">Confirm Secret</label>
      <input type="password" id="confirmSecretInput" placeholder="Re-enter secret" maxlength="4">
      <div class="hint">You must enter the same secret both times. Keep it safe for future regen.</div>
    </div>
    <button class="main-button" id="generateBtn" onclick="generatePreview()">Generate QR Batch</button>
  </div>

  <div class="preview-section" id="previewSection" style="display:none;">
    <div class="preview-title">Preview QR Batch (Double Hash)</div>
    <div><b>hash1:</b> <span class="preview-hash" id="hash1Preview"></span>
      <button class="copy-btn" onclick="copyHash('hash1Preview')">Copy</button>
    </div>
    <div><b>hash2:</b> <span class="preview-hash" id="hash2Preview"></span>
      <button class="copy-btn" onclick="copyHash('hash2Preview')">Copy</button>
    </div>
    <div class="audit-action-buttons">
      <button class="exit-btn" onclick="resetForm()">Exit</button>
      <button class="commit-btn" onclick="commitBatch()">Commit</button>
    </div>
  </div>

  <script>
    // CONFIG
    let userRole = 'Normal'; // 'Normal', 'Agent', 'Master'
    let userQuota = 1000;
    let userFirstMint = true; // Set to false after first commit (sync with backend in real system)

    function updateQuotaDisplay() {
      document.getElementById('role-display').textContent = userRole;
      if (userRole === 'Master' || userRole === 'Agent') {
        document.getElementById('quota-display').textContent = 'Unlimited';
        document.getElementById('status-display').textContent = 'Available';
      } else {
        document.getElementById('quota-display').textContent = userQuota;
        document.getElementById('status-display').textContent = (userQuota > 0 ? 'Available' : 'Not Available');
      }
      applyMintingPermissions();
    }

    function applyMintingPermissions() {
      let qtyInput = document.getElementById('qrQuantityInput');
      let generateBtn = document.getElementById('generateBtn');
      let quantityButtons = document.querySelectorAll('.quantity-options button');

      if (userRole === 'Normal') {
        if (userFirstMint) {
          qtyInput.value = 1;
          qtyInput.disabled = true;
          quantityButtons.forEach(btn => btn.disabled = (parseInt(btn.textContent) !== 1));
          generateBtn.disabled = false;
        } else {
          // สมมติให้ mint รอบต่อไปได้ตาม quota (เพิ่ม logic ดึง quota ใหม่ตรงนี้)
          qtyInput.disabled = false;
          quantityButtons.forEach(btn => btn.disabled = (parseInt(btn.textContent) > userQuota));
          generateBtn.disabled = false;
        }
      } else if (userRole === 'Master') {
        qtyInput.disabled = false;
        quantityButtons.forEach(btn => btn.disabled = false);
        generateBtn.disabled = false;
      } else if (userRole === 'Agent') {
        // ตัวอย่าง agentQuota = 5000;
        let agentQuota = 5000;
        qtyInput.max = agentQuota;
        qtyInput.disabled = false;
        quantityButtons.forEach(btn => btn.disabled = (parseInt(btn.textContent) > agentQuota));
        generateBtn.disabled = false;
      }
    }

    function selectQuantity(qty) {
      document.getElementById('qrQuantityInput').value = qty;
      highlightSelectedQty(qty);
      validateQty();
    }

    function highlightSelectedQty(qty) {
      let buttons = document.querySelectorAll('.quantity-options button');
      buttons.forEach(btn => {
        if (parseInt(btn.textContent) === qty) btn.classList.add('selected');
        else btn.classList.remove('selected');
      });
    }

    function validateQty() {
      let qty = parseInt(document.getElementById('qrQuantityInput').value);
      let generateBtn = document.getElementById('generateBtn');
      let quotaHint = document.getElementById('quota-hint');
      if ((userRole !== 'Master' && userRole !== 'Agent') && qty > userQuota) {
        generateBtn.disabled = true;
        quotaHint.textContent = 'Selected QTY exceeds your available quota.';
      } else {
        generateBtn.disabled = false;
        quotaHint.textContent = '';
      }
    }

    function isValidPubKey(key) {
      return /^[a-f0-9]{64}$/i.test(key.trim());
    }

    document.getElementById('qrQuantityInput').addEventListener('input', validateQty);

    function generatePreview() {
      let pubkey = document.getElementById('publicKeyInput').value.trim();
      let qty = parseInt(document.getElementById('qrQuantityInput').value);
      let secret = document.getElementById('secretInput').value;
      let confirmSecret = document.getElementById('confirmSecretInput').value;

      if (!isValidPubKey(pubkey)) {
        alert('Invalid public key format.');
        return;
      }
      if (!/^[a-z]{4}$/.test(secret) || secret !== confirmSecret) {
        alert('Secret must be 4 lowercase a-z and match both fields.');
        return;
      }
      if (userRole === 'Normal' && userFirstMint && qty !== 1) {
        alert('First mint must be 1 QR.');
        return;
      }
      if (isNaN(qty) || qty < 1 || ((userRole !== 'Master' && userRole !== 'Agent') && qty > userQuota)) {
        alert('Invalid or excessive QTY.');
        return;
      }

      let hash1 = sha256(pubkey + qty + secret);
      let meta = (new Date().toISOString());
      let hash2 = sha256(hash1 + meta);

      document.getElementById('hash1Preview').textContent = hash1;
      document.getElementById('hash2Preview').textContent = hash2;

      document.getElementById('mint-section').style.display = 'none';
      document.getElementById('previewSection').style.display = 'block';
    }

    function resetForm() {
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('secretInput').value = '';
      document.getElementById('confirmSecretInput').value = '';
      document.getElementById('mint-section').style.display = 'block';
    }

    function commitBatch() {
      alert('Committed QR Batch!\nhash1 and hash2 saved to ledger/log.');
      // ถ้า userRole == 'Normal' และ mint แรก ให้เปลี่ยน firstMint เป็น false และลด quota
      if (userRole === 'Normal' && userFirstMint) {
        userFirstMint = false;
        userQuota -= 1; // กรณี quota ลดลงตาม mint
        if (userQuota < 0) userQuota = 0;
      }
      updateQuotaDisplay();
      resetForm();
    }

    function copyHash(elementId) {
      const element = document.getElementById(elementId);
      const textToCopy = element.textContent;
      navigator.clipboard.writeText(textToCopy)
        .then(() => { alert(`Copied "${textToCopy}" to clipboard!`); })
        .catch(err => { alert('Failed to copy.'); });
    }

    function sha256(str) {
      let h = 0, l = str.length;
      for(let i = 0; i < l; i++) { h = Math.imul(31, h) + str.charCodeAt(i) | 0; }
      return (h >>> 0).toString(16).padStart(8, '0').repeat(8).substr(0, 64);
    }

    // Init
    updateQuotaDisplay();
  </script>
</body>
</html>
