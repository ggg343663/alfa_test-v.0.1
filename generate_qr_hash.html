<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate QR Hash - DTC: Magic Chain System</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 2em auto; padding: 1em; background: #f5f7fa; color: #333; }
    h1 { text-align: center; color: #219150; }
    .section-block { margin: 1.1em 0; padding: 1em; border-radius: 12px; box-shadow: 0 2px 9px #edf1f6; background: #fff; }
    label { font-weight: bold; margin-top: 1em; display: block; }
    input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 0.7em; margin: 0.5em 0 1em 0; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
    input:disabled { background-color: #e9ecef; opacity: 0.6; cursor: not-allowed; } /* Added disabled style for inputs */
    .hint { font-size: 0.92em; color: #777; margin-bottom: 1em; }
    .info-bar { text-align: center; margin-bottom: 1.1em; font-size: 1em; color: #555; }
    .info-bar span { font-weight: bold; color: #219150; margin: 0 0.3em; }
    .quantity-options { display: flex; flex-wrap: wrap; gap: 0.8em; justify-content: center; margin-bottom: 1em; } /* Added flex-wrap */
    .quantity-options button { padding: 0.8em 1.2em; border: 1px solid #ccc; border-radius: 5px; background: #f0f0f0; cursor: pointer; font-size: 1em; transition: background 0.2s, border-color 0.2s, opacity 0.2s; }
    .quantity-options button.selected { background: #2196f3; color: #fff; border-color: #2196f3; }
    .quantity-options button:disabled { opacity: 0.4; cursor: not-allowed; background: #f0f0f0; border-color: #ccc; color: #777; } /* Improved disabled button style */
    .quantity-options button.selected:disabled { background: #89c5f8; color: #eee; } /* Selected button when disabled */

    .main-button { width: 100%; padding: 1em 0; margin: 1.4em 0 1em 0; color: #fff; font-weight: bold; border: none; border-radius: 8px; font-size: 1.15em; background: #2196f3; cursor: pointer; transition: background 0.13s; box-shadow: 0 2px 7px rgba(33,150,243,0.3); } /* Added box-shadow */
    .main-button:hover:not(:disabled) { filter: brightness(0.93); } /* Added hover for not disabled */
    .main-button:disabled { background: #b0d8f7; opacity: 0.6; cursor: not-allowed; } /* Added opacity */

    .preview-section { background: #e7f4ea; border: 1px solid #b0d9ca; border-radius: 6px; padding: 1em; margin: 1.5em 0 1em 0; }
    .preview-title { font-weight: bold; color: #297f43; margin-bottom: 0.6em; }
    .preview-hash-container { display: flex; align-items: center; margin: 0.25em 0 0.9em 0; } /* Flex container for hash and copy button */
    .preview-hash { flex-grow: 1; font-size: 1.05em; word-break: break-all; background: #e0f2f7; border: 1px solid #cce5ed; border-radius: 5px; padding: 0.8em; } /* Adjusted styling */
    .copy-btn { padding: 0.6em 0.9em; margin-left: 0.8em; border-radius: 5px; border: none; background: #2196f3; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.13s; flex-shrink: 0; }
    .copy-btn:hover { background: #1976d2; }
    .audit-action-buttons { display: flex; gap: 1em; margin-top: 1em;}
    .audit-action-buttons button { flex: 1; padding: 0.8em 0.5em; border: none; border-radius: 8px; font-size: 1.09em; font-weight: bold; color: #fff; cursor: pointer; transition: background 0.13s;}
    .exit-btn { background: #dc3545; }
    .exit-btn:hover { filter: brightness(0.9); }
    .commit-btn { background: #28a745; }
    .commit-btn:hover { filter: brightness(0.9); }

    /* Bottom Navigation Buttons (added from previous version for consistency) */
    .navigation-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 2em;
    }
    .navigation-buttons button {
      padding: 0.8em 1.5em;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      background: #e0e0e0;
      color: #333;
      transition: background 0.13s;
    }
    .navigation-buttons button:hover {
      background: #d0d0d0;
    }

    @media (max-width: 600px) {
      body { margin: 0.5em; padding: 0.09em; }
      .section-block { padding: 0.7em 0.25em;}
      input[type="text"], input[type="number"], input[type="password"] { padding: 0.6em; }
      .main-button { font-size: 1.04em; padding: 0.8em 0.4em; }
      .quantity-options { flex-direction: row; justify-content: space-between; }
      .quantity-options button { flex-basis: calc(33% - 0.8em); padding: 0.6em 0.8em; font-size: 0.9em; } /* Adjusted for better mobile layout */
      .audit-action-buttons { flex-direction: column; gap: 0.5em; }
    }
  </style>
</head>
<body>
  <h1>Generate QR Hash (Double Hash Function)</h1>
  <div class="info-bar">
    Role: <span id="role-display">Normal</span> |
    Quota: <span id="quota-display">1000</span> |
    Status: <span id="status-display">Available</span>
  </div>

  <div id="mint-section">
    <div class="section-block">
      <label for="publicKeyInput">Public Key</label>
      <input type="text" id="publicKeyInput" value="000000004a8d87ffd4c6e7a29f1221b13e81">
      <div class="hint">Use the public key from the "Generate Key" page (64 hex).</div>
    </div>
    <div class="section-block">
      <label for="qrQuantityInput">Quantity (QTY)</label>
      <input type="number" id="qrQuantityInput" value="1" min="1"> <div class="quantity-options">
        <button onclick="selectQuantity(1)">1</button>
        <button onclick="selectQuantity(100)">100</button>
        <button onclick="selectQuantity(500)">500</button>
        <button onclick="selectQuantity(1000)">1000</button>
        <button onclick="selectQuantity(3000)">3000</button>
        <button onclick="selectQuantity(5000)">5000</button>
      </div>
      <div class="hint" id="quota-hint"></div>
    </div>
    <div class="section-block">
      <label for="secretInput">Secret (4 a-z, for minting only)</label>
      <input type="password" id="secretInput" placeholder="e.g. abcd" maxlength="4">
      <label for="confirmSecretInput">Confirm Secret</label>
      <input type="password" id="confirmSecretInput" placeholder="Re-enter secret" maxlength="4">
      <div class="hint">You must enter the same secret both times. Keep it safe for future regen.</div>
    </div>
    <button class="main-button" id="generateBtn" onclick="generatePreview()">Generate QR Batch</button>
  </div>

  <div class="preview-section" id="previewSection" style="display:none;">
    <div class="preview-title">Preview QR Batch (Double Hash)</div>
    <div><b>hash1:</b>
        <div class="preview-hash-container">
            <span class="preview-hash" id="hash1Preview"></span>
            <button class="copy-btn" onclick="copyHash('hash1Preview')">Copy</button>
        </div>
    </div>
    <div><b>hash2:</b>
        <div class="preview-hash-container">
            <span class="preview-hash" id="hash2Preview"></span>
            <button class="copy-btn" onclick="copyHash('hash2Preview')">Copy</button>
        </div>
    </div>
    <div class="audit-action-buttons">
      <button class="exit-btn" onclick="resetForm()">Exit</button>
      <button class="commit-btn" onclick="commitBatch()">Commit</button>
    </div>
  </div>

  <div class="navigation-buttons">
    <button onclick="window.history.back()">Back</button>
    <button onclick="window.location.href='index.html'">Home</button>
    <button onclick="handleNext()">Next</button>
  </div>

  <script>
    // CONFIG
    let userRole = 'Normal'; // 'Normal', 'Agent', 'Master'
    let userQuota = 1000;    // Current remaining quota
    let userFirstMint = true; // Set to true to simulate a new user who can only mint 1 QR initially

    // DOM Elements (re-selected for clarity)
    const roleDisplay = document.getElementById('role-display');
    const quotaDisplay = document.getElementById('quota-display');
    const statusDisplay = document.getElementById('status-display');
    const mintSection = document.getElementById('mint-section');
    const previewSection = document.getElementById('previewSection');
    const qrQuantityInput = document.getElementById('qrQuantityInput');
    const quantityButtons = document.querySelectorAll('.quantity-options button');
    const generateBtn = document.getElementById('generateBtn');
    const secretInput = document.getElementById('secretInput');
    const confirmSecretInput = document.getElementById('confirmSecretInput');
    const quotaHint = document.getElementById('quota-hint');
    const hash1Preview = document.getElementById('hash1Preview');
    const hash2Preview = document.getElementById('hash2Preview');

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', function() {
      updateQuotaDisplay();
      qrQuantityInput.addEventListener('input', validateQty); // Listen for input changes
      highlightSelectedQty(parseInt(qrQuantityInput.value)); // Highlight initial value
    });

    // --- Core Functions ---

    function updateQuotaDisplay() {
      roleDisplay.textContent = userRole;
      if (userRole === 'Master' || userRole === 'Agent') {
        quotaDisplay.textContent = 'Unlimited';
        statusDisplay.textContent = 'Available';
      } else {
        quotaDisplay.textContent = userQuota;
        statusDisplay.textContent = (userQuota > 0 ? 'Available' : 'Not Available');
      }
      applyMintingPermissions(); // Re-apply permissions based on updated quota/role
      updateQuotaHint(); // Update hint message
    }

    function applyMintingPermissions() {
      // Disable/Enable main inputs and button based on overall minting ability
      let canMint = true;
      if ((userRole === 'Normal' && userQuota <= 0) ||
          (userRole === 'Normal' && userFirstMint && userQuota === 0)) { // If first mint is done and no quota left
        canMint = false;
      }
      
      secretInput.disabled = !canMint;
      confirmSecretInput.disabled = !canMint;
      generateBtn.disabled = !canMint;

      // Handle specific role/first mint rules for quantity input and buttons
      if (userRole === 'Master' || userRole === 'Agent') {
        qrQuantityInput.disabled = false;
        qrQuantityInput.min = 1;
        qrQuantityInput.max = (userRole === 'Agent' ? 5000 : ''); // Agent example max, Master unlimited
        quantityButtons.forEach(btn => btn.disabled = false);
      } else { // Normal user
        if (userFirstMint) {
          qrQuantityInput.value = 1; // Force to 1
          qrQuantityInput.disabled = true; // Disable input field
          qrQuantityInput.min = 1;
          qrQuantityInput.max = 1; // Max is 1 for first mint
          quantityButtons.forEach(btn => btn.disabled = (parseInt(btn.textContent) !== 1)); // Only enable '1' button
          generateBtn.disabled = false; // Ensure generate button is enabled for first mint of 1
        } else {
          qrQuantityInput.disabled = false;
          qrQuantityInput.min = 1;
          qrQuantityInput.max = userQuota; // Max is current quota for subsequent normal mints
          quantityButtons.forEach(btn => btn.disabled = (parseInt(btn.textContent) > userQuota));
          // Re-validate current input value against new quota
          validateQty();
        }
      }
      // Ensure generate button is disabled if overall cannot mint (e.g. quota 0)
      if (!canMint) {
          generateBtn.disabled = true;
      }
    }

    function selectQuantity(qty) {
      if (userRole === 'Normal') {
        if (userFirstMint && qty !== 1) {
          alert('As a new user, you can only mint 1 QR Batch.');
          qrQuantityInput.value = 1; // Force value back to 1
          highlightSelectedQty(1);
          return;
        }
        if (!userFirstMint && qty > userQuota) {
          alert(`Selected QTY (${qty}) exceeds your available quota (${userQuota}).`);
          return;
        }
      }
      if (userRole === 'Agent' && qty > 5000) { // Example agent max
        alert(`Selected QTY (${qty}) exceeds Agent's maximum limit (5000).`);
        return;
      }

      qrQuantityInput.value = qty;
      highlightSelectedQty(qty);
      validateQty(); // Re-validate after selecting
    }

    function highlightSelectedQty(qty) {
      quantityButtons.forEach(btn => {
        if (parseInt(btn.textContent) === qty) btn.classList.add('selected');
        else btn.classList.remove('selected');
      });
    }

    function validateQty() {
      let qty = parseInt(qrQuantityInput.value);
      updateQuotaHint(); // Update hint based on current input and rules

      // Check if current quantity is valid for the role and quota
      let currentInputValid = true;
      if (isNaN(qty) || qty < 1) {
          currentInputValid = false;
      } else if (userRole === 'Normal') {
          if (userFirstMint && qty !== 1) {
              currentInputValid = false;
          } else if (!userFirstMint && qty > userQuota) {
              currentInputValid = false;
          }
      } else if (userRole === 'Agent' && qty > 5000) { // Example Agent max
          currentInputValid = false;
      }

      // If quantity is valid and other inputs are enabled, enable generate button
      // Otherwise, disable generate button
      generateBtn.disabled = !currentInputValid || secretInput.disabled; // Also check if secret input is disabled as an indicator of overall minting ability
    }

    function updateQuotaHint() {
      if (userRole === 'Normal') {
        if (userFirstMint) {
          quotaHint.textContent = "You can mint only 1 QR Batch as a new user.";
        } else if (userQuota > 0) {
          quotaHint.textContent = `Select from popular options or enter a custom quantity (Max: ${userQuota}).`;
        } else {
          quotaHint.textContent = "You have no quota remaining.";
        }
      } else if (userRole === 'Agent') {
        quotaHint.textContent = "Select from popular options or enter a custom quantity (Max: 5000 for Agent).";
      } else { // Master
        quotaHint.textContent = "Select from popular options or enter a custom quantity (Unlimited).";
      }

      // Add warning if current input exceeds allowed max
      let qty = parseInt(qrQuantityInput.value);
      if (userRole === 'Normal' && !userFirstMint && qty > userQuota) {
        quotaHint.textContent = `Selected QTY (${qty}) exceeds your available quota (${userQuota}). Please reduce quantity.`;
        generateBtn.disabled = true; // Ensure button is disabled if this state is reached
      } else if (userRole === 'Agent' && qty > 5000) {
         quotaHint.textContent = `Selected QTY (${qty}) exceeds Agent's maximum limit (5000). Please reduce quantity.`;
         generateBtn.disabled = true;
      } else if (userRole === 'Normal' && userFirstMint && qty !== 1) {
        quotaHint.textContent = "As a new user, you can only mint 1 QR Batch. Please set QTY to 1.";
        generateBtn.disabled = true;
      }
    }


    function isValidPubKey(key) {
      return /^[a-f0-9]{64}$/i.test(key.trim());
    }

    function generatePreview() {
      let pubkey = document.getElementById('publicKeyInput').value.trim();
      let qty = parseInt(qrQuantityInput.value);
      let secret = secretInput.value;
      let confirmSecret = confirmSecretInput.value;

      // Basic validation
      if (!isValidPubKey(pubkey)) {
        alert('Invalid public key format. It should be 64 hexadecimal characters.');
        return;
      }
      if (!/^[a-z]{4}$/.test(secret) || secret !== confirmSecret) {
        alert('Secret must be 4 lowercase a-z characters and match both fields.');
        return;
      }
      if (isNaN(qty) || qty < 1) {
        alert('Please enter a valid quantity.');
        return;
      }

      // Role-specific validation
      if (userRole === 'Normal') {
        if (userFirstMint && qty !== 1) {
          alert('As a new user, you can only mint 1 QR Batch.');
          return;
        }
        if (!userFirstMint && qty > userQuota) {
          alert(`Selected QTY (${qty}) exceeds your available quota (${userQuota}).`);
          return;
        }
      } else if (userRole === 'Agent' && qty > 5000) { // Example for Agent limit
        alert(`Selected QTY (${qty}) exceeds Agent's maximum limit (5000).`);
        return;
      }
      // Master is unlimited, no quantity check needed here.

      // Simulate Hash Generation
      let hash1 = sha256(pubkey + qty + secret + Math.random()); // Added random for demo
      let meta = (new Date().toISOString());
      let hash2 = sha256(hash1 + meta + Math.random()); // Added random for demo

      hash1Preview.textContent = hash1;
      hash2Preview.textContent = hash2;

      // Show preview section, hide mint section
      mintSection.style.display = 'none';
      previewSection.style.display = 'block';
    }

    function resetForm() {
      // Clear relevant fields and reset UI state
      document.getElementById('publicKeyInput').value = '000000004a8d87ffd4c6e7a29f1221b13e81'; // Reset to default
      qrQuantityInput.value = 1;
      secretInput.value = '';
      confirmSecretInput.value = '';
      hash1Preview.textContent = '';
      hash2Preview.textContent = '';

      // Show mint section, hide preview section
      previewSection.style.display = 'none';
      mintSection.style.display = 'block';

      // Re-initialize permissions and hint
      updateQuotaDisplay(); // This will call applyMintingPermissions and updateQuotaHint
      highlightSelectedQty(parseInt(qrQuantityInput.value)); // Highlight the default 1 QTY
    }

    function commitBatch() {
      alert('Committed QR Batch!\nhash1 and hash2 saved to ledger/log.');
      // Update quota and first mint status if Normal role
      if (userRole === 'Normal') {
        userFirstMint = false; // Mark that first mint is done
        userQuota -= parseInt(qrQuantityInput.value); // Deduct the quantity minted
        if (userQuota < 0) userQuota = 0; // Ensure quota doesn't go negative
      }
      updateQuotaDisplay(); // Update display and re-apply permissions
      resetForm(); // Reset form to mint section
    }

    function copyHash(elementId) {
      const element = document.getElementById(elementId);
      const textToCopy = element.textContent;
      navigator.clipboard.writeText(textToCopy)
        .then(() => { alert(`Copied "${textToCopy}" to clipboard!`); })
        .catch(err => { alert('Failed to copy. Please try again or copy manually.'); });
    }

    // A very simple pseudo-SHA256 for demo purposes. NOT for production.
    function sha256(str) {
        let hash = 0;
        if (str.length === 0) return "0".repeat(64);
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; // Convert to 32bit integer
        }
        // This is a very weak hash, just for visual representation
        return (hash >>> 0).toString(16).padStart(8, '0').repeat(8).substr(0, 64);
    }

    // Navigation functions (from previous version)
    function handleNext() {
      alert('Proceeding to next page!');
      // window.location.href = 'next_page.html';
    }
  </script>
</body>
</html>
