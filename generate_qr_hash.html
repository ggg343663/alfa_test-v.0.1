<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Generate QR Hash (Mint) - DTC: Magic Chain System</title>
    <style>
        /* Define custom CSS variables for colors based on design document */
        :root {
            --color-primary-green: #219150; /* Primary Green */
            --color-info-blue: #2196f3;    /* Info Blue */
            --color-audit-yellow: #ffd600; /* Audit Yellow */
            --color-doc-grey: #90a4ae;     /* Doc Grey */
            --color-body-bg: #f5f7fa;      /* Body BG */
            --color-menu-bg: #fff;         /* Menu BG */
            --color-text-main: #333;       /* Text Main */
            --color-label-grey: #90a4ae;   /* Label Grey (for descriptions and footer) */
            --color-sensitive-input-bg: #fffde7; /* Yellow background for sensitive inputs */
            --color-success-border: #43a047; /* Success border color */
            --color-error-border: #e53935; /* Error border color */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Changed to Segoe UI as per doc */
            max-width: 700px;
            margin: 2em auto;
            padding: 1em;
            background: var(--color-body-bg);
            color: var(--color-text-main);
        }
        h1 {
            text-align: center;
            color: var(--color-primary-green);
            margin-bottom: 1.2em;
            letter-spacing: 0.02em;
        }
        h1 small {
            display: block;
            font-size: 0.5em;
            color: #555;
            margin-top: 0.5em;
        }
        .intro-section {
            background-color: #e0f2f7;
            border-left: 5px solid #00acc1;
            padding: 1.2em;
            margin-bottom: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 7px rgba(0,0,0,0.05);
            color: #444;
            text-align: center;
            font-size: 0.96em;
        }
        .section-block {
            margin: 1.1em 0;
            padding: 1.5em;
            border-radius: 12px;
            box-shadow: 0 2px 9px #edf1f6;
        }
        .block-title {
            font-size: 1.08em;
            font-weight: bold;
            margin-bottom: 0.9em;
            color: #555;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 0.5em;
        }
        .qr-input-block { /* Now used for PIN and Secret */
            background: var(--color-sensitive-input-bg); /* Yellow background for sensitive inputs block */
            border-left: 6px solid var(--color-audit-yellow);
        }
        .qr-issuer-block { /* New block for Master/Agent QR Hash */
            background: var(--color-body-bg);
            border-left: 6px solid var(--color-info-blue);
        }
        .qr-meta-block { /* For Batch Information */
            background: var(--color-body-bg);
            border-left: 6px solid var(--color-doc-grey);
        }

        /* Buttons */
        .btn-main { /* Preview QR Batch button */
            width:100%; margin:18px 0 0 0; padding:1em 1.2em; color:#fff; background:linear-gradient(90deg,var(--color-info-blue) 70%,var(--color-primary-green) 100%); font-weight:bold; font-size:1.16em; border-radius:8px; border:none; cursor:pointer; box-shadow:0 2px 9px rgba(33,150,243,0.27); transition: background 0.2s;
        }
        .btn-main:active { background:#176d38; }
        .btn-main:hover:not([disabled]) { filter: brightness(0.95); }
        .btn-main[disabled] { opacity:.56; cursor:not-allowed; }

        .btn-confirm { /* Confirm & Mint button in modal */
            width:100%; margin-top:15px; background:linear-gradient(90deg,var(--color-primary-green) 75%,#44cc77 100%); color:#fff; font-weight:bold; font-size:1.12em; border:none; border-radius:8px; padding:1em 0; cursor:pointer; transition: background .13s, filter .13s;
        }
        .btn-confirm:hover { filter: brightness(0.96);}
        .btn-confirm:active { background:#176d38; }

        .btn-cancel { /* Cancel button in modal */
            width:100%; background:var(--color-body-bg); color:var(--color-info-blue); border:1.5px solid var(--color-info-blue); border-radius:8px; font-weight:bold; font-size:1em; padding:0.9em 0; margin-top:0.7em; cursor:pointer; transition: background .13s, color .13s;
        }
        .btn-cancel:hover { background:#e0f7fa; color:#176d38; }

        .input-group { margin-bottom: 15px; position:relative; }
        .input-group label { font-weight: bold; color: #666; font-size: 0.95em; margin-bottom: 5px; display:block;}
        .input-group input[type="password"], .input-group input[type="text"], .input-group textarea, .input-group select {
            width: calc(100% - 24px); padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; background-color: #ffffff; box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .input-group input[type="password"]:focus, .input-group input[type="text"]:focus, .input-group textarea:focus, .input-group select:focus {
            border-color: var(--color-info-blue);
            background-color: #f0f7ff;
        }
        /* Specific yellow background for sensitive inputs */
        .input-group input#pin,
        .input-group input#secretData {
            background-color: var(--color-sensitive-input-bg);
        }

        .label-hint { display:block; font-size:0.81em; color:var(--color-label-grey); margin-top:5px;}
        .toggle-password { position:absolute; right:12px; top:62%; transform:translateY(-50%); cursor:pointer; color:var(--color-label-grey); font-size:0.92em; }

        .qty-input-group { display:flex; align-items:center; gap:5px;}
        .qty-input-group input { text-align:center; width:70px; margin-bottom:0 !important;}
        .qty-button {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 5px; padding: 8px 12px; cursor: pointer; font-weight: bold; font-size: 1.1em; color: var(--color-info-blue); transition: background-color 0.1s;
        }
        .qty-button:hover { background-color: #bbdefb; }
        .qty-button:active { background-color: #90caf9; }

        .footer-note { text-align:center; margin-top:2.4em; color:#b0bec5; font-size:0.97em; }

        /* Public Key/Address Display Boxes */
        .key-address-display {
            background: #eafaf0; /* Light green background for public key/address display */
            border: 1px solid var(--color-primary-green);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            word-break: break-all;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #222;
        }
        .key-address-display label {
            font-weight: bold;
            color: #2d3c35;
            font-size: 0.95em;
            margin-bottom: 5px;
            display: block;
        }
        .key-address-value {
            user-select: all;
            overflow-x: auto;
            padding: 5px 0;
        }


        /* Preview Modal */
        #previewModal {
            display: none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(100,135,170,0.10); z-index:99; align-items:center; justify-content:center;
        }
        .preview-box {
            background: #f6fafd;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(33,150,243,0.53);
            max-width: 430px;
            margin: 0 auto;
            padding: 1.7em 1.2em;
            border: 1.5px solid var(--color-info-blue);
            color: #246bfd;
            font-size: 1.06em;
        }
        .preview-title { color: var(--color-primary-green); font-weight:bold; font-size:1.08em; margin-bottom:0.5em;}
        .preview-details { word-break:break-all; font-size:0.97em; background:#eafaf0; border-radius:7px; padding:1em 1em; margin:0.8em 0; color:#26733e;}
        .modal-action { margin-top:0.7em; }

        /* Result Section */
        .qr-output-block { background:#eafaf0; border-left:6px solid var(--color-primary-green); margin-top:2.3em; padding:1.5em 1.1em 1.7em 1.1em; border-radius:13px; box-shadow:0 2px 12px rgba(193,248,221,0.16); }
        .qr-output-content { display: flex; flex-direction: row; gap: 15px; flex-wrap: wrap;}
        .qr-preview-box { flex:1; min-width:150px; background:#fff; border:1px dashed #ccc; border-radius:8px; padding:12px; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center;}
        .qr-preview-box img { max-width:100%; height:auto; border:1px solid #eee;}
        .qr-hashes-box { flex:1; min-width:240px; display:flex; flex-direction:column; gap:10px;}
        .hash-display { background-color: #e3f2fd; border: 1px solid var(--color-info-blue); border-radius: 8px; padding: 10px; word-wrap:break-word; font-family: 'Courier New', Courier, monospace; font-size:0.92em; color:#333; }
        .hash-value { user-select:all; overflow-x:auto;}
        .export-buttons { display:flex; justify-content:space-around; gap:10px; margin-top:20px; flex-wrap:wrap; }
        .export-btn { flex:1; min-width:100px; padding:0.8em 1em; border-radius:8px; font-weight:bold; text-align:center; text-decoration:none; cursor:pointer; border:none; transition:background 0.13s, filter 0.13s; box-shadow:0 2px 7px rgba(0,0,0,0.07); font-size:0.95em; }

        .export-ticket-btn { background:var(--color-audit-yellow); color:#222;}
        .export-qr-btn { background:var(--color-info-blue); color:#fff;}
        .export-log-btn { background:#2563eb; color:#fff;} /* Slightly darker blue for log */

        .export-btn:hover { filter:brightness(0.93);}
        .timestamp-note { text-align:right; color:#607d8b; font-size:0.85em; margin-top:10px;}

        /* Navigation Bar */
        .navbar { display:flex; justify-content:space-around; padding:15px 0; background:#ede7f6; border-top:1px solid #ccc; margin-top:2.5em; border-radius:8px; box-shadow:0 -2px 7px rgba(0,0,0,0.05);}
        .nav-btn { flex:1; padding:0.8em 1em; border:none; border-radius:8px; background-color:#ede7f6; color:#512da8; font-weight:bold; font-size:1em; cursor:pointer; text-align:center; text-decoration:none; transition:background-color 0.2s, color 0.2s; margin:0 5px;}
        .nav-btn:hover { background-color:#d1c4e9; color:#333;}
        .nav-btn.active { background-color:#90a4ae; color:#fff;}

        /* Status Message */
        #statusMessage {
            text-align: center;
            margin-top: 1em;
            padding: 0.8em;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .status-success { background-color: #eafaf1; color: var(--color-primary-green); border: 1px solid var(--color-primary-green); }
        .status-error { background-color: #fef2f2; color: var(--color-error-border); border: 1px solid var(--color-error-border); }

        @media (max-width:600px){
            body {margin:0.4em; padding:0.07em;}
            .section-block, .qr-output-block { padding:0.8em 0.2em;}
            .qr-output-content { flex-direction:column;}
            .qr-hashes-box, .qr-preview-box { min-width:unset; width:100%;}
            .qty-input-group input { width:50px; padding:5px;}
            .qty-button { padding:6px 10px; font-size:1em;}
            .navbar { flex-direction:column;}
            .nav-btn { margin:5px 0;}
            .preview-box { padding:1.1em 0.5em;}
        }
    </style>
</head>
<body>
    <h1>DTC: Magic Chain System <br><small>Decentralized Trust Community</small></h1>
    <div class="intro-section">
        <p>หน้านี้ใช้สำหรับ **สร้าง (Mint)** QR Code ใหม่และสร้าง Hash เฉพาะ (Hash1 &amp; Hash2) ของ QR นั้นๆ โดย **Public Key** ของคุณจะทำหน้าที่เป็นตัวตนของผู้ออก QR</p>
        <p>แต่ละ Batch ของ QR Code จะถูกบันทึกเป็น Record ใหม่บน **Decentralized Traceability Chain**.</p>
    </div>

    <div class="section-block qr-issuer-block">
        <div class="block-title">1. ระบุผู้ออก QR (Master/Agent)</div>
        <!-- Master/Agent QR Hash input field -->
        <div class="input-group">
            <label for="masterAgentQrHash">Master/Agent QR Hash:</label>
            <input type="text" id="masterAgentQrHash" placeholder="กรอก QR Hash ของ Master หรือ Agent Node" />
            <span class="label-hint">QR Hash ที่ใช้ระบุตัวตน Master หรือ Agent Node ที่ออก QR นี้</span>
        </div>

        <!-- Display area for associated Public Key and Public Address -->
        <div class="key-address-display" id="associatedKeyAddressDisplay" style="display:none;">
            <label>Public Key (ผู้ออก):</label>
            <div class="key-address-value" id="associatedPublicKey"></div>
            <label style="margin-top: 0.5em;">Public Address (สำหรับ Lookup):</label>
            <div class="key-address-value" id="associatedPublicAddress"></div>
            <span class="label-hint">Public Key และ Public Address ที่เกี่ยวข้องกับ Master/Agent QR Hash ที่กรอก</span>
        </div>
    </div>

    <div class="section-block qr-meta-block">
        <div class="block-title">2. ข้อมูล Batch</div>
        <div class="input-group">
            <label for="batchName">ชื่อ Batch:</label>
            <input type="text" id="batchName" placeholder="เช่น 'PRODUCT_A' หรือ 'product:b'" />
            <span class="label-hint" id="batchNameHint">ชื่อสำหรับระบุ Batch ของ QR Code นี้ (Master: ตัวพิมพ์ใหญ่ทั้งหมด, ไม่เกิน 8 ตัวอักษร; Agent: ตัวพิมพ์เล็กทั้งหมด, ไม่เกิน 16 ตัวอักษร, ใช้ ':' แทนเว้นวรรค)</span>
        </div>
        <div class="input-group">
            <label for="quantity">จำนวน QR ที่จะสร้าง:</label>
            <select id="quantity" class="w-full" disabled>
                <option value="">เลือกจำนวน</option>
                <option value="100">100</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="3000">3000</option>
                <option value="5000">5000</option>
            </select>
            <span class="label-hint" id="quantityHint">จำนวน QR Code ที่เหมือนกันที่จะสร้าง (จำกัดตามสิทธิ์ของผู้ออก)</span>
        </div>
    </div>

    <div class="section-block qr-input-block">
        <div class="block-title">3. ยืนยันและข้อมูลลับ</div>
        <!-- PIN input for authenticating Master/Agent QR Hash -->
        <div class="input-group">
            <label for="pin">PIN (5 หลัก):</label>
            <input type="password" id="pin" maxlength="5" pattern="\d{5}" inputmode="numeric" placeholder="กรอก PIN 5 หลักของคุณ" />
            <span class="toggle-password" data-target="pin">แสดง</span>
            <span class="label-hint">PIN นี้จะใช้สำหรับยืนยันสิทธิ์การเป็นเจ้าของ Master/Agent QR Hash</span>
        </div>

        <!-- Secret Data input field -->
        <div class="input-group">
            <label for="secretData">Secret:</label>
            <input type="text" id="secretData" maxlength="5" placeholder="กรอก 5 ตัวอักษรพิมพ์เล็ก a-z (เช่น 'abcde')" />
            <span class="label-hint">ข้อมูลลับเฉพาะของ QR นี้ ต้องเป็น 5 ตัวอักษรพิมพ์เล็ก a-z เท่านั้น</span>
        </div>
    </div>
    
    <button class="btn-main" id="previewBtn" disabled>ดูตัวอย่าง QR Batch</button>

    <div id="statusMessage" class=""></div>
    <!-- Preview Modal -->
    <div id="previewModal">
        <div class="preview-box">
            <div class="preview-title">ดูตัวอย่าง QR Batch (ยืนยันก่อน Mint)</div>
            <div class="preview-details" id="previewDetails"></div>
            <div class="modal-action">
                <button class="btn-confirm" id="confirmBtn">ยืนยัน &amp; Mint</button>
                <button class="btn-cancel" id="cancelPreviewBtn">ยกเลิก</button>
            </div>
        </div>
    </div>
    <!-- Output Section -->
    <div class="qr-output-block" id="qrOutputSection" style="display:none;">
        <div class="block-title">ตัวอย่าง QR ที่สร้าง &amp; Hashes</div>
        <div class="qr-output-content">
            <div class="qr-preview-box">
                <label>ตัวอย่าง QR (QR แรก):</label>
                <img id="qrCodeImage" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="QR Code Preview" />
            </div>
            <div class="qr-hashes-box">
                <div class="hash-display">
                    <label>Hash1 (QR Content Hash):</label>
                    <div class="hash-value" id="hash1"></div>
                    <span class="label-hint">Hash ของ prev_hash, qr_id, Public Key, Secret, Timestamp, Nonce</span>
                </div>
                <div class="hash-display">
                    <label>Hash2 (Commitment Hash):</label>
                    <div class="hash-value" id="hash2"></div>
                    <span class="label-hint">Commitment Hash เฉพาะสำหรับ Batch QR นี้ (ใช้สำหรับเชื่อมโยง Chain)</span>
                </div>
            </div>
        </div>
        <p class="timestamp-note">สร้างเมื่อ: <span id="generatedTimestamp"></span></p>
        <div class="export-buttons">
            <button class="export-btn export-ticket-btn" id="exportTicketBtn">ส่งออก Ticket (JSON)</button>
            <button class="export-btn export-qr-btn" id="exportQrBtn">ส่งออก QR Batch (PNG/SVG)</button>
            <button class="export-btn export-log-btn" id="exportLogBtn">ส่งออก Log (รายละเอียด Batch)</button>
        </div>
        <!-- Added qrContentDisplay outside qr-preview-box for clarity and compliance with "results not prominent" -->
        <div class="hash-display" style="margin-top:1em;">
            <label>QR Content ที่สร้าง (JSON):</label>
            <pre id="qrContentDisplay" style="font-size:0.97em;color:#234;white-space:pre-wrap;"></pre>
        </div>
    </div>
    <div class="navbar">
        <a href="generate_key.html" class="nav-btn">ย้อนกลับ (Generate Key)</a>
        <a href="index.html" class="nav-btn">หน้าหลัก</a>
        <a href="audit_chain.html" class="nav-btn">ถัดไป (Audit Chain)</a>
    </div>
    <p class="footer-note">พัฒนาและติดตั้งบน GitHub Pages • ระบบ Mobile-Friendly 100%</p>
    <script>
        // UI/UX: Toggle Password/PIN visibility
        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.dataset.target;
                const targetInput = document.getElementById(targetId);
                if (targetInput.type === 'password') { targetInput.type = 'text'; toggle.textContent = 'ซ่อน'; }
                else { targetInput.type = 'password'; toggle.textContent = 'แสดง'; }
            });
        });

        // SHA256 Helper function
        async function sha256Hex(str) {
            const buf = new TextEncoder().encode(str);
            const hashBuf = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        /**
         * MOCK FUNCTION FOR DEMO PURPOSES ONLY.
         * Simulates deriving a Public Key from a PIN.
         * @param {string} pin - The user's PIN.
         * @returns {Promise<string>} A promise that resolves to the hexadecimal representation of the mock Public Key.
         */
        async function derivePublicKeyFromPin(pin) {
            const seed = "DTC_MOCK_KEY_SEED_";
            const passphrase = seed + pin;
            return sha256Hex(passphrase);
        }

        /**
         * Derives a Public Address from a Public Key (raw hash).
         * As per the White Paper, this is SHA256(pubkey) and takes the first 40 hex characters (20 bytes).
         * @param {string} pubkey - The raw public key (hex string).
         * @returns {Promise<string>} A promise that resolves to the hexadecimal representation of the public address.
         */
        async function publicAddressFromPublicKey(pubkey) {
            let enc = new TextEncoder().encode(pubkey);
            let hash = await crypto.subtle.digest("SHA-256", enc);
            return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,40);
        }

        /**
         * MOCK FUNCTION FOR DEMO PURPOSES ONLY.
         * Simulates looking up QR Hash status and associated rights (Master/Agent/Request).
         * In a real system, this would query a backend or local log.
         * @param {string} qrHash - The Master/Agent QR Hash to look up.
         * @param {string} pin - The PIN to authenticate ownership of the QR Hash.
         * @returns {Promise<object|null>} Object with { type: 'master'|'agent'|'request'|'unactivated', publicKey: '...', publicAddress: '...' } or null if not found/invalid.
         */
        async function lookupQrHashStatusAndRights(qrHash, pin) {
            // Simulate a delay for lookup
            await new Promise(resolve => setTimeout(resolve, 300));

            const mockData = {
                // Mock Master QR Hash
                "MASTER_HASH_ABCDEF1234567890": {
                    type: "master",
                    publicKey: await derivePublicKeyFromPin("12345"), // Mock PK for master
                    publicAddress: await publicAddressFromPublicKey(await derivePublicKeyFromPin("12345")),
                    validPin: "12345"
                },
                // Mock Agent QR Hash
                "AGENT_HASH_FEDCBA0987654321": {
                    type: "agent",
                    publicKey: await derivePublicKeyFromPin("54321"), // Mock PK for agent
                    publicAddress: await publicAddressFromPublicKey(await derivePublicKeyFromPin("54321")),
                    validPin: "54321"
                },
                // Mock Request QR Hash (not active yet)
                "REQUEST_HASH_XYZABC12345678": {
                    type: "request",
                    publicKey: await derivePublicKeyFromPin("00000"), // Mock PK for request
                    publicAddress: await publicAddressFromPublicKey(await derivePublicKeyFromPin("00000")),
                    validPin: "00000"
                }
            };

            const foundEntry = mockData[qrHash];

            if (foundEntry && foundEntry.validPin === pin) {
                return foundEntry;
            } else if (foundEntry && foundEntry.validPin !== pin) {
                showStatus('PIN ไม่ถูกต้องสำหรับ QR Hash นี้', 'error');
                return null;
            } else {
                showStatus('ไม่พบ Master/Agent QR Hash หรือไม่ถูกต้อง', 'error');
                return null;
            }
        }


        // --- Validation Functions ---
        // Function to validate PIN format (exactly 5 digits)
        function validPin(pin) {
            return /^\d{5}$/.test(pin);
        }

        // Function to validate Secret Data (5 lowercase a-z characters)
        function validSecret(secret) {
            return /^[a-z]{5}$/.test(secret);
        }

        // Main validation function for all inputs
        function validateAllInputs() {
            const masterAgentQrHashInput = document.getElementById('masterAgentQrHash');
            const pinInput = document.getElementById('pin');
            const secretDataInput = document.getElementById('secretData');
            const batchNameInput = document.getElementById('batchName');
            const quantitySelect = document.getElementById('quantity');

            let isValid = true;
            let errorMessage = '';

            // Validate Master/Agent QR Hash
            if (!masterAgentQrHashInput.value.trim()) {
                errorMessage += 'ต้องระบุ Master/Agent QR Hash ';
                isValid = false;
            }

            // Validate PIN
            if (!validPin(pinInput.value.trim())) {
                errorMessage += 'PIN ต้องเป็นตัวเลข 5 หลัก ';
                isValid = false;
            }

            // Validate Secret Data
            if (!validSecret(secretDataInput.value.trim())) {
                errorMessage += 'Secret ต้องเป็น 5 ตัวอักษรพิมพ์เล็ก a-z เท่านั้น ';
                isValid = false;
            }

            // Validate Batch Name based on issuer type
            const currentIssuerType = window.currentIssuer?.type; // Get issuer type from global state
            const batchName = batchNameInput.value.trim();

            if (!batchName) {
                errorMessage += 'ต้องระบุชื่อ Batch ';
                isValid = false;
            } else if (currentIssuerType === 'master') {
                if (!/^[A-Z]{1,8}$/.test(batchName)) { // ALL CAPS, max 8 chars
                    errorMessage += 'ชื่อ Batch สำหรับ Master ต้องเป็นตัวพิมพ์ใหญ่ทั้งหมด ไม่เกิน 8 ตัวอักษร ';
                    isValid = false;
                }
            } else if (currentIssuerType === 'agent') {
                if (!/^[a-z0-9:]+$/.test(batchName) || batchName.length > 16) { // lowercase, numbers, colon, max 16 chars
                    errorMessage += 'ชื่อ Batch สำหรับ Agent ต้องเป็นตัวพิมพ์เล็กทั้งหมด (อนุญาตตัวเลขและเครื่องหมาย \':\') ไม่เกิน 16 ตัวอักษร ';
                    isValid = false;
                }
            }


            // Validate Quantity selection
            if (!quantitySelect.value) { // Check if an option is selected
                errorMessage += 'ต้องเลือกจำนวน QR ';
                isValid = false;
            } else {
                const qty = parseInt(quantitySelect.value);
                if (isNaN(qty) || qty < 1) { // Basic check, options are pre-defined
                    errorMessage += 'จำนวน QR ไม่ถูกต้อง ';
                    isValid = false;
                }
            }

            // Check if issuer is active and valid for minting
            if (!window.currentIssuer || (window.currentIssuer.type !== 'master' && window.currentIssuer.type !== 'agent')) {
                 errorMessage += 'Master/Agent QR Hash ไม่ถูกต้องหรือไม่ได้รับสิทธิ์ในการ Mint QR ';
                 isValid = false;
            }


            if (!isValid) {
                showStatus(errorMessage, 'error');
            } else {
                // Clear status if valid
                document.getElementById('statusMessage').style.display = 'none';
            }
            return isValid;
        }

        // --- Event Listeners and Logic ---
        // Function to show status messages (success/error)
        function showStatus(message, type) {
            const statusMessageDiv = document.getElementById('statusMessage');
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = 'status-message ' + (type === 'success' ? 'status-success' : 'status-error');
            statusMessageDiv.style.display = 'block';
            statusMessageDiv.style.opacity = '1';
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusMessageDiv.style.opacity = '0';
                setTimeout(() => { statusMessageDiv.style.display = 'none'; }, 300); // Hide after fade
            }, 5000);
        }

        // Global variable to store the final generated QR content for export
        let generatedQrContentData = null;
        window.currentIssuer = null; // Global variable to store current issuer's info (type, public key, public address)

        // Function to update associated Public Key/Address display and button/quantity state
        async function updateUIBasedOnQrHashAndPin() {
            const masterAgentQrHashInput = document.getElementById('masterAgentQrHash');
            const pinInput = document.getElementById('pin');
            const associatedKeyAddressDisplay = document.getElementById('associatedKeyAddressDisplay');
            const associatedPublicKeySpan = document.getElementById('associatedPublicKey');
            const associatedPublicAddressSpan = document.getElementById('associatedPublicAddress');
            const quantitySelect = document.getElementById('quantity');
            const previewBtn = document.getElementById('previewBtn');
            const batchNameHint = document.getElementById('batchNameHint');
            const quantityHint = document.getElementById('quantityHint');

            // Reset UI elements
            associatedKeyAddressDisplay.style.display = 'none';
            quantitySelect.disabled = true;
            quantitySelect.value = ""; // Reset selected quantity
            previewBtn.disabled = true;
            batchNameHint.textContent = 'ชื่อสำหรับระบุ Batch ของ QR Code นี้ (Master: ตัวพิมพ์ใหญ่ทั้งหมด, ไม่เกิน 8 ตัวอักษร; Agent: ตัวพิมพ์เล็กทั้งหมด, ไม่เกิน 16 ตัวอักษร, ใช้ \':\' แทนเว้นวรรค)';
            quantityHint.textContent = 'จำนวน QR Code ที่เหมือนกันที่จะสร้าง (จำกัดตามสิทธิ์ของผู้ออก)';
            window.currentIssuer = null; // Clear current issuer info

            const qrHash = masterAgentQrHashInput.value.trim();
            const pin = pinInput.value.trim();

            if (qrHash && validPin(pin)) {
                const issuerInfo = await lookupQrHashStatusAndRights(qrHash, pin);
                if (issuerInfo) {
                    window.currentIssuer = issuerInfo; // Store issuer info globally
                    associatedPublicKeySpan.textContent = issuerInfo.publicKey;
                    associatedPublicAddressSpan.textContent = issuerInfo.publicAddress;
                    associatedKeyAddressDisplay.style.display = 'block';

                    if (issuerInfo.type === 'master' || issuerInfo.type === 'agent') {
                        quantitySelect.disabled = false; // Enable quantity selection
                        showStatus(`สิทธิ์: ${issuerInfo.type === 'master' ? 'Master' : 'Agent'} Node`, 'success');
                        batchNameHint.textContent = `ชื่อ Batch สำหรับ ${issuerInfo.type === 'master' ? 'Master' : 'Agent'} Node: ${issuerInfo.type === 'master' ? 'ตัวพิมพ์ใหญ่ทั้งหมด ไม่เกิน 8 ตัวอักษร' : 'ตัวพิมพ์เล็กทั้งหมด ไม่เกิน 16 ตัวอักษร (ใช้ \':\' แทนเว้นวรรค)'}`;
                        quantityHint.textContent = `จำนวน QR Code ที่เหมือนกันที่จะสร้าง (Master/Agent Node สามารถ Mint ได้)`;
                    } else {
                        showStatus(`สิทธิ์: ${issuerInfo.type === 'request' ? 'คำขอ QR/Node (ยังไม่ Active)' : 'ไม่ได้รับสิทธิ์ในการ Mint QR'}`, 'error');
                        quantitySelect.disabled = true;
                        quantitySelect.value = "";
                        batchNameHint.textContent = 'ชื่อ Batch: ไม่สามารถ Mint QR ได้ด้วยสิทธิ์นี้';
                        quantityHint.textContent = 'จำนวน QR Code ที่เหมือนกันที่จะสร้าง (ไม่สามารถ Mint QR ได้ด้วยสิทธิ์นี้)';
                    }
                }
            }
            // Re-evaluate preview button state based on all inputs and currentIssuer status
            previewBtn.disabled = !validateAllInputs();
        }

        // Add input event listeners to relevant fields
        ['masterAgentQrHash', 'pin', 'secretData', 'batchName', 'quantity'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateUIBasedOnQrHashAndPin);
                element.addEventListener('change', updateUIBasedOnQrHashAndPin); // For select element
            }
        });

        // Initial call to set UI state on page load
        document.addEventListener('DOMContentLoaded', updateUIBasedOnQrHashAndPin);


        // Preview Modal logic
        const previewModal = document.getElementById('previewModal');
        document.getElementById('previewBtn').onclick = async () => {
            if (!validateAllInputs()) { return; } // Re-validate before showing preview

            const d = {
                masterAgentQrHash: document.getElementById('masterAgentQrHash').value.trim(),
                pin: document.getElementById('pin').value.trim(),
                secretData: document.getElementById('secretData').value.trim(),
                batchName: document.getElementById('batchName').value.trim(),
                quantity: parseInt(document.getElementById('quantity').value)
            };

            // Compose preview HTML
            document.getElementById('previewDetails').innerHTML = `
                <b>Master/Agent QR Hash:</b><br><span style="color:#246bfd;">${d.masterAgentQrHash}</span><br>
                <b>Public Key (ผู้ออก):</b><br><span style="color:#246bfd;">${window.currentIssuer.publicKey}</span><br>
                <b>Public Address (สำหรับ Lookup):</b><br><span style="color:#246bfd;">${window.currentIssuer.publicAddress}</span><br>
                <b>ชื่อ Batch:</b> ${d.batchName}<br>
                <b>จำนวน:</b> ${d.quantity}<br>
                <b>Secret:</b> <span style="color:#26733e;">${d.secretData}</span><br>
                <b>PIN:</b> <span style="color:#90a4ae;">•••••</span>
            `;
            previewModal.style.display = 'flex';
        };
        document.getElementById('cancelPreviewBtn').onclick = ()=>{ previewModal.style.display='none'; };

        // Confirm & Mint
        document.getElementById('confirmBtn').onclick = async ()=>{
            // Re-validate before minting
            if (!validateAllInputs()) {
                previewModal.style.display = 'none'; // Hide modal if validation fails
                return;
            }

            const d = {
                masterAgentQrHash: document.getElementById('masterAgentQrHash').value.trim(),
                pin: document.getElementById('pin').value.trim(),
                secretData: document.getElementById('secretData').value.trim(),
                batchName: document.getElementById('batchName').value.trim(),
                quantity: parseInt(document.getElementById('quantity').value)
            };

            previewModal.style.display = 'none';
            showStatus('กำลังประมวลผลและ Mint QR Batch...', 'success');

            // --- DTC Core Logic: Hash Calculation (Aligned with White Paper) ---
            const now = new Date();
            const timestamp = now.toISOString(); // Timestamp for transaction
            const prevHash = "0000000000000000000000000000000000000000000000000000000000000000"; // Placeholder for previous block hash (Genesis for first QR)

            // For QR generation, qr_id is deterministic and unique per QR.
            // For this demo, we generate a random one for the first QR in the batch.
            const qr_id_demo = `DTC_QR_${Math.random().toString(36).substring(2,8).toUpperCase()}-${now.getTime()}`;
            const nonce = Math.random().toString(36).substring(2,10); // Random nonce

            // Hash1: SHA256(prev_hash + "qr" + qr_id + public_key + qr_secret + timestamp + nonce)
            // public_key here is the associatedPublicKey from the Master/Agent QR Hash
            const hash1_input_string = prevHash + "qr" + qr_id_demo + window.currentIssuer.publicKey + d.secretData + timestamp + nonce;
            const hash1 = await sha256Hex(hash1_input_string);

            // For Hash2 (Commitment Hash), we need a commitment_id and timestamp_transaction_committed.
            // In a real system, commitment_id would be unique for the batch commitment.
            // For this demo, we'll use a simple random ID and the same timestamp.
            const commitment_id = `COMMIT_${Math.random().toString(36).substring(2,10).toUpperCase()}`;
            const timestamp_transaction_committed = timestamp; // Reusing for simplicity in demo

            // Hash2: SHA256(hash1 + commitment_id + timestamp_transaction_committed)
            const hash2_input_string = hash1 + commitment_id + timestamp_transaction_committed;
            const hash2 = await sha256Hex(hash2_input_string);
            // --- End DTC Core Logic ---

            // QR Content structure (Ticket) - Public Key is primary, Public Address is meta
            const qrContentJson = {
                version: "DTC_0.7.6.1",
                type: "QR_Batch_Mint",
                // issuerPublicKey is the Public Key of the entity minting the QR
                issuerPublicKey: window.currentIssuer.publicKey,
                data: d.secretData, // The core secret data for the QR
                meta: {
                    batchName: d.batchName,
                    quantity: d.quantity,
                    timestamp: timestamp, // Timestamp of this QR generation
                    qr_id: qr_id_demo, // Unique ID for this specific QR (first in batch for demo)
                    nonce: nonce,
                    prev_hash: prevHash, // Previous hash in the chain
                    // issuerPublicAddress is a derived, human-readable form of the Public Key
                    issuerPublicAddress: window.currentIssuer.publicAddress,
                    issuerType: window.currentIssuer.type, // Master or Agent
                    system_meta: {
                        appVersion: "1.0.0 (Web UI)",
                        deviceName: "User Browser",
                        os: "N/A", // Operating System
                        location: "Thailand", // Mock location
                        generatedTime: new Date().toISOString() // Exact generation time
                    }
                },
                hash1: hash1, // Hash of the QR's core data and metadata
                hash2: hash2, // Commitment Hash for the batch
                signature: "0xMOCKSIGNATURE" // Placeholder for actual digital signature (derived from Private Key)
            };

            // Store the generated data for export
            generatedQrContentData = qrContentJson;

            // Show results
            document.getElementById('qrOutputSection').style.display = 'flex';
            // QR Code API: data parameter should be the JSON string of the QR content
            document.getElementById('qrCodeImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(JSON.stringify(qrContentJson))}`;
            document.getElementById('qrContentDisplay').textContent = JSON.stringify(qrContentJson, null, 2);
            document.getElementById('hash1').textContent = hash1;
            document.getElementById('hash2').textContent = hash2;
            document.getElementById('generatedTimestamp').textContent = new Date(timestamp).toLocaleString('th-TH'); // Localized timestamp
            showStatus('Mint QR Batch สำเร็จ!', 'success');
        };

        // Export buttons
        document.getElementById('exportTicketBtn').onclick = ()=>{
            const txt = document.getElementById('qrContentDisplay').textContent;
            if (!txt) { showStatus('ไม่มีเนื้อหา Ticket ให้ส่งออก', 'error'); return; }
            const filename = `DTC_Ticket_${Date.now()}.json`;
            const blob = new Blob([txt], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            showStatus('ส่งออก Ticket สำเร็จ!', 'success');
        };

        document.getElementById('exportQrBtn').onclick = ()=>{
            const imgUrl = document.getElementById('qrCodeImage').src;
            if (!imgUrl || imgUrl.includes('data:image/gif')) { showStatus('ไม่มีรูปภาพ QR ให้ส่งออก', 'error'); return; }
            const a = document.createElement('a'); a.href = imgUrl; a.download = `DTC_QR_Batch_${Date.now()}.png`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showStatus('ส่งออกรูปภาพ QR Batch สำเร็จ!', 'success');
        };

        // Modified: Export Log Button
        document.getElementById('exportLogBtn').onclick = ()=>{
            if (!generatedQrContentData) {
                showStatus('ยังไม่มีข้อมูล QR ที่สร้าง กรุณาคลิก "ยืนยัน & Mint" ก่อน', 'error');
                return;
            }

            // Prepare the log data from the generatedQrContentData (which already includes everything)
            const logData = {
                version: generatedQrContentData.version,
                type: generatedQrContentData.type,
                issuerPublicKey: generatedQrContentData.issuerPublicKey,
                data: generatedQrContentData.data,
                meta: generatedQrContentData.meta,
                hash1: generatedQrContentData.hash1,
                hash2: generatedQrContentData.hash2,
                signature: generatedQrContentData.signature
            };

            const filename = `DTC_Mint_Log_${Date.now()}.json`;
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            showStatus('ส่งออก Mint Log สำเร็จ!', 'success');
        };
    </script>
</body>
</html>
