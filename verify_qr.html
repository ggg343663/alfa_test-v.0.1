<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Check QR - DTC System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* ...‡∏Ñ‡∏á style ‡πÄ‡∏î‡∏¥‡∏°... */
    /* (‡∏¢‡∏Å‡∏°‡∏≤‡πÅ‡∏Ñ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) */
    input[type="text"]:focus { border-color: #2563eb; box-shadow:0 2px 6px #bfdbfe44;}
    .copy-btn {
      background: none; border: none; color: #2196F3; font-weight: bold;
      cursor: pointer; font-size: 1em; margin-left: 0.18em;
    }
    .copy-success { color: #16a34a; font-size: 0.93em; margin-left: 0.2em;}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
    <h2>Check QR Code</h2>
    <label for="qrhash">QR Hash (64 chars):</label>
    <div class="input-row">
      <input type="text" id="qrhash" maxlength="64" placeholder="Enter QR hash" autocomplete="off" autofocus />
      <button class="scan-btn" onclick="toggleCameraScan()" type="button">üì∑</button>
      <input type="file" id="imgInput" accept="image/*" onchange="importQR(this)" />
      <button class="import-btn" onclick="document.getElementById('imgInput').click()" type="button">üñºÔ∏è</button>
      <button class="copy-btn" onclick="copyField('qrhash')" title="Copy QR">Copy</button>
      <span id="copyQRSuccess" class="copy-success"></span>
    </div>
    <div id="scanMsg" class="scan-box"></div>
    <div id="qr-reader"></div>

    <button onclick="checkQR()" id="checkBtn" type="button">Check</button>
    <div id="resultArea"></div>
  </div>

<script>
  // DEMO DATA
  const whitelist = [
    "A9F1BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB1CDE",
    "B8A2CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC3BAF",
    "C4EEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1AF0",
    "A013FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF11AA",
    "0A4D1234567890ABCDEF1234567890ABCDEF1234567890ABCDEF1234567890F1B2"
  ];
  const registered = [
    { hash: "A9F1BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB1CDE", owner: "0x0fAba11A11111111111111111111111111111123", timestamp: "2024-06-01T12:01:00Z" },
    { hash: "C4EEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1AF0", owner: "0xB4A998877665544332211000AABBCCDDEEFF999", timestamp: "2024-06-01T13:22:00Z" }
  ];

  // Autofocus
  window.onload = ()=>{ document.getElementById('qrhash').focus(); };

  // Enter = check, Esc = clear
  document.getElementById('qrhash').addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      e.preventDefault();
      checkQR();
    }
    if(e.key === 'Escape'){
      clearQR();
    }
  });

  // Copy field
  function copyField(id) {
    const input = document.getElementById(id);
    input.select(); input.setSelectionRange(0, 9999);
    navigator.clipboard.writeText(input.value);
    const el = document.getElementById('copyQRSuccess');
    el.textContent = "Copied!";
    setTimeout(()=>{el.textContent="";}, 1100);
  }

  // Camera QR Scan
  let qrScanner = null;
  function toggleCameraScan() {
    const qrReader = document.getElementById('qr-reader');
    const scanBtn = document.querySelector('.scan-btn');
    if (qrReader.style.display === "block") {
      qrScanner && qrScanner.stop().then(()=>{});
      qrReader.style.display = "none";
      scanBtn.textContent = "üì∑";
      document.getElementById('scanMsg').textContent = "";
    } else {
      qrReader.style.display = "block";
      scanBtn.textContent = "‚úñÔ∏è";
      document.getElementById('scanMsg').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
      qrScanner = new Html5Qrcode("qr-reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 220 },
        decodedText => {
          document.getElementById('qrhash').value = decodedText;
          document.getElementById('scanMsg').innerHTML = "‚úîÔ∏è QR hash scanned from camera!";
          qrScanner.stop();
          qrReader.style.display = "none";
          scanBtn.textContent = "üì∑";
        },
        err => { /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á error ‡∏ó‡∏∏‡∏Å frame */ }
      ).catch(err=>{
        document.getElementById('scanMsg').innerHTML = "<span style='color:#e03e3e'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</span>";
        scanBtn.textContent = "üì∑";
        qrReader.style.display = "none";
      });
    }
  }

  // Import QR from image file
  function importQR(input) {
    const file = input.files[0];
    const scanMsg = document.getElementById('scanMsg');
    scanMsg.textContent = "";
    if (!file) return;
    Html5Qrcode.scanFile(file, true)
      .then(decodedText => {
        document.getElementById('qrhash').value = decodedText;
        scanMsg.innerHTML = "‚úîÔ∏è QR hash scanned from image!";
      })
      .catch(() => {
        scanMsg.innerHTML = "<span style='color:#b80000'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö QR ‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ</span>";
      });
  }

  function checkQR() {
    const hash = document.getElementById('qrhash').value.trim();
    const result = document.getElementById('resultArea');
    result.innerHTML = "";
    if (hash.length !== 64) {
      result.innerHTML = `<div class="error-box">Invalid QR hash. Please enter 64 characters.</div>`;
      return;
    }
    if (!whitelist.includes(hash)) {
      result.innerHTML = `<div class="error-box">‚ùå This QR is not in whitelist.<br>Registration not allowed.</div>`;
      return;
    }
    const reg = registered.find(q => q.hash === hash);
    if (reg) {
      result.innerHTML = `<div class="result-box" style="color:#0ea5e9;">
        ‚úÖ Registered!<br>
        Owner: <b id="ownerText">${reg.owner}</b>
        <button class="copy-btn" onclick="copyText('ownerText')">Copy</button><br>
        Timestamp: ${reg.timestamp}
        </div>`;
    } else {
      result.innerHTML = `<div class="result-box" style="color:#188b16;">üü© Not registered yet.<br>This QR can be registered.</div>`;
    }
  }

  function copyText(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const sel = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(el);
    sel.removeAllRanges();
    sel.addRange(range);
    try { document.execCommand('copy'); } catch {}
    sel.removeAllRanges();
  }

  function clearQR() {
    document.getElementById("qrhash").value = "";
    document.getElementById("resultArea").innerHTML = "";
    document.getElementById("scanMsg").innerHTML = "";
    document.getElementById("qrhash").focus();
  }
</script>
</body>
</html>
